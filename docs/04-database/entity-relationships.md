# ğŸ”— Entity Relationships

## Detail Relasi Antar Entity LeadX CRM

---

## ğŸ“‹ Overview

Dokumen ini menjelaskan secara detail hubungan antar entity dalam LeadX CRM, termasuk cardinality, business rules, dan contoh use case.

---

## ğŸ‘¥ User Hierarchy (Flexible Structure)

### Konsep

Struktur hierarki user bersifat **fleksibel** untuk mengakomodasi berbagai tipe cabang:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      FLEXIBLE USER HIERARCHY                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  SUPERADMIN â†’ ADMIN â†’ ROH â†’ BM â†’ [BH] â†’ RM                                  â”‚
â”‚                                    â†‘                                         â”‚
â”‚                                    â”‚                                         â”‚
â”‚                              OPTIONAL                                        â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ TIPE CABANG                                                           â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  Type A (Besar):     BM â†’ BH â†’ RM                                    â”‚   â”‚
â”‚  â”‚                       â”‚    â”‚                                          â”‚   â”‚
â”‚  â”‚                       â”‚    â”œâ”€â”€ RM 1                                   â”‚   â”‚
â”‚  â”‚                       â”‚    â”œâ”€â”€ RM 2                                   â”‚   â”‚
â”‚  â”‚                       â”‚    â””â”€â”€ RM n                                   â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  Type B (Hybrid):    BM â†’ BH (beberapa)                              â”‚   â”‚
â”‚  â”‚                       â”‚ â†’ RM (langsung)                               â”‚   â”‚
â”‚  â”‚                       â”‚                                               â”‚   â”‚
â”‚  â”‚                       â”œâ”€â”€ BH â†’ RM 1, RM 2                            â”‚   â”‚
â”‚  â”‚                       â””â”€â”€ RM 3 (direct report)                       â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  Type C (Kecil):     BM â†’ RM (langsung)                              â”‚   â”‚
â”‚  â”‚                       â”‚                                               â”‚   â”‚
â”‚  â”‚                       â”œâ”€â”€ RM 1                                        â”‚   â”‚
â”‚  â”‚                       â”œâ”€â”€ RM 2                                        â”‚   â”‚
â”‚  â”‚                       â””â”€â”€ RM n                                        â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Database Implementation

```sql
-- users table
CREATE TABLE users (
  id UUID PRIMARY KEY,
  role VARCHAR(20) NOT NULL,  -- SUPERADMIN/ADMIN/ROH/BM/BH/RM
  parent_id UUID REFERENCES users(id),  -- Direct supervisor (NULLABLE)
  branch_id UUID REFERENCES branches(id),
  -- ...
);

-- Contoh data:
-- Cabang BESAR (Type A)
INSERT INTO users (id, name, role, parent_id) VALUES
  ('bm-1', 'Budi (BM)', 'BM', 'roh-1'),
  ('bh-1', 'Ani (BH)', 'BH', 'bm-1'),     -- BH lapor ke BM
  ('rm-1', 'Dodi (RM)', 'RM', 'bh-1');    -- RM lapor ke BH

-- Cabang KECIL (Type C) - tanpa BH
INSERT INTO users (id, name, role, parent_id) VALUES
  ('bm-2', 'Siti (BM)', 'BM', 'roh-1'),
  ('rm-2', 'Eko (RM)', 'RM', 'bm-2');     -- RM langsung lapor ke BM
```

### Business Rules

| Rule | Description |
|------|-------------|
| RM harus punya parent | `parent_id` NOT NULL untuk RM |
| Parent harus di level atas | RM â†’ BH/BM, BH â†’ BM, BM â†’ ROH |
| Cabang tanpa BH valid | RM bisa langsung ke BM |

---

## ğŸ¢ HVC â†” Customer Relationship

### Konsep

**HVC (High Value Customer)** adalah pengelompokan strategis customer. Satu HVC bisa memiliki banyak customer, tapi **tidak semua customer harus terhubung ke HVC**.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      HVC - CUSTOMER RELATIONSHIP                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                           HVC                                        â”‚    â”‚
â”‚  â”‚  (Kawasan Industri, Bank, BUMN Group, dll)                          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                               â”‚                                              â”‚
â”‚                               â”‚ 1 : N (One HVC â†’ Many Customers)            â”‚
â”‚                               â”‚                                              â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚          â”‚                    â”‚                    â”‚                        â”‚
â”‚          â–¼                    â–¼                    â–¼                        â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚    â”‚ Customer  â”‚        â”‚ Customer  â”‚        â”‚ Customer  â”‚                 â”‚
â”‚    â”‚ A (HVC)   â”‚        â”‚ B (HVC)   â”‚        â”‚ C (HVC)   â”‚                 â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                                              â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚    â”‚ Customer  â”‚        â”‚ Customer  â”‚    â† Customer TANPA HVC              â”‚
â”‚    â”‚ D         â”‚        â”‚ E         â”‚      (standalone customers)           â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Database Implementation

```sql
-- HVC table
CREATE TABLE hvc (
  id UUID PRIMARY KEY,
  code VARCHAR(20) UNIQUE NOT NULL,
  name VARCHAR(200) NOT NULL,
  type_id UUID REFERENCES hvc_types(id),
  -- ...
);

-- Customer HVC Links (Many-to-Many, OPTIONAL)
CREATE TABLE customer_hvc_links (
  id UUID PRIMARY KEY,
  customer_id UUID REFERENCES customers(id) NOT NULL,
  hvc_id UUID REFERENCES hvc(id) NOT NULL,
  relationship_type VARCHAR(50) NOT NULL,  -- TENANT, SUBSIDIARY, MEMBER, etc.
  is_active BOOLEAN DEFAULT TRUE,
  
  UNIQUE(customer_id, hvc_id)  -- 1 customer hanya 1 link ke 1 HVC
);

-- Contoh data:
-- HVC: Kawasan Industri MM2100
INSERT INTO hvc (id, code, name) VALUES 
  ('hvc-1', 'HVC-MM2100', 'Kawasan Industri MM2100');

-- Customer yang ADA di HVC
INSERT INTO customers (id, name) VALUES 
  ('cust-1', 'PT Astra Otoparts');
INSERT INTO customer_hvc_links (customer_id, hvc_id, relationship_type) VALUES
  ('cust-1', 'hvc-1', 'TENANT');

-- Customer yang TIDAK di HVC (standalone)
INSERT INTO customers (id, name) VALUES 
  ('cust-2', 'PT ABC Mandiri');  -- Tidak ada entry di customer_hvc_links
```

### Business Rules

| Rule | Description |
|------|-------------|
| HVC itu optional | Customer tidak harus punya HVC |
| 1 Customer bisa di multiple HVC | Rare, tapi possible (via customer_hvc_links) |
| Relationship type wajib | Jika di-link, harus specify hubungan |

### Use Cases

| Scenario | Description |
|----------|-------------|
| **View HVC Customers** | Tampilkan semua customer yang linked ke HVC tertentu |
| **Standalone Customers** | Customer yang tidak linked ke HVC manapun |
| **HVC Activity Tracking** | Track aktivitas RM di customer dalam 1 HVC |

---

## ğŸ‘¤ Customer â†’ Pipeline Relationship

### Konsep

**1 Customer bisa memiliki banyak Pipeline**. Pipeline adalah prospek bisnis, bukan customer itu sendiri.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      CUSTOMER - PIPELINE RELATIONSHIP                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚    â”‚                         CUSTOMER                                   â”‚    â”‚
â”‚    â”‚                    PT Bank Mandiri                                â”‚    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                               â”‚                                              â”‚
â”‚                               â”‚ 1 : N (One Customer â†’ Many Pipelines)       â”‚
â”‚                               â”‚                                              â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚          â”‚                    â”‚                    â”‚                        â”‚
â”‚          â–¼                    â–¼                    â–¼                        â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚    â”‚ Pipeline  â”‚        â”‚ Pipeline  â”‚        â”‚ Pipeline  â”‚                 â”‚
â”‚    â”‚ Surety    â”‚        â”‚ CAR       â”‚        â”‚ Fire      â”‚                 â”‚
â”‚    â”‚ Bond      â”‚        â”‚ Insurance â”‚        â”‚ Insurance â”‚                 â”‚
â”‚    â”‚ (P1-HOT)  â”‚        â”‚ (NEW)     â”‚        â”‚ (WON)     â”‚                 â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                                              â”‚
â”‚    Note: 1 customer bisa punya multiple produk/pipeline berbeda             â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Business Rules

| Rule | Description |
|------|-------------|
| Customer wajib | Pipeline harus punya customer_id |
| Multiple pipelines OK | 1 customer bisa punya banyak pipeline berbeda COB |
| Stage independent | Tiap pipeline punya stage sendiri |

---

## ğŸ¤ Broker â†’ Pipeline Relationship

### Konsep

**Broker adalah SUMBER LEAD**, bukan entity terpisah yang punya pipeline. Pipeline yang berasal dari broker ditandai dengan `lead_source = 'BROKER'` dan memiliki `broker_id`.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      BROKER - PIPELINE RELATIONSHIP                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Lead Sources:                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚ DIRECT   â”‚  â”‚ BROKER   â”‚  â”‚ REFERRAL â”‚  â”‚ EVENT    â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                     â”‚                                                        â”‚
â”‚                     â”‚ lead_source = 'BROKER'                                â”‚
â”‚                     â”‚                                                        â”‚
â”‚                     â–¼                                                        â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚    â”‚                           BROKER                                    â”‚   â”‚
â”‚    â”‚                    (PT Marsh Indonesia)                            â”‚   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                               â”‚                                              â”‚
â”‚                               â”‚ 1 : N (Broker sources many Pipelines)       â”‚
â”‚                               â”‚                                              â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚          â”‚                    â”‚                    â”‚                        â”‚
â”‚          â–¼                    â–¼                    â–¼                        â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚    â”‚ Pipeline  â”‚        â”‚ Pipeline  â”‚        â”‚ Pipeline  â”‚                 â”‚
â”‚    â”‚ PIP-001   â”‚        â”‚ PIP-002   â”‚        â”‚ PIP-003   â”‚                 â”‚
â”‚    â”‚ Customer: â”‚        â”‚ Customer: â”‚        â”‚ Customer: â”‚                 â”‚
â”‚    â”‚ PT ABC    â”‚        â”‚ PT XYZ    â”‚        â”‚ PT 123    â”‚                 â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                                              â”‚
â”‚    Note: Broker mereferensikan pipeline, bukan memiliki customer            â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Database Implementation

```sql
-- Pipeline with Broker reference
CREATE TABLE pipelines (
  id UUID PRIMARY KEY,
  customer_id UUID REFERENCES customers(id) NOT NULL,  -- Always required
  lead_source_id UUID REFERENCES lead_sources(id) NOT NULL,
  broker_id UUID REFERENCES brokers(id),  -- ONLY if lead_source = BROKER
  broker_pic_id UUID REFERENCES key_persons(id),  -- Broker contact
  -- ...
  
  -- Constraint: broker_id only allowed when lead_source is BROKER
  CONSTRAINT check_broker_source CHECK (
    (lead_source_id IN (SELECT id FROM lead_sources WHERE code = 'BROKER') AND broker_id IS NOT NULL)
    OR
    (lead_source_id NOT IN (SELECT id FROM lead_sources WHERE code = 'BROKER') AND broker_id IS NULL)
  )
);

-- Contoh data:
-- Pipeline dari DIRECT (tanpa broker)
INSERT INTO pipelines (id, customer_id, lead_source_id, broker_id) VALUES
  ('pip-1', 'cust-1', 'src-direct', NULL);

-- Pipeline dari BROKER
INSERT INTO pipelines (id, customer_id, lead_source_id, broker_id) VALUES
  ('pip-2', 'cust-2', 'src-broker', 'broker-1');
```

### Business Rules

| Rule | Description |
|------|-------------|
| Broker = Lead Source | Broker menghasilkan pipeline, bukan memiliki |
| broker_id conditional | Hanya diisi jika lead_source = BROKER |
| Customer tetap wajib | Pipeline tetap milik customer |
| Broker bisa multiple PIC | Key persons untuk tiap broker |

### Use Cases

| Scenario | Description |
|----------|-------------|
| **Track Broker Performance** | Hitung berapa pipeline dari broker X yang WON |
| **Commission Calculation** | Identifikasi pipeline broker untuk komisi |
| **Broker Relationship** | RM bisa visit broker untuk cari lead baru |

---

## ğŸ“Š Summary: Complete Entity Map

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         COMPLETE ENTITY RELATIONSHIPS                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  ORGANIZATION                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Regional Office â†’ Branch â†’ User (flexible hierarchy)                â”‚    â”‚
â”‚  â”‚                                    â†“                                 â”‚    â”‚
â”‚  â”‚                            BM â†’ [BH] â†’ RM                           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                       â”‚                                      â”‚
â”‚                                       â”‚ owns                                 â”‚
â”‚                                       â–¼                                      â”‚
â”‚  BUSINESS DATA                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                                                                      â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚    â”‚
â”‚  â”‚  â”‚                     CUSTOMER                         â”‚            â”‚    â”‚
â”‚  â”‚  â”‚  (assigned to RM, optional HVC link)                â”‚            â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚    â”‚
â”‚  â”‚                         â”‚                                            â”‚    â”‚
â”‚  â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚    â”‚
â”‚  â”‚            â”‚            â”‚            â”‚                              â”‚    â”‚
â”‚  â”‚            â–¼            â–¼            â–¼                              â”‚    â”‚
â”‚  â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚    â”‚
â”‚  â”‚      â”‚PIPELINE 1â”‚  â”‚PIPELINE 2â”‚  â”‚PIPELINE nâ”‚                      â”‚    â”‚
â”‚  â”‚      â”‚          â”‚  â”‚          â”‚  â”‚          â”‚                      â”‚    â”‚
â”‚  â”‚      â”‚ COB: X   â”‚  â”‚ COB: Y   â”‚  â”‚ COB: Z   â”‚                      â”‚    â”‚
â”‚  â”‚      â”‚ Source:  â”‚  â”‚ Source:  â”‚  â”‚ Source:  â”‚                      â”‚    â”‚
â”‚  â”‚      â”‚ DIRECT   â”‚  â”‚ BROKER   â”‚  â”‚ REFERRAL â”‚                      â”‚    â”‚
â”‚  â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚    â”‚
â”‚  â”‚                         â”‚                                            â”‚    â”‚
â”‚  â”‚                         â”‚ if lead_source = BROKER                   â”‚    â”‚
â”‚  â”‚                         â–¼                                            â”‚    â”‚
â”‚  â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚    â”‚
â”‚  â”‚                   â”‚ BROKER   â”‚                                      â”‚    â”‚
â”‚  â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚    â”‚
â”‚  â”‚                                                                      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â”‚  HVC (OPTIONAL GROUPING)                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                    â”‚    â”‚
â”‚  â”‚  â”‚    HVC      â”‚ â†â”€â”€â”€â”€ Groups customers strategically               â”‚    â”‚
â”‚  â”‚  â”‚ (optional)  â”‚       Not all customers belong to HVC              â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                                    â”‚    â”‚
â”‚  â”‚         â”‚                                                            â”‚    â”‚
â”‚  â”‚         â”‚ many-to-many (via customer_hvc_links)                     â”‚    â”‚
â”‚  â”‚         â”‚                                                            â”‚    â”‚
â”‚  â”‚    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚    â”‚
â”‚  â”‚    â–¼         â–¼            â–¼                                         â”‚    â”‚
â”‚  â”‚ Customer  Customer    Customer                                      â”‚    â”‚
â”‚  â”‚                                                                      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“š Related Documents

- [Schema Overview](schema-overview.md) - Database tables
- [RLS Policies](rls-policies.md) - Access control
- [Functional Requirements](../02-requirements/functional-requirements.md) - Business rules

---

*Entity relationships version 1.0 - January 2025*
