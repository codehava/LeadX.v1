---
phase: 02-sync-engine-core
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - lib/data/repositories/hvc_repository_impl.dart
  - lib/data/repositories/broker_repository_impl.dart
  - lib/data/repositories/cadence_repository_impl.dart
  - lib/data/repositories/pipeline_referral_repository_impl.dart
  - lib/presentation/providers/hvc_providers.dart
  - lib/presentation/providers/broker_providers.dart
  - lib/presentation/providers/cadence_providers.dart
  - lib/presentation/providers/sync_providers.dart
autonomous: true

must_haves:
  truths:
    - "All HVC, broker, cadence, and pipeline referral write operations are wrapped in Drift transactions"
    - "HVC, broker, and cadence repositories have _database constructor parameter"
    - "Incremental sync passes since timestamps to all syncFromRemote calls in _pullFromRemote"
    - "Per-entity-type timestamps stored via AppSettingsService after successful pull"
    - "Sync after initial full pull fetches only records updated since last pull"
  artifacts:
    - path: "lib/data/repositories/hvc_repository_impl.dart"
      provides: "Atomic transactions for HVC write methods"
      contains: "_database.transaction"
    - path: "lib/data/repositories/broker_repository_impl.dart"
      provides: "Atomic transactions for broker write methods"
      contains: "_database.transaction"
    - path: "lib/data/repositories/cadence_repository_impl.dart"
      provides: "Atomic transactions for cadence write methods"
      contains: "_database.transaction"
    - path: "lib/data/repositories/pipeline_referral_repository_impl.dart"
      provides: "Atomic transactions for pipeline referral write methods"
      contains: "_database.transaction"
    - path: "lib/presentation/providers/sync_providers.dart"
      provides: "Incremental _pullFromRemote with per-entity since timestamps"
      contains: "getTableLastSyncAt"
  key_links:
    - from: "lib/presentation/providers/sync_providers.dart"
      to: "lib/data/services/app_settings_service.dart"
      via: "SyncNotifier reads/writes per-entity timestamps"
      pattern: "getTableLastSyncAt|setTableLastSyncAt"
    - from: "lib/presentation/providers/sync_providers.dart"
      to: "lib/domain/repositories/customer_repository.dart"
      via: "syncFromRemote(since: customerSince)"
      pattern: "syncFromRemote\\(since:"
---

<objective>
Complete atomic transactions for remaining repositories (HVC, Broker, Cadence, PipelineReferral) and wire incremental sync timestamps in SyncNotifier._pullFromRemote() (SYNC-01 part 2 + SYNC-02).

Purpose: Finishes the data integrity guarantee across ALL syncable repositories and dramatically reduces sync duration by fetching only records updated since the last pull. Together these complete the sync engine core requirements.

Output: All 8 repositories using atomic transactions. SyncNotifier._pullFromRemote() passes per-entity `since` timestamps to all syncFromRemote calls.
</objective>

<execution_context>
@C:/Users/cartr/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/cartr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-sync-engine-core/02-RESEARCH.md
@.planning/phases/02-sync-engine-core/02-02-SUMMARY.md

@lib/data/repositories/hvc_repository_impl.dart
@lib/data/repositories/broker_repository_impl.dart
@lib/data/repositories/cadence_repository_impl.dart
@lib/data/repositories/pipeline_referral_repository_impl.dart
@lib/presentation/providers/hvc_providers.dart
@lib/presentation/providers/broker_providers.dart
@lib/presentation/providers/cadence_providers.dart
@lib/presentation/providers/sync_providers.dart
@lib/data/services/app_settings_service.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add _database to HVC/Broker/Cadence repos, update providers, wrap all write methods in transactions</name>
  <files>
    lib/data/repositories/hvc_repository_impl.dart
    lib/data/repositories/broker_repository_impl.dart
    lib/data/repositories/cadence_repository_impl.dart
    lib/data/repositories/pipeline_referral_repository_impl.dart
    lib/presentation/providers/hvc_providers.dart
    lib/presentation/providers/broker_providers.dart
    lib/presentation/providers/cadence_providers.dart
  </files>
  <action>
**Step 1: Add `_database` to repositories that don't have it:**

Three repositories need `_database` added (HVC, Broker, Cadence). PipelineReferralRepositoryImpl already has it.

For each of HvcRepositoryImpl, BrokerRepositoryImpl, CadenceRepositoryImpl:
1. Add `required AppDatabase database,` to named constructor params (use the `db` alias: `required db.AppDatabase database,`)
2. Add `_database = database` to initializer list
3. Add `final db.AppDatabase _database;` field

**Step 2: Update provider definitions to pass database:**

In `hvc_providers.dart` (`hvcRepositoryProvider`):
```dart
final database = ref.watch(databaseProvider);
return HvcRepositoryImpl(
  ...existing params...,
  database: database,
);
```
Import `databaseProvider` from `database_provider.dart` if not already imported.

In `broker_providers.dart` (`brokerRepositoryProvider`):
```dart
final database = ref.watch(databaseProvider);
return BrokerRepositoryImpl(
  ...existing params...,
  database: database,
);
```

In `cadence_providers.dart` (`cadenceRepositoryProvider`):
```dart
final database = ref.watch(databaseProvider);
return CadenceRepositoryImpl(
  ...existing params...,
  database: database,
);
```

**Step 3: Wrap all write methods in `_database.transaction()`:**

Apply the same pattern as Plan 02: wrap local write + queueOperation inside `_database.transaction()`, keep triggerSync outside.

**HvcRepositoryImpl** — Find all methods that call `_syncService.queueOperation()`. Typical methods: createHvc, updateHvc, deleteHvc, linkCustomerToHvc, unlinkCustomerFromHvc. Wrap each one.

**BrokerRepositoryImpl** — Find all methods that call `_syncService.queueOperation()`. Typical methods: createBroker, updateBroker. Wrap each one.

**CadenceRepositoryImpl** — Find all methods that call `_syncService.queueOperation()`. This repo has the most methods: createMeeting, updateMeeting, deleteMeeting, addParticipant, removeParticipant, updateParticipantStatus, createConfig, updateConfig, and potentially others. Wrap ALL methods that have a local write followed by a queueOperation call.

**PipelineReferralRepositoryImpl** — Already has `_database`. Find all methods that call `_syncService.queueOperation()`. Typical methods: createReferral, acceptReferral, rejectReferral, cancelReferral, approveReferral. Wrap each one.

**For each method, apply this pattern:**
```dart
await _database.transaction(() async {
  await _localDataSource.doLocalWrite(...);
  // Any reads needed for sync payload should also be inside the transaction
  await _syncService.queueOperation(...);
});
unawaited(_syncService.triggerSync());
```

**Tip:** Search each repository file for `queueOperation` to find every method that needs wrapping. Every call site of `queueOperation` should be inside a transaction.
  </action>
  <verify>
Run `flutter analyze` — zero errors. Verify HvcRepositoryImpl, BrokerRepositoryImpl, CadenceRepositoryImpl all have `_database` field. Verify all provider files pass `database:` parameter. Grep for `_database.transaction` in all 4 repository files — each should have at least 2 occurrences.
  </verify>
  <done>
All 4 remaining repositories have _database fields, providers updated, and all write methods wrapped in Drift transactions. Combined with Plan 02, all 8 syncable repositories now have atomic local-write + queue-insert operations.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire incremental sync timestamps in SyncNotifier._pullFromRemote()</name>
  <files>
    lib/presentation/providers/sync_providers.dart
  </files>
  <action>
**Step 1: Inject AppSettingsService into SyncNotifier:**

Add `AppSettingsService` as a constructor parameter:
1. Add `this._appSettingsService,` to the constructor parameter list
2. Add `final AppSettingsService _appSettingsService;` field

Update `syncNotifierProvider` to pass it:
```dart
final appSettings = ref.watch(appSettingsServiceProvider);

return SyncNotifier(
  ref,
  syncService,
  customerRepository,
  pipelineRepository,
  activityRepository,
  hvcRepository,
  brokerRepository,
  cadenceRepository,
  pipelineReferralRepository,
  connectivityService,
  appSettings,  // NEW — add at end to match constructor order
);
```

**Step 2: Rewrite `_pullFromRemote()` to pass `since` timestamps:**

For EACH entity pull in `_pullFromRemote()`, apply this pattern:
1. Read the last pull timestamp BEFORE starting the pull (record timestamp before pull, not after — this avoids missing records modified during the pull)
2. Pass `since:` to `syncFromRemote()`
3. On success, store `DateTime.now()` as the new timestamp

**Timestamp recording strategy per the research pitfall #2:** Record the timestamp BEFORE starting the pull. This may cause a few duplicates on next sync but never misses records. Use a small safety margin by subtracting 30 seconds from the stored `since` timestamp when reading it.

Apply to these entity pulls (using consistent table name keys):

```dart
// Helper to read since with 30s safety margin
Future<DateTime?> _getSafeSince(String tableName) async {
  final since = await _appSettingsService.getTableLastSyncAt(tableName);
  if (since == null) return null;
  return since.subtract(const Duration(seconds: 30));
}
```

Add this as a private method on SyncNotifier (or inline if preferred).

**Entity-by-entity changes in _pullFromRemote():**

1. **Customers** (`table key: 'customers'`):
```dart
final customerSince = await _getSafeSince('customers');
final customerResult = await _customerRepository.syncFromRemote(since: customerSince);
customerResult.fold(
  (failure) => AppLogger.instance.warning('sync.pull | Customer pull failed: ${failure.message}'),
  (count) {
    AppLogger.instance.debug('sync.pull | Pulled $count customers (since: $customerSince)');
    _appSettingsService.setTableLastSyncAt('customers', DateTime.now());
  },
);
```

2. **Key Persons** (`table key: 'key_persons'`):
```dart
final keyPersonSince = await _getSafeSince('key_persons');
final keyPersonResult = await _customerRepository.syncKeyPersonsFromRemote(since: keyPersonSince);
// Same fold pattern, set 'key_persons' on success
```

3. **Pipelines** (`table key: 'pipelines'`):
```dart
final pipelineSince = await _getSafeSince('pipelines');
await _pipelineRepository.syncFromRemote(since: pipelineSince);
// Note: pipeline syncFromRemote may not return Either — check the return type.
// If it returns void or doesn't use Either, just call setTableLastSyncAt after success.
_appSettingsService.setTableLastSyncAt('pipelines', DateTime.now());
```

4. **Activities** (`table key: 'activities'`):
```dart
final activitySince = await _getSafeSince('activities');
await _activityRepository.syncFromRemote(since: activitySince);
_appSettingsService.setTableLastSyncAt('activities', DateTime.now());
```

5. **HVCs** (`table key: 'hvcs'`):
```dart
final hvcSince = await _getSafeSince('hvcs');
final hvcResult = await _hvcRepository.syncFromRemote(since: hvcSince);
// fold pattern, set 'hvcs' on success
```

6. **HVC Links** (`table key: 'customer_hvc_links'`):
```dart
final hvcLinkSince = await _getSafeSince('customer_hvc_links');
final hvcLinkResult = await _hvcRepository.syncLinksFromRemote(since: hvcLinkSince);
// fold pattern, set 'customer_hvc_links' on success
```

7. **Brokers** (`table key: 'brokers'`):
```dart
final brokerSince = await _getSafeSince('brokers');
final brokerResult = await _brokerRepository.syncFromRemote(since: brokerSince);
// fold pattern, set 'brokers' on success
```

8. **Cadence** (`table key: 'cadence_meetings'`):
```dart
final cadenceSince = await _getSafeSince('cadence_meetings');
await _cadenceRepository.syncFromRemote(since: cadenceSince);
_appSettingsService.setTableLastSyncAt('cadence_meetings', DateTime.now());
```

9. **Pipeline Referrals** (`table key: 'pipeline_referrals'`):
```dart
final referralSince = await _getSafeSince('pipeline_referrals');
await _pipelineReferralRepository.syncFromRemote(since: referralSince);
_appSettingsService.setTableLastSyncAt('pipeline_referrals', DateTime.now());
```

**Important:** Check each repository's `syncFromRemote()` method signature to verify it accepts `DateTime? since`. All should per the research, but verify the actual parameter names. Some may use `since:` and others might have a different parameter. If any don't accept `since`, note it in the summary but don't modify repository interfaces — that's beyond this plan's scope.

**Important:** The `setTableLastSyncAt` call should only happen on SUCCESS. For Entity types that return `Either`, only call it in the right branch. For types that don't use Either (pipeline, activity, cadence, referral), wrap the setTableLastSyncAt inside the try block after the successful call.

**Important:** Keep the existing cache invalidation calls (e.g., `pipelineRepo.invalidateCaches()`, `_activityRepository.invalidateCaches()`, `_pipelineReferralRepository.invalidateCaches()`) in place — they're still needed. The since parameter doesn't change the need for cache invalidation.

**Important:** Keep the existing `_syncPhotos()`, `_syncAuditLogs()`, `syncPhotosFromRemote()` calls unchanged — those don't use `since` timestamps.
  </action>
  <verify>
Run `flutter analyze` — zero errors. Verify SyncNotifier constructor accepts `AppSettingsService`. Verify `syncNotifierProvider` passes `appSettings`. Grep for `getTableLastSyncAt` in `sync_providers.dart` — should find 9+ occurrences (one per entity type). Grep for `setTableLastSyncAt` in `sync_providers.dart` — should find 9+ occurrences. Verify `syncFromRemote(since:` pattern appears for each entity pull.
  </verify>
  <done>
SyncNotifier._pullFromRemote() passes per-entity since timestamps to all syncFromRemote calls. Timestamps stored in AppSettingsService after each successful pull. Safety margin of 30 seconds prevents missed records. First sync (null since) still does full pull; subsequent syncs are incremental.
  </done>
</task>

</tasks>

<verification>
1. `flutter analyze` passes with zero errors
2. All 8 syncable repositories wrap write methods in `_database.transaction()`
3. HVC, Broker, Cadence repositories have `_database` field and providers pass it
4. SyncNotifier has `_appSettingsService` field injected via provider
5. `_pullFromRemote()` reads `getTableLastSyncAt` for each entity type before pull
6. `_pullFromRemote()` writes `setTableLastSyncAt` for each entity type after successful pull
7. `syncFromRemote(since: ...)` is called for all 9 entity type pulls
</verification>

<success_criteria>
- All 8 repositories have atomic transactions (completing SYNC-01)
- Incremental sync passes since timestamps to all pull operations (completing SYNC-02)
- First sync does full pull (since is null), subsequent syncs fetch only changed records
- All code compiles and passes analysis
</success_criteria>

<output>
After completion, create `.planning/phases/02-sync-engine-core/02-03-SUMMARY.md`
</output>
