---
phase: 10-scoring-optimization
plan: 02
type: execute
wave: 2
depends_on: [10-01]
files_modified:
  - lib/data/datasources/remote/scoreboard_remote_data_source.dart
  - lib/presentation/screens/scoreboard/leaderboard_screen.dart
  - lib/presentation/screens/scoreboard/scoreboard_screen.dart
  - lib/presentation/providers/scoreboard_providers.dart
  - lib/presentation/providers/scoreboard_providers.g.dart
  - lib/domain/repositories/scoreboard_repository.dart
  - lib/data/repositories/scoreboard_repository_impl.dart
autonomous: true
requirements: [SCORE-01, SCORE-02]

must_haves:
  truths:
    - "Leaderboard entries show actual rank and rank_change values from server instead of null"
    - "Leaderboard screen has a role filter chip (RM/BH/BM/ROH) alongside existing All/Branch/Region filters"
    - "Scoreboard screen shows 'Score update pending' hint when local data has been modified but scores have not been recalculated"
    - "Scoreboard screen supports pull-to-refresh for manual server data fetch"
    - "fetchUserPeriodSummary uses correct column name (calculated_at not snapshot_at)"
  artifacts:
    - path: "lib/data/datasources/remote/scoreboard_remote_data_source.dart"
      provides: "Fixed rankChange reading, corrected snapshot_at reference, new RPC-based fetchFilteredLeaderboard"
      contains: "rank_change"
    - path: "lib/presentation/screens/scoreboard/leaderboard_screen.dart"
      provides: "Role filter chip in filter row"
      contains: "role"
    - path: "lib/presentation/screens/scoreboard/scoreboard_screen.dart"
      provides: "Score update pending indicator and pull-to-refresh"
      contains: "pending"
  key_links:
    - from: "lib/data/datasources/remote/scoreboard_remote_data_source.dart"
      to: "get_filtered_leaderboard RPC"
      via: "supabase.rpc('get_filtered_leaderboard')"
      pattern: "get_filtered_leaderboard"
    - from: "lib/presentation/screens/scoreboard/scoreboard_screen.dart"
      to: "lib/presentation/providers/scoreboard_providers.dart"
      via: "isScoreUpdatePendingProvider"
      pattern: "isScoreUpdatePending"
---

<objective>
Fix client-side scoring data layer to read rank/rank_change from server responses, add role filter to leaderboard, add score update pending indicator, and fix the snapshot_at column reference bug.

Purpose: The server now computes rankings (Plan 01), but the client hardcodes `rankChange: null` and uses an incorrect column name. These fixes make the leaderboard functional with real ranking data.

Output: Updated remote data source, leaderboard screen with role filter, scoreboard with pending indicator
</objective>

<execution_context>
@C:/Users/cartr/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/cartr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-scoring-optimization/10-CONTEXT.md
@.planning/phases/10-scoring-optimization/10-RESEARCH.md
@.planning/phases/10-scoring-optimization/10-01-SUMMARY.md
@lib/data/datasources/remote/scoreboard_remote_data_source.dart
@lib/presentation/screens/scoreboard/leaderboard_screen.dart
@lib/presentation/screens/scoreboard/scoreboard_screen.dart
@lib/presentation/providers/scoreboard_providers.dart
@lib/domain/repositories/scoreboard_repository.dart
@lib/data/repositories/scoreboard_repository_impl.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix remote data source for ranking data and add RPC-based filtered leaderboard</name>
  <files>
    lib/data/datasources/remote/scoreboard_remote_data_source.dart
    lib/domain/repositories/scoreboard_repository.dart
    lib/data/repositories/scoreboard_repository_impl.dart
    lib/presentation/providers/scoreboard_providers.dart
    lib/presentation/providers/scoreboard_providers.g.dart
  </files>
  <action>
**In `scoreboard_remote_data_source.dart`:**

1. **Fix `fetchLeaderboard` method (line ~261)**: Change `rankChange: null, // Would need previous period comparison` to `rankChange: jsonMap['rank_change'] as int?,`

2. **Fix `fetchLeaderboardWithFilters` method (line ~310)**: Same fix -- change `rankChange: null, // Would need previous period comparison` to `rankChange: jsonMap['rank_change'] as int?,`

3. **Fix `fetchUserPeriodSummary` method (line ~226)**: Change `.order('snapshot_at', ascending: false)` to `.order('calculated_at', ascending: false)`. The Drift table uses `calculated_at` and the PostgreSQL column is also `calculated_at` (confirmed by the `recalculate_aggregate` function which writes to `calculated_at`).

4. **Add new `fetchFilteredLeaderboardRpc` method** that calls the `get_filtered_leaderboard` RPC function created in Plan 01:
```dart
/// Fetch leaderboard via RPC with dynamic ranking within filter context.
Future<List<LeaderboardEntry>> fetchFilteredLeaderboardRpc(
  String periodId, {
  String? role,
  String? branchId,
  String? regionalOfficeId,
}) async {
  final response = await _supabase.rpc(
    'get_filtered_leaderboard',
    params: {
      'p_period_id': periodId,
      if (role != null) 'p_role': role,
      if (branchId != null) 'p_branch_id': branchId,
      if (regionalOfficeId != null) 'p_regional_office_id': regionalOfficeId,
    },
  );
  return (response as List).map((json) {
    final jsonMap = json as Map<String, dynamic>;
    return LeaderboardEntry(
      id: '${jsonMap['user_id']}_${periodId}',
      rank: (jsonMap['rank'] as int? ?? 0).toString(),
      userId: jsonMap['user_id'] as String? ?? '',
      userName: jsonMap['user_name'] as String? ?? 'Unknown',
      score: (jsonMap['total_score'] as num?)?.toDouble() ?? 0,
      leadScore: (jsonMap['lead_score'] as num?)?.toDouble() ?? 0,
      lagScore: (jsonMap['lag_score'] as num?)?.toDouble() ?? 0,
      rankChange: jsonMap['rank_change'] as int?,
      branchName: jsonMap['branch_name'] as String?,
    );
  }).toList();
}
```

5. **Add `isScoreUpdatePending` method** to check if any sync queue items exist for scoring-relevant entities:
```dart
/// Check if there are pending sync queue items that affect scoring.
/// Used for the "score update pending" hint on scoreboard.
Future<bool> checkScoreUpdatePending(String userId) async {
  // This will be implemented at the provider level using local DB
  // since sync_queue is local-only. This method is not needed here.
  throw UnimplementedError('Use local provider instead');
}
```
Actually, do NOT add this method to the remote data source. The sync queue is local. The pending check will be in a provider (see Task 2).

**In `scoreboard_repository.dart` (interface):**

Add method:
```dart
/// Get filtered leaderboard with dynamic ranking via RPC.
Future<List<LeaderboardEntry>> getFilteredLeaderboardRpc(
  String periodId, {
  String? role,
  String? branchId,
  String? regionalOfficeId,
});
```

**In `scoreboard_repository_impl.dart`:**

Implement the new method. Try remote first, fall back to existing `getLeaderboardWithFilters` for offline support:
```dart
@override
Future<List<LeaderboardEntry>> getFilteredLeaderboardRpc(
  String periodId, {
  String? role,
  String? branchId,
  String? regionalOfficeId,
}) async {
  final isOnline = await _connectivityService.isConnected;
  if (isOnline) {
    try {
      return await _remoteDataSource.fetchFilteredLeaderboardRpc(
        periodId,
        role: role,
        branchId: branchId,
        regionalOfficeId: regionalOfficeId,
      );
    } catch (e) {
      // Fall through to local fallback
    }
  }
  // Offline fallback: use existing filter method (no dynamic ranking)
  return getLeaderboardWithFilters(
    periodId,
    branchId: branchId,
    regionalOfficeId: regionalOfficeId,
  );
}
```

**In `scoreboard_providers.dart`:**

Add `isScoreUpdatePendingProvider`:
```dart
/// Check if any pending sync queue items exist for scoring-relevant entities.
/// Shows "score update pending" hint on scoreboard when true.
@riverpod
Stream<bool> isScoreUpdatePending(ref) {
  final db = ref.watch(appDatabaseProvider);
  // Watch sync queue for pending items that affect scoring
  return (db.select(db.syncQueueItems)
    ..where((t) => t.entityType.isIn(['activity', 'pipeline', 'customer'])
      & t.status.equals('pending')))
    .watch()
    .map((items) => items.isNotEmpty);
}
```

Update `filteredLeaderboardProvider` to use the new RPC method when a role filter is active:
```dart
@riverpod
Future<List<LeaderboardEntry>> filteredLeaderboard(
  ref,
  String periodId, {
  String? branchId,
  String? regionalOfficeId,
  String? searchQuery,
  String? role,
}) async {
  final repository = ref.watch(scoreboardRepositoryProvider);

  // Use RPC method when role filter is active or for better ranking
  if (role != null) {
    return repository.getFilteredLeaderboardRpc(
      periodId,
      role: role,
      branchId: branchId,
      regionalOfficeId: regionalOfficeId,
    );
  }

  // Existing behavior for non-role filters
  return repository.getLeaderboardWithFilters(
    periodId,
    branchId: branchId,
    regionalOfficeId: regionalOfficeId,
    searchQuery: searchQuery,
    limit: 100,
  );
}
```

Update LeaderboardFilter class to include `selectedRole`:
```dart
class LeaderboardFilter {
  final ScoringPeriod? selectedPeriod;
  final LeaderboardFilterMode filterMode;
  final String? selectedBranchId;
  final String? selectedRegionalOfficeId;
  final String? selectedRole;  // NEW
  final String searchQuery;
  // ... update copyWith accordingly
}
```

Run `dart run build_runner build --delete-conflicting-outputs` after all changes.
  </action>
  <verify>
1. `flutter analyze` passes (or only pre-existing warnings)
2. Search for `rankChange: null` in scoreboard_remote_data_source.dart -- should have zero occurrences
3. Search for `snapshot_at` in scoreboard_remote_data_source.dart -- should have zero occurrences
4. Verify new `fetchFilteredLeaderboardRpc` method exists
5. Verify `isScoreUpdatePendingProvider` exists in generated file
  </verify>
  <done>Remote data source reads rank_change from server response instead of hardcoding null. snapshot_at bug fixed. RPC-based filtered leaderboard method added. Score update pending provider added.</done>
</task>

<task type="auto">
  <name>Task 2: Add role filter to leaderboard screen and score pending indicator to scoreboard</name>
  <files>
    lib/presentation/screens/scoreboard/leaderboard_screen.dart
    lib/presentation/screens/scoreboard/scoreboard_screen.dart
  </files>
  <action>
**In `leaderboard_screen.dart`:**

1. **Add role filter chip row** below the existing filter chips (All Company / My Branch / My Region). Add a new row or extend the existing row with role-specific chips:
```dart
// After the geography filter chips, add role filter chips
// Only show when not in search mode
Padding(
  padding: const EdgeInsets.symmetric(horizontal: 16),
  child: SingleChildScrollView(
    scrollDirection: Axis.horizontal,
    child: Row(
      children: [
        FilterChip(
          label: const Text('Semua Jabatan'),
          selected: filterState.selectedRole == null,
          onSelected: (_) {
            ref.read(leaderboardFilterNotifierProvider.notifier)
                .setRole(null);
          },
          selectedColor: theme.colorScheme.secondaryContainer,
        ),
        const SizedBox(width: 8),
        for (final role in ['RM', 'BH', 'BM', 'ROH'])
          Padding(
            padding: const EdgeInsets.only(right: 8),
            child: FilterChip(
              label: Text(role),
              selected: filterState.selectedRole == role,
              onSelected: (_) {
                ref.read(leaderboardFilterNotifierProvider.notifier)
                    .setRole(role);
              },
              selectedColor: theme.colorScheme.secondaryContainer,
            ),
          ),
      ],
    ),
  ),
),
```

2. **Update the leaderboard query** to pass the role filter to `filteredLeaderboardProvider`:
```dart
final leaderboardAsync = selectedPeriod != null
    ? ref.watch(filteredLeaderboardProvider(
        selectedPeriod.id,
        branchId: filterState.selectedBranchId,
        regionalOfficeId: filterState.selectedRegionalOfficeId,
        searchQuery: filterState.searchQuery.isNotEmpty
            ? filterState.searchQuery
            : null,
        role: filterState.selectedRole,  // NEW
      ))
    : null;
```

3. **Add `setRole` method** to `LeaderboardFilterNotifier` in scoreboard_providers.dart:
```dart
void setRole(String? role) {
  state = state.copyWith(selectedRole: role);
}
```

**In `scoreboard_screen.dart`:**

1. **Add "Score update pending" hint** below the score card or at the top of the content area. Use `isScoreUpdatePendingProvider`:
```dart
// Inside the body builder, after the score gauge/card section
final isScorePendingAsync = ref.watch(isScoreUpdatePendingProvider);
// ...
isScorePendingAsync.when(
  data: (isPending) {
    if (isPending) {
      return Container(
        margin: const EdgeInsets.symmetric(horizontal: 16, vertical: 4),
        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
        decoration: BoxDecoration(
          color: Colors.amber.withValues(alpha: 0.1),
          borderRadius: BorderRadius.circular(8),
          border: Border.all(color: Colors.amber.withValues(alpha: 0.3)),
        ),
        child: Row(
          children: [
            Icon(Icons.sync, size: 16, color: Colors.amber.shade700),
            const SizedBox(width: 8),
            Expanded(
              child: Text(
                'Skor sedang diperbarui oleh server...',
                style: theme.textTheme.bodySmall?.copyWith(
                  color: Colors.amber.shade700,
                ),
              ),
            ),
          ],
        ),
      );
    }
    return const SizedBox.shrink();
  },
  loading: () => const SizedBox.shrink(),
  error: (_, __) => const SizedBox.shrink(),
),
```

2. **Wrap scoreboard body in RefreshIndicator** for pull-to-refresh (per locked decision: "Manual refresh button on scoreboard"):
The existing refresh icon button in the AppBar already calls `refresh()`. Add a `RefreshIndicator` wrapper around the body content as well for pull-to-refresh gesture support. The `_buildContent` method's `SingleChildScrollView` or `ListView` should be wrapped.

3. **Use `AppErrorState` pattern** (from CLAUDE.md key pattern #8) for the error state instead of raw `Text('Error: $error')` in the scoreboard screen.
  </action>
  <verify>
1. `flutter analyze` passes (or only pre-existing warnings)
2. Leaderboard screen shows role filter chips (Semua Jabatan, RM, BH, BM, ROH)
3. Scoreboard screen shows "Skor sedang diperbarui" hint when pending sync items exist
4. Scoreboard body supports pull-to-refresh gesture
  </verify>
  <done>Leaderboard has role filter chips. Scoreboard shows score pending indicator and supports pull-to-refresh. Error display uses AppErrorState pattern.</done>
</task>

</tasks>

<verification>
1. `dart run build_runner build --delete-conflicting-outputs` succeeds
2. `flutter analyze` passes (or only pre-existing warnings)
3. No occurrences of `rankChange: null` in remote data source
4. No occurrences of `snapshot_at` in remote data source
5. Role filter chips visible in leaderboard screen code
6. Score pending indicator visible in scoreboard screen code
7. Pull-to-refresh wrapper exists on scoreboard
</verification>

<success_criteria>
Client reads real ranking data from server. Leaderboard supports role-based filtering. Scoreboard shows when scores are being updated. All changes follow existing code patterns (provider hierarchy, Indonesian UI strings, AppErrorState).
</success_criteria>

<output>
After completion, create `.planning/phases/10-scoring-optimization/10-02-SUMMARY.md`
</output>
