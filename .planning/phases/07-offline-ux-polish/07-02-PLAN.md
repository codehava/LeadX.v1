---
phase: 07-offline-ux-polish
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - lib/presentation/widgets/cards/customer_card.dart
  - lib/presentation/widgets/cards/pipeline_card.dart
  - lib/presentation/widgets/activity/activity_card.dart
  - lib/presentation/widgets/hvc/hvc_card.dart
  - lib/presentation/widgets/broker/broker_card.dart
  - lib/presentation/widgets/referral/referral_card.dart
  - lib/presentation/screens/cadence/widgets/meeting_card.dart
  - lib/presentation/screens/customer/customer_detail_screen.dart
  - lib/presentation/screens/hvc/hvc_detail_screen.dart
  - lib/presentation/screens/broker/broker_detail_screen.dart
autonomous: true
requirements:
  - UX-02
  - UX-04

must_haves:
  truths:
    - "Entity cards show no badge when entity is synced (no badge = synced per locked decision)"
    - "Entity cards show pending badge when entity has a pending item in sync queue"
    - "Entity cards show amber/orange failed badge when entity has a failed queue item (retryCount < 5)"
    - "Entity cards show red dead letter badge when entity has a dead letter queue item (retryCount >= 5)"
    - "Tapping a failed or dead letter badge on a card navigates to sync queue screen filtered to that entity"
    - "Activity card uses SyncStatusBadge instead of raw Icons.sync icon"
    - "All 8 syncable entity card types have badge support (Customer, Pipeline, Activity, HVC, Broker, Referral, Cadence Meeting, Key Person)"
  artifacts:
    - path: "lib/presentation/widgets/cards/customer_card.dart"
      provides: "Sync queue-aware badge with tap navigation"
      contains: "syncQueueEntityStatusMapProvider"
    - path: "lib/presentation/widgets/activity/activity_card.dart"
      provides: "Migrated from raw icon to SyncStatusBadge with queue status"
      contains: "SyncStatusBadge"
    - path: "lib/presentation/screens/cadence/widgets/meeting_card.dart"
      provides: "New sync status badge on cadence meeting card"
      contains: "syncQueueEntityStatusMapProvider"
  key_links:
    - from: "lib/presentation/widgets/cards/customer_card.dart"
      to: "lib/presentation/providers/sync_providers.dart"
      via: "ref.watch(syncQueueEntityStatusMapProvider)"
      pattern: "syncQueueEntityStatusMapProvider"
    - from: "all card widgets"
      to: "/home/sync-queue"
      via: "context.push with entityId query param on failed/dead letter badge tap"
      pattern: "sync-queue"
---

<objective>
Add sync queue-aware badges to all entity cards with failed/dead letter tap navigation, and migrate Activity card from raw icon to SyncStatusBadge.

Purpose: Makes sync problems visible at the card level so field reps know immediately which records have sync issues. Tapping failed badges navigates to the sync queue for resolution.

Output: All 8 entity card types show problem-state badges with tap-to-navigate for failed/dead letter items.
</objective>

<execution_context>
@C:/Users/cartr/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/cartr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-offline-ux-polish/07-RESEARCH.md
@.planning/phases/07-offline-ux-polish/07-01-SUMMARY.md
@lib/presentation/widgets/common/sync_status_badge.dart
@lib/presentation/providers/sync_providers.dart
@lib/presentation/widgets/cards/customer_card.dart
@lib/presentation/widgets/cards/pipeline_card.dart
@lib/presentation/widgets/activity/activity_card.dart
@lib/presentation/widgets/hvc/hvc_card.dart
@lib/presentation/widgets/broker/broker_card.dart
@lib/presentation/widgets/referral/referral_card.dart
@lib/presentation/screens/cadence/widgets/meeting_card.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Customer, Pipeline, and Activity cards with sync queue-aware badges</name>
  <files>
    lib/presentation/widgets/cards/customer_card.dart
    lib/presentation/widgets/cards/pipeline_card.dart
    lib/presentation/widgets/activity/activity_card.dart
  </files>
  <action>
    Apply the same badge pattern to all three cards. Each card needs:

    1. Add required imports: `flutter_riverpod`, `go_router`, `sync_providers.dart` (for `syncQueueEntityStatusMapProvider` and `SyncQueueEntityStatus`), and `sync_status_badge.dart` if not already imported.

    2. If the card is a StatelessWidget, convert to ConsumerWidget (needs `ref` for watching the provider). If already ConsumerWidget, proceed.

    3. Create a shared badge builder method in each card (or inline it). The pattern:
       ```dart
       Widget _buildSyncBadge(BuildContext context, WidgetRef ref, String entityId) {
         final statusMap = ref.watch(syncQueueEntityStatusMapProvider);
         final queueStatus = statusMap.valueOrNull?[entityId];

         // Fallback: if not in queue, check entity's isPendingSync field
         // This covers items queued but not yet reflected in the map (race condition)
         if (queueStatus == null) {
           // For Customer: customer.isPendingSync, for Pipeline: pipeline.isPendingSync, etc.
           if (entity.isPendingSync) {
             return const SyncStatusBadge(status: SyncStatus.pending);
           }
           return const SizedBox.shrink(); // No badge = synced (per locked decision)
         }

         final syncStatus = switch (queueStatus) {
           SyncQueueEntityStatus.pending => SyncStatus.pending,
           SyncQueueEntityStatus.failed => SyncStatus.failed,
           SyncQueueEntityStatus.deadLetter => SyncStatus.deadLetter,
           SyncQueueEntityStatus.none => null,
         };

         if (syncStatus == null) return const SizedBox.shrink();

         final badge = SyncStatusBadge(status: syncStatus);

         // Failed/dead letter badges are tappable -> navigate to sync queue filtered by entity
         if (queueStatus == SyncQueueEntityStatus.failed ||
             queueStatus == SyncQueueEntityStatus.deadLetter) {
           return GestureDetector(
             onTap: () => context.push('/home/sync-queue?entityId=$entityId'),
             child: badge,
           );
         }

         return badge;
       }
       ```

    **CustomerCard specifics:**
    - Already a ConsumerWidget -- good.
    - Replace the existing badge logic (`if (showSyncStatus && customer.isPendingSync) SyncStatusBadge(...)`) in the header Row with the new `_buildSyncBadge(context, ref, customer.id)`.
    - Keep the `showSyncStatus` parameter -- wrap the badge call in `if (showSyncStatus)`.
    - Add `import 'package:go_router/go_router.dart';` and import for sync_providers.dart.

    **PipelineCard specifics:**
    - Read the file first to see current structure. Apply same pattern.
    - Replace existing pending-only badge with queue-aware badge in header Row.
    - If it's a StatelessWidget, convert to ConsumerWidget.

    **ActivityCard specifics:**
    - Currently a StatelessWidget with raw `Icons.sync` in `_buildContent()`. Convert to ConsumerWidget.
    - Remove the raw `if (activity.isPendingSync) Icon(Icons.sync, ...)` from `_buildContent()`.
    - Add the sync badge to the header Row (`_buildHeader`) at the end, BEFORE the status badge. Place it between the Expanded name column and the status badge:
       ```dart
       // In _buildHeader, after the Expanded column and before _buildStatusBadge:
       _buildSyncBadge(context, ref, activity.id),
       const SizedBox(width: 8),
       _buildStatusBadge(theme),
       ```
    - Add all required imports: `flutter_riverpod`, `go_router`, `sync_status_badge.dart`, `sync_providers.dart`.
  </action>
  <verify>Run `flutter analyze` and confirm no errors. Verify that all three card files import `syncQueueEntityStatusMapProvider` and no longer use only `isPendingSync` as the sole badge source.</verify>
  <done>
    - CustomerCard shows queue-aware badge (pending/failed/dead letter) with tap navigation for failed states
    - PipelineCard shows queue-aware badge with tap navigation
    - ActivityCard uses SyncStatusBadge in header row instead of raw Icons.sync in content area, with queue-aware status and tap navigation
  </done>
</task>

<task type="auto">
  <name>Task 2: Update HVC, Broker, Referral, MeetingCard, and KeyPerson cards with sync queue badges</name>
  <files>
    lib/presentation/widgets/hvc/hvc_card.dart
    lib/presentation/widgets/broker/broker_card.dart
    lib/presentation/widgets/referral/referral_card.dart
    lib/presentation/screens/cadence/widgets/meeting_card.dart
    lib/presentation/screens/customer/customer_detail_screen.dart
    lib/presentation/screens/hvc/hvc_detail_screen.dart
    lib/presentation/screens/broker/broker_detail_screen.dart
  </files>
  <action>
    Apply the same badge pattern from Task 1 to the remaining entity cards:

    **HvcCard** (`hvc_card.dart`):
    - Read current file. Already has SyncStatusBadge for pending state.
    - Replace pending-only badge with full queue-aware badge using `syncQueueEntityStatusMapProvider`.
    - If StatelessWidget, convert to ConsumerWidget.
    - Add `go_router` and `sync_providers.dart` imports.

    **BrokerCard** (`broker_card.dart`):
    - Read current file. Already has SyncStatusBadge showing synced+pending.
    - Replace with queue-aware badge. Per locked decision, no badge = synced (don't show synced badge).
    - If StatelessWidget, convert to ConsumerWidget.
    - Add required imports.

    **ReferralCard** (`referral_card.dart`):
    - Read current file. Already has pending-only badge.
    - Replace with queue-aware badge.
    - If StatelessWidget, convert to ConsumerWidget.
    - Add required imports.

    **MeetingCard** (`meeting_card.dart`):
    - Read current file. NO sync badge currently.
    - Convert to ConsumerWidget.
    - Add sync badge to the header Row, after the Expanded column containing title/facilitator and before the status badge. Use `meeting.id` as the entity ID.
    - Add all required imports.

    **KeyPerson cards** (private widgets in detail screens):
    - These are `_KeyPersonCard` widgets inside `customer_detail_screen.dart`, `hvc_detail_screen.dart`, and `broker_detail_screen.dart`.
    - Each `_KeyPersonCard` is a private StatelessWidget or similar. Convert to use `Consumer` widget inline (since they're private and can't easily be ConsumerWidgets without the ref).
    - Alternative: wrap the sync badge portion in a `Consumer` widget to get `ref` access.
    - Add the sync badge to the KeyPerson card's Row or header area using the key person's ID.
    - Pattern for inline Consumer:
      ```dart
      Consumer(
        builder: (context, ref, _) {
          return _buildSyncBadge(context, ref, keyPerson.id);
        },
      )
      ```
      Or if the parent widget is already a ConsumerWidget, just pass ref down.
    - Add required imports to the detail screen files.

    For ALL cards, use the same badge builder pattern established in Task 1:
    - Look up entity ID in `syncQueueEntityStatusMapProvider` map
    - Fall back to entity's `isPendingSync` field if not in map
    - No badge for synced state
    - Tappable failed/dead letter badges navigate to `/home/sync-queue?entityId={id}`
    - Badge position: top right corner of card header row (consistent placement)
  </action>
  <verify>Run `flutter analyze` and confirm no errors across all 7 modified files. Verify each card widget references `syncQueueEntityStatusMapProvider`.</verify>
  <done>
    - HvcCard shows queue-aware badge with tap navigation
    - BrokerCard shows queue-aware badge (no synced badge per locked decision)
    - ReferralCard shows queue-aware badge with tap navigation
    - MeetingCard has new sync badge (previously had none) with tap navigation
    - KeyPerson cards in all 3 detail screens show queue-aware badges with tap navigation
    - All 8 syncable entity card types have consistent badge behavior
  </done>
</task>

</tasks>

<verification>
1. `flutter analyze` passes with no errors
2. All 8 entity card types (Customer, Pipeline, Activity, HVC, Broker, Referral, MeetingCard, KeyPerson) reference `syncQueueEntityStatusMapProvider`
3. No card shows a "synced" badge -- only problem states (pending, failed, dead letter)
4. ActivityCard no longer has raw `Icons.sync` icon in content area
5. Failed/dead letter badges in all cards use `GestureDetector` with `context.push('/home/sync-queue?entityId=...')`
</verification>

<success_criteria>
- All 8 entity card types show sync status badges for problem states only
- Activity card migrated from raw icon to SyncStatusBadge component
- Failed/dead letter badges are tappable and navigate to filtered sync queue
- Badge position is consistently in the top-right of card header rows
- Badges update reactively via the Drift-backed batch stream provider
</success_criteria>

<output>
After completion, create `.planning/phases/07-offline-ux-polish/07-02-SUMMARY.md`
</output>
