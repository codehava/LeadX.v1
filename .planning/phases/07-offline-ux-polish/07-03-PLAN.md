---
phase: 07-offline-ux-polish
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - lib/presentation/screens/home/tabs/dashboard_tab.dart
  - lib/presentation/screens/sync/sync_queue_screen.dart
  - lib/config/routes/app_router.dart
autonomous: true
requirements:
  - UX-03
  - UX-04

must_haves:
  truths:
    - "Dashboard displays 'Terakhir sinkronisasi: X menit lalu' timestamp that updates after each sync"
    - "Staleness text turns amber/orange when last sync was more than 1 hour ago"
    - "Sync queue screen accepts entityId query parameter and filters items to that entity"
    - "Navigating to sync queue with entityId from a card badge shows only that entity's queue items"
  artifacts:
    - path: "lib/presentation/screens/home/tabs/dashboard_tab.dart"
      provides: "Last synced timestamp display in welcome card with staleness color"
      contains: "lastSyncTimestampProvider"
    - path: "lib/presentation/screens/sync/sync_queue_screen.dart"
      provides: "Entity ID filter support via constructor parameter"
      contains: "entityId"
    - path: "lib/config/routes/app_router.dart"
      provides: "Query parameter parsing for sync-queue route"
      contains: "entityId"
  key_links:
    - from: "lib/presentation/screens/home/tabs/dashboard_tab.dart"
      to: "lib/presentation/providers/sync_providers.dart"
      via: "ref.watch(lastSyncTimestampProvider)"
      pattern: "lastSyncTimestampProvider"
    - from: "lib/config/routes/app_router.dart"
      to: "lib/presentation/screens/sync/sync_queue_screen.dart"
      via: "state.uri.queryParameters['entityId'] passed to SyncQueueScreen"
      pattern: "entityId"
---

<objective>
Add staleness display to dashboard and enable entity-filtered navigation to sync queue screen.

Purpose: Gives field reps a clear "Last synced" indicator on their home screen with visual warning when data is stale. Completes the failed badge tap-to-navigate flow by making the sync queue screen accept entity ID filters.

Output: Dashboard staleness display with 1-hour amber threshold, sync queue screen with entity ID filtering.
</objective>

<execution_context>
@C:/Users/cartr/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/cartr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-offline-ux-polish/07-RESEARCH.md
@.planning/phases/07-offline-ux-polish/07-01-SUMMARY.md
@lib/presentation/screens/home/tabs/dashboard_tab.dart
@lib/presentation/screens/sync/sync_queue_screen.dart
@lib/config/routes/app_router.dart
@lib/presentation/providers/sync_providers.dart
@lib/core/utils/format_last_sync.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add staleness display to dashboard welcome card</name>
  <files>
    lib/presentation/screens/home/tabs/dashboard_tab.dart
  </files>
  <action>
    Add "Last synced" timestamp to the dashboard welcome card with staleness color warning.

    1. Add imports:
       - `import '../../../../presentation/providers/sync_providers.dart';` (for `lastSyncTimestampProvider`)
       - `import '../../../../core/utils/format_last_sync.dart';` (for `formatLastSync`)
       (Adjust relative paths as needed from the dashboard_tab.dart location.)

    2. The dashboard is a `ConsumerWidget` so `ref` is available.

    3. In the `build()` method, watch the last sync timestamp:
       ```dart
       final lastSyncAsync = ref.watch(lastSyncTimestampProvider);
       ```

    4. Add the staleness indicator to the welcome Card, below the existing "Hari ini adalah waktu yang tepat untuk closing!" text. Inside the Card's Column children, add:
       ```dart
       const SizedBox(height: 8),
       // Last synced timestamp with staleness warning
       lastSyncAsync.when(
         data: (lastSync) {
           final text = formatLastSync(lastSync);
           final isStale = lastSync != null &&
               DateTime.now().difference(lastSync) > const Duration(hours: 1);

           return Row(
             children: [
               Icon(
                 Icons.sync,
                 size: 14,
                 color: isStale ? Colors.orange.shade700 : theme.colorScheme.outline,
               ),
               const SizedBox(width: 4),
               Text(
                 text,
                 style: theme.textTheme.bodySmall?.copyWith(
                   fontSize: 12,
                   color: isStale ? Colors.orange.shade700 : theme.colorScheme.outline,
                 ),
               ),
             ],
           );
         },
         loading: () => const SizedBox.shrink(),
         error: (_, __) => const SizedBox.shrink(),
       ),
       ```

    **Staleness threshold: 1 hour** (Claude's discretion per research recommendation). After 1 hour without sync, the text and icon turn amber/orange to draw attention without being alarming.

    **Display location: Dashboard only** (Claude's discretion per research recommendation). The dashboard welcome card is the natural "status overview" screen. The shell app bar sync button already provides glanceable sync awareness on all screens.
  </action>
  <verify>Run `flutter analyze` and confirm no errors in dashboard_tab.dart. Verify that `lastSyncTimestampProvider` and `formatLastSync` are properly imported and used.</verify>
  <done>Dashboard welcome card shows "Terakhir sinkronisasi: X menit lalu" text below the greeting. Text turns amber/orange after 1 hour without sync. Shows "Belum pernah sinkronisasi" if no sync has occurred.</done>
</task>

<task type="auto">
  <name>Task 2: Add entity ID filter to sync queue screen and route</name>
  <files>
    lib/presentation/screens/sync/sync_queue_screen.dart
    lib/config/routes/app_router.dart
  </files>
  <action>
    **1. Update SyncQueueScreen to accept entityId parameter:**

    Modify `SyncQueueScreen` to accept an optional `entityId` parameter:
    ```dart
    class SyncQueueScreen extends ConsumerStatefulWidget {
      const SyncQueueScreen({super.key, this.entityId});

      /// Optional entity ID to filter queue items to a specific entity.
      /// When set, only shows items matching this entity ID.
      final String? entityId;

      @override
      ConsumerState<SyncQueueScreen> createState() => _SyncQueueScreenState();
    }
    ```

    In the `_SyncQueueScreenState`, modify the item loading logic. The screen currently uses `FutureBuilder` with `syncQueueDataSource.getPendingItems()` or similar. Find where items are loaded/filtered and add entity filtering:

    - If `widget.entityId != null`, filter the loaded items to only show those where `item.entityId == widget.entityId`.
    - Apply the filter AFTER the existing status filter (gagal/semua), so both filters compose.
    - Pattern:
      ```dart
      // After getting items list and applying status filter:
      var filteredItems = items;
      if (widget.entityId != null) {
        filteredItems = filteredItems
            .where((item) => item.entityId == widget.entityId)
            .toList();
      }
      ```

    - Update the AppBar title to show filter context when entityId is set:
      ```dart
      title: Text(widget.entityId != null
          ? 'Sinkronisasi (filtered)'
          : 'Sinkronisasi'),
      ```

    - Add a "Show all" action in the AppBar when filtered, so user can clear the filter:
      ```dart
      if (widget.entityId != null)
        TextButton(
          onPressed: () => context.push('/home/sync-queue'),
          child: const Text('Lihat Semua'),
        ),
      ```

    **2. Update app_router.dart to pass entityId query parameter:**

    Find the sync-queue route (at `path: 'sync-queue'`). Update the builder to parse the query parameter:
    ```dart
    GoRoute(
      path: 'sync-queue',
      name: 'syncQueue',
      builder: (context, state) {
        final entityId = state.uri.queryParameters['entityId'];
        return ResponsiveShell(
          currentRoute: state.matchedLocation,
          child: SyncQueueScreen(entityId: entityId),
        );
      },
    ),
    ```
    Note: The current builder wraps SyncQueueScreen in ResponsiveShell. Preserve that wrapping, just add the entityId parameter.
  </action>
  <verify>Run `flutter analyze` and confirm no errors. Verify that the SyncQueueScreen constructor accepts `entityId` and the route builder passes it. Verify the `context.push('/home/sync-queue?entityId=xxx')` pattern from card badges (Plan 02) would correctly land on a filtered view.</verify>
  <done>
    - SyncQueueScreen accepts optional `entityId` parameter and filters items when set
    - Route builder parses `entityId` from query parameters and passes to screen
    - AppBar shows "Lihat Semua" button when filter is active
    - The full flow works: card badge tap -> `/home/sync-queue?entityId=xxx` -> filtered sync queue view
  </done>
</task>

</tasks>

<verification>
1. `flutter analyze` passes with no errors
2. Dashboard welcome card contains `lastSyncTimestampProvider` watch and `formatLastSync` call
3. Staleness color changes after 1-hour threshold (visual: amber/orange vs grey)
4. SyncQueueScreen has `entityId` constructor parameter
5. app_router.dart passes `state.uri.queryParameters['entityId']` to SyncQueueScreen
6. Filtered sync queue shows "Lihat Semua" action to clear filter
</verification>

<success_criteria>
- Dashboard displays global "Last synced" timestamp with Indonesian-locale relative text
- Staleness warning (amber text) appears when sync is more than 1 hour old
- Sync queue screen filters to specific entity when navigated with entityId parameter
- Full navigation flow works: failed badge tap on card -> filtered sync queue
</success_criteria>

<output>
After completion, create `.planning/phases/07-offline-ux-polish/07-03-SUMMARY.md`
</output>
