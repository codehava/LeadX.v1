---
phase: 09-admin-dashboard-features
plan: 02
type: execute
wave: 2
depends_on:
  - 09-01
files_modified:
  - lib/presentation/screens/admin/users/user_detail_screen.dart
  - lib/presentation/screens/admin/users/user_list_screen.dart
  - lib/presentation/screens/home/widgets/quick_add_sheet.dart
  - lib/presentation/screens/home/tabs/activities_tab.dart
  - lib/presentation/screens/activity/immediate_activity_sheet.dart
autonomous: false
requirements:
  - FEAT-06
  - FEAT-07

must_haves:
  truths:
    - "Admin tapping delete on user detail screen sees confirmation dialog with RM picker and can execute deletion"
    - "Delete button is disabled/hidden when offline or for current user (self-delete blocked)"
    - "After successful deletion, admin is navigated back and user list refreshes without the deleted user"
    - "Admin can toggle a filter on user list to show deleted users"
    - "QuickAddSheet dead code is removed from the codebase"
  artifacts:
    - path: "lib/presentation/screens/admin/users/user_detail_screen.dart"
      provides: "Delete confirmation dialog with RM picker, online guard, self-delete guard"
      contains: "deleteUser"
    - path: "lib/presentation/screens/admin/users/user_list_screen.dart"
      provides: "Toggle filter to show/hide deleted users"
      contains: "includeDeleted"
  key_links:
    - from: "lib/presentation/screens/admin/users/user_detail_screen.dart"
      to: "lib/presentation/providers/admin_user_providers.dart"
      via: "calls notifier.deleteUser(userId, newRmId)"
      pattern: "deleteUser"
    - from: "lib/presentation/screens/admin/users/user_detail_screen.dart"
      to: "lib/presentation/providers/sync_providers.dart"
      via: "reads connectivityStreamProvider for online guard"
      pattern: "connectivityStreamProvider"
---

<objective>
Implement the admin user deletion UI (confirmation dialog with RM picker, online-only guard, self-delete prevention) and the user list deleted filter, plus clean up FEAT-07 dead code.

Purpose: FEAT-06 needs the UI layer to allow admins to trigger user deletion via the Edge Function wired in Plan 01. FEAT-07 is already functionally complete but has dead code (QuickAddSheet) that should be removed.

Output: Working delete flow on user detail screen, user list filter for deleted users, and removal of QuickAddSheet.
</objective>

<execution_context>
@C:/Users/cartr/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/cartr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-admin-dashboard-features/09-CONTEXT.md
@.planning/phases/09-admin-dashboard-features/09-RESEARCH.md
@.planning/phases/09-admin-dashboard-features/09-01-SUMMARY.md
@lib/presentation/screens/admin/users/user_detail_screen.dart
@lib/presentation/screens/admin/users/user_list_screen.dart
@lib/presentation/providers/admin_user_providers.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement delete confirmation dialog with RM picker and online guard on user detail screen, plus user list deleted filter</name>
  <files>
    lib/presentation/screens/admin/users/user_detail_screen.dart
    lib/presentation/screens/admin/users/user_list_screen.dart
  </files>
  <action>
**User detail screen (`user_detail_screen.dart`):**

Replace the existing `_handleDelete` method (currently shows TODO toast at ~line 364) with a working implementation:

1. **Online guard:** Read `connectivityStreamProvider` (from `sync_providers.dart`). If `valueOrNull ?? false` is false, show SnackBar with `backgroundColor: Colors.orange` and message "Hapus pengguna membutuhkan koneksi internet" (Indonesian per UI convention), then return.

2. **Self-delete guard:** Read `currentUserProvider` to get current user ID. If `currentUser?.id == user.id`, show SnackBar with `backgroundColor: Colors.red` and message "Tidak dapat menghapus akun sendiri", then return.

3. **Show confirmation dialog** with RM reassignment picker. Use `showDialog` returning `AlertDialog`:
   - Title: `Text('Hapus Pengguna')`
   - Content: A `StatefulBuilder` wrapping a `Column(mainAxisSize: MainAxisSize.min)` with:
     - `Text('Hapus ${user.name}? Semua data akan dipindahkan ke RM pengganti.')` -- explanation text
     - `SizedBox(height: 16)`
     - `SearchableDropdown<String>` for selecting replacement RM:
       - `label: 'RM Pengganti'`
       - `hint: 'Pilih RM pengganti...'`
       - `modalTitle: 'Pilih RM Pengganti'`
       - Items sourced from `allUsersProvider` (read the list), filtered to exclude the user being deleted and only include active users
       - `onChanged: (value) => setState(() => selectedRmId = value)` using StatefulBuilder's setState
   - Actions:
     - Cancel: `TextButton(onPressed: () => context.pop(), child: Text('Batal'))`
     - Delete: `FilledButton` with red background, `onPressed: selectedRmId != null ? () => context.pop(selectedRmId) : null` (disabled until RM selected), child: `Text('Hapus')`

4. **Execute deletion:** If dialog returns a non-null `selectedRmId`:
   - Show loading indicator (CircularProgressIndicator in a non-dismissable dialog, or set a loading state)
   - Call `ref.read(adminUserNotifierProvider.notifier).deleteUser(user.id, selectedRmId)` (or equivalent provider name -- check actual notifier provider name)
   - On success: dismiss loading, show SnackBar "Pengguna berhasil dihapus", navigate back to user list via `context.go('/admin/users')` or `context.pop()`
   - On error (catch Exception): dismiss loading, show SnackBar with error message and red background

5. **Also:** If the user being viewed has `isDeleted == true`, hide or disable the delete button in the app bar (already deleted users should not show the delete action).

**User list screen (`user_list_screen.dart`):**

Add a toggle filter for showing deleted users:

1. Add a state variable `_showDeleted = false` (or use a `StateProvider` if the screen is stateless).
2. Add a filter chip or toggle button in the app bar actions (e.g., `FilterChip` or `IconButton` with `Icons.person_off` tooltip "Tampilkan pengguna dihapus").
3. When toggled on, the user list query should pass `includeDeleted: true` to the users provider/repository call. The `allUsersProvider` likely needs to accept this parameter -- if it is a simple provider, consider adding a family parameter or a `StateProvider<bool>` that the existing provider watches.
4. Deleted users in the list should have a visual indicator (e.g., `Opacity(opacity: 0.5)` or a "Dihapus" chip/badge next to their name, or greyed-out styling).
5. Tapping a deleted user should still navigate to their detail screen (for viewing historical info), but the detail screen should show the delete button disabled/hidden (handled above).

Keep all UI strings in Indonesian to match project convention.
  </action>
  <verify>
1. `flutter analyze` passes.
2. Grep confirms `user_detail_screen.dart` contains `deleteUser` call and `connectivityStreamProvider` check.
3. Grep confirms `user_detail_screen.dart` contains `SearchableDropdown` for RM picker.
4. Grep confirms `user_detail_screen.dart` no longer has "belum diimplementasikan" TODO toast.
5. Grep confirms `user_list_screen.dart` contains a deleted users filter toggle.
  </verify>
  <done>
Admin can tap delete on user detail, sees online guard, self-delete guard, and confirmation dialog with RM picker using SearchableDropdown. After confirming, Edge Function executes and user list refreshes. User list has toggle to show/hide deleted users with visual indicator.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove QuickAddSheet dead code and add clarifying comments (FEAT-07 cleanup)</name>
  <files>
    lib/presentation/screens/home/widgets/quick_add_sheet.dart
    lib/presentation/screens/home/tabs/activities_tab.dart
    lib/presentation/screens/activity/immediate_activity_sheet.dart
  </files>
  <action>
**Delete dead code:**

Delete the file `lib/presentation/screens/home/widgets/quick_add_sheet.dart` entirely. It is confirmed dead code -- only self-references, no imports from any other file.

**Add clarifying comments (`activities_tab.dart`):**

Find the flash FAB that navigates to `ActivityFormScreen` with `immediate=true`. Add a doc comment above it or near the relevant code block:
```dart
// Quick activity logging entry point (Activities tab).
// Uses ActivityFormScreen in immediate mode for dashboard/tab-level quick logging.
// This is SEPARATE from ImmediateActivitySheet, which is used for entity-specific
// immediate activities launched from customer/HVC/broker detail screens.
```

**Add clarifying comments (`immediate_activity_sheet.dart`):**

Add a doc comment to the class:
```dart
/// Entity-specific immediate activity sheet.
///
/// Used from customer, HVC, and broker detail screens to log an immediate
/// activity pre-associated with that entity. This is SEPARATE from the
/// dashboard/activities-tab quick logging flow, which uses ActivityFormScreen
/// in immediate mode (navigated via the "Log Aktivitas" button or flash FAB).
```

These comments clarify the two separate entry points per CONTEXT.md locked decision.
  </action>
  <verify>
1. `lib/presentation/screens/home/widgets/quick_add_sheet.dart` does NOT exist (deleted).
2. `flutter analyze` passes (no broken imports since QuickAddSheet had no external consumers).
3. Grep confirms `activities_tab.dart` contains the clarifying comment about separate entry points.
4. Grep confirms `immediate_activity_sheet.dart` contains the clarifying doc comment.
  </verify>
  <done>
QuickAddSheet dead code is removed. Both quick activity entry points (ActivityFormScreen immediate mode and ImmediateActivitySheet) have clarifying comments explaining their separate purposes and entry points.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify admin user deletion flow</name>
  <what-built>Complete admin user deletion flow: Edge Function for server-side data reassignment, confirmation dialog with RM picker, online-only guard, self-delete prevention, user list filter for deleted users, and FEAT-07 dead code cleanup.</what-built>
  <how-to-verify>
1. Deploy the Edge Function: `supabase functions deploy admin-delete-user`
2. Run the app: `flutter run -d chrome`
3. Log in as an admin user
4. Navigate to Admin > Users > select a test user
5. Tap the delete button:
   - Verify the confirmation dialog appears with RM reassignment picker (SearchableDropdown)
   - Verify the "Hapus" button is disabled until an RM is selected
   - Select a replacement RM and tap "Hapus"
   - Verify success toast appears and user list refreshes without the deleted user
6. Verify the deleted user cannot log in (auth account banned)
7. On the user list screen, toggle the "show deleted" filter and verify the deleted user appears with visual indicator
8. Try deleting yourself -- verify "Tidak dapat menghapus akun sendiri" error appears
9. Go offline (disconnect network), try delete -- verify "Hapus pengguna membutuhkan koneksi internet" error appears
10. Verify dashboard "Log Aktivitas" button still works (FEAT-07 unchanged)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. User detail screen has working delete flow with online guard, self-delete guard, and RM picker dialog.
2. User list screen has toggle for showing/hiding deleted users.
3. QuickAddSheet file is deleted from codebase.
4. Clarifying comments added to ImmediateActivitySheet and activities_tab.
5. `flutter analyze` passes.
6. All Indonesian UI strings consistent.
</verification>

<success_criteria>
- Admin can delete a user via confirmation dialog with RM picker
- Online guard shows Indonesian error when offline
- Self-delete guard shows Indonesian error for own account
- Delete button disabled/hidden for already-deleted users
- User list has toggle to show deleted users with visual indicator
- QuickAddSheet file deleted (confirmed dead code)
- Clarifying comments on both quick activity entry points
- All code compiles and passes analysis
</success_criteria>

<output>
After completion, create `.planning/phases/09-admin-dashboard-features/09-02-SUMMARY.md`
</output>
