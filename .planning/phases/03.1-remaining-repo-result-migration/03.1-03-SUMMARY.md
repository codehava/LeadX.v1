---
phase: 03.1-remaining-repo-result-migration
plan: 03
subsystem: auth
tags: [result, sealed-class, pattern-matching, auth, supabase, mocktail]

# Dependency graph
requires:
  - phase: 03-error-classification-recovery
    provides: "Sealed Result<T> type, mapException(), runCatching() helpers"
provides:
  - "AuthRepository interface and impl returning Result<T> instead of Either<Failure, T>"
  - "All 6 auth consumer files using switch/Result API instead of .fold()/.isLeft()"
  - "Auth test suite rewritten with mocktail Fakes for Supabase types"
  - "FakeAuthRepository in test_helpers returning Result<T>"
affects: [03.1-05-cleanup, dartz-removal]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Fake-based testing for Supabase types that implement Future (FakeSupabaseClient, FakeQueryChain)"
    - "switch pattern matching on Result for auth consumers"
    - ".isFailure/.failureOrNull replacing .isLeft()/.fold() for intermediate checks"

key-files:
  created: []
  modified:
    - lib/domain/repositories/auth_repository.dart
    - lib/data/repositories/auth_repository_impl.dart
    - lib/presentation/providers/auth_providers.dart
    - lib/presentation/providers/profile_providers.dart
    - lib/presentation/screens/auth/reset_password_screen.dart
    - lib/presentation/screens/auth/forgot_password_screen.dart
    - lib/presentation/screens/profile/edit_profile_screen.dart
    - lib/presentation/screens/profile/change_password_screen.dart
    - test/data/repositories/auth_repository_impl_test.dart
    - test/helpers/test_helpers.dart

key-decisions:
  - "Preserved custom _mapAuthError() helper with Indonesian-locale messages instead of replacing with generic mapException"
  - "Rewrote auth test suite from mockito to mocktail with custom Fakes to handle Supabase Future-implementing types"
  - "Used FakeSupabaseClient + FakeQueryChain approach since PostgrestBuilder implements Future and breaks mocktail when/thenReturn"

patterns-established:
  - "Fake-based testing pattern for Supabase: FakeSupabaseClient, FakeQueryChain, _FakeTransformBuilder delegate to proper Future"
  - "Profile providers multi-step flow: nested switch on Result for upload-then-update sequences"

# Metrics
duration: 35min
completed: 2026-02-14
---

# Phase 3.1 Plan 03: AuthRepository Migration Summary

**AuthRepository (11 methods) migrated from dartz Either to sealed Result with preserved _mapAuthError, 6 consumer files rewritten from .fold()/.isLeft() to switch/Result, auth test suite rebuilt with mocktail Fakes**

## Performance

- **Duration:** ~35 min
- **Started:** 2026-02-13T21:27:00Z
- **Completed:** 2026-02-13T22:02:42Z
- **Tasks:** 2
- **Files modified:** 10

## Accomplishments
- AuthRepository interface (11 methods) and implementation migrated to Result<T> with custom _mapAuthError preserved
- All 6 auth consumer files migrated: 9 .fold() + 3 .isLeft() call sites replaced with switch/Result API
- Auth test suite (17 tests) completely rewritten from broken mockito to working mocktail with custom Fake classes
- FakeAuthRepository in test_helpers.dart updated with all method stubs returning Result<T>

## Task Commits

Each task was committed atomically:

1. **Task 1: Migrate AuthRepository interface, impl, and test files** - `4f02740` (feat)
2. **Task 2: Migrate all 6 auth consumer files from .fold()/.isLeft() to switch/Result API** - `4a835a4` (feat)

**Plan metadata:** (pending)

## Files Created/Modified
- `lib/domain/repositories/auth_repository.dart` - Auth repository interface with Result<T> return types
- `lib/data/repositories/auth_repository_impl.dart` - Auth repository impl with Result.success/Result.failure + preserved _mapAuthError
- `lib/presentation/providers/auth_providers.dart` - LoginNotifier.login() uses switch on Result
- `lib/presentation/providers/profile_providers.dart` - Most complex: 4 .fold() + 3 .isLeft() replaced with switch/.isFailure/.failureOrNull
- `lib/presentation/screens/auth/reset_password_screen.dart` - switch on Result for password reset
- `lib/presentation/screens/auth/forgot_password_screen.dart` - switch on Result for password reset request
- `lib/presentation/screens/profile/edit_profile_screen.dart` - switch on Result for profile update
- `lib/presentation/screens/profile/change_password_screen.dart` - switch on Result for password change
- `test/data/repositories/auth_repository_impl_test.dart` - Complete rewrite: mockito to mocktail with Fake classes
- `test/helpers/test_helpers.dart` - FakeAuthRepository returns Result<T>, added missing method stubs

## Decisions Made
- Preserved custom `_mapAuthError()` helper -- it has Indonesian-locale error messages for auth (bad credentials, email taken, weak password, etc.). Not replaced by generic `mapException()`.
- Rewrote auth test suite entirely from mockito to mocktail -- mockito-generated mocks had stale type signatures and Supabase's `PostgrestBuilder implements Future<T>` breaks mockito's thenReturn.
- Created `FakeSupabaseClient`, `FakeQueryChain`, and `_FakeTransformBuilder` that delegates to a proper `Future` -- this avoids the Future-implementing type problem entirely.
- `test/helpers/customer_test_helpers.dart` left unchanged -- still uses dartz because `CustomerRepository` interface hasn't been migrated yet (will be cleaned up in 03.1-05).

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Pre-existing broken auth test suite completely rewritten**
- **Found during:** Task 1 (auth test migration)
- **Issue:** Tests had multiple pre-existing failures: (a) `AppAuthStateUnauthenticated`/`AppAuthStateAuthenticated` types don't exist (Freezed generates private types), (b) mockito-generated mocks had stale type signatures incompatible with newer Supabase library, (c) `Session` constructor had removed `expiresAt` parameter, (d) test expected null for failed fetch but implementation has offline fallback returning minimal user
- **Fix:** Complete rewrite from mockito to mocktail with custom Fake classes. Fixed Freezed type assertions to use `state.when()`. Removed obsolete `expiresAt`. Fixed test expectations for offline fallback behavior.
- **Files modified:** `test/data/repositories/auth_repository_impl_test.dart`
- **Verification:** All 17 tests pass
- **Committed in:** `4f02740` (Task 1 commit)

**2. [Rule 3 - Blocking] FakeAuthRepository missing method stubs**
- **Found during:** Task 1 (test helper migration)
- **Issue:** `FakeAuthRepository` in test_helpers.dart was missing stubs for `refreshCurrentUser`, `updateProfile`, `uploadProfilePhoto`, `removeProfilePhoto` -- methods added to interface after the fake was written
- **Fix:** Added all missing method stubs with `Result.success(...)` return values, added `import 'dart:typed_data'` for Uint8List
- **Files modified:** `test/helpers/test_helpers.dart`
- **Verification:** Compiles without error, test suite passes
- **Committed in:** `4f02740` (Task 1 commit)

**3. [Rule 1 - Bug] Removed unused import in change_password_screen.dart**
- **Found during:** Task 2 (consumer migration)
- **Issue:** `auth_repository.dart` was imported but no longer referenced after removing `.fold()` which used the `Failure` type directly
- **Fix:** Removed unused import
- **Files modified:** `lib/presentation/screens/profile/change_password_screen.dart`
- **Verification:** `flutter analyze` clean
- **Committed in:** `4a835a4` (Task 2 commit)

---

**Total deviations:** 3 auto-fixed (2 Rule 1 bugs, 1 Rule 3 blocking)
**Impact on plan:** All auto-fixes necessary for correctness. The test rewrite was substantial but required -- the tests were already broken before this migration. No scope creep.

## Issues Encountered
- Supabase's `PostgrestBuilder implements Future<T>` makes it unmockable with standard mock libraries (both mockito and mocktail). Solution: Custom Fake classes that override `from()` directly and delegate Future methods to a proper `Future` instance rather than implementing them on the Fake.
- `_FakeTransformBuilder` initially threw errors synchronously inside `then()`, causing test framework issues and 5-second timeouts. Fixed by creating a proper `Future` in the constructor and delegating all Future interface methods to it.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness
- Auth is the largest and most complex repository migration -- completing it clears the hardest case
- Only plan 03.1-05 (final cleanup) remains for phase 3.1
- The Fake-based testing pattern established here can be reused if other Supabase-dependent tests need migration
- `test/helpers/customer_test_helpers.dart` still uses dartz -- will be cleaned in 03.1-05

## Self-Check: PASSED

All 10 modified files verified present. Both task commits (4f02740, 4a835a4) verified in git log. SUMMARY.md created.

---
*Phase: 03.1-remaining-repo-result-migration*
*Completed: 2026-02-14*
