---
phase: 03.1-remaining-repo-result-migration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/domain/repositories/admin_master_data_repository.dart
  - lib/data/repositories/admin_master_data_repository_impl.dart
  - lib/domain/repositories/pipeline_referral_repository.dart
  - lib/data/repositories/pipeline_referral_repository_impl.dart
  - lib/presentation/screens/admin/master_data/master_data_form_screen.dart
  - lib/presentation/screens/admin/master_data/master_data_list_screen.dart
  - lib/presentation/providers/pipeline_referral_providers.dart
  - lib/presentation/screens/customer/key_person_form_sheet.dart
autonomous: true

must_haves:
  truths:
    - "AdminMasterDataRepository interface and impl return Result<T> instead of Either<Failure, T>"
    - "PipelineReferralRepository interface and impl return Result<T> instead of Either<Failure, T>"
    - "All .fold() call sites in master_data screens and pipeline_referral_providers use switch pattern matching"
    - "All .isRight() call sites in pipeline_referral_providers use .isSuccess"
    - "key_person_form_sheet.dart pre-existing bug fixed -- .fold() replaced with switch on Result"
    - "flutter analyze passes with no errors on modified files"
  artifacts:
    - path: "lib/domain/repositories/admin_master_data_repository.dart"
      provides: "AdminMasterData repository interface with Result<T>"
      contains: "Result<"
    - path: "lib/data/repositories/admin_master_data_repository_impl.dart"
      provides: "AdminMasterData repository impl using runCatching/mapException"
      contains: "runCatching"
    - path: "lib/domain/repositories/pipeline_referral_repository.dart"
      provides: "PipelineReferral repository interface with Result<T>"
      contains: "Result<"
    - path: "lib/data/repositories/pipeline_referral_repository_impl.dart"
      provides: "PipelineReferral repository impl using runCatching/mapException"
      contains: "runCatching"
    - path: "lib/presentation/screens/customer/key_person_form_sheet.dart"
      provides: "Fixed key_person_form_sheet with switch pattern matching"
      contains: "case Success"
  key_links:
    - from: "lib/presentation/providers/pipeline_referral_providers.dart"
      to: "PipelineReferralRepository"
      via: "switch pattern matching + .isSuccess replacing .isRight()"
      pattern: "case Success|case ResultFailure|isSuccess"
    - from: "lib/presentation/screens/admin/master_data/master_data_form_screen.dart"
      to: "AdminMasterDataRepository"
      via: "switch pattern matching on Result"
      pattern: "case Success|case ResultFailure"
---

<objective>
Migrate AdminMasterData (~14 methods) and PipelineReferral (6 methods) repositories from dartz Either to sealed Result, fix key_person_form_sheet.dart pre-existing bug, and update all consumer .fold()/.isRight() call sites.

Purpose: AdminMasterData is the highest method count of the simple repos (online-only, no tests). PipelineReferral has the unique `.isRight()` pattern requiring `.isSuccess` replacement. The key_person_form_sheet bug fix is a natural fit since it's the same mechanical migration.
Output: 4 repository files, 3 consumer files, and 1 bug fix file updated.
</objective>

<execution_context>
@C:/Users/cartr/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/cartr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.1-remaining-repo-result-migration/03.1-RESEARCH.md
@.planning/phases/03-error-classification-recovery/03-01-SUMMARY.md
@lib/core/errors/result.dart
@lib/core/errors/exception_mapper.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate AdminMasterDataRepository and PipelineReferralRepository to Result type</name>
  <files>
    lib/domain/repositories/admin_master_data_repository.dart
    lib/data/repositories/admin_master_data_repository_impl.dart
    lib/domain/repositories/pipeline_referral_repository.dart
    lib/data/repositories/pipeline_referral_repository_impl.dart
  </files>
  <action>
    **AdminMasterDataRepository (~14 Either methods):**

    1. Interface (`lib/domain/repositories/admin_master_data_repository.dart`):
       - Replace `import 'package:dartz/dartz.dart'` with `import '../../core/errors/result.dart'`
       - Change all `Future<Either<Failure, T>>` to `Future<Result<T>>`
       - Keep Failure import from failures.dart if still referenced

    2. Implementation (`lib/data/repositories/admin_master_data_repository_impl.dart`):
       - Replace dartz import with exception_mapper.dart and result.dart imports
       - This is online-only (direct Supabase remote calls, no local DB)
       - Use `runCatching` for all methods -- they are all simple remote calls with generic DatabaseFailure catch-all
       - Replace all `Left(DatabaseFailure(...))` and `Right(value)` patterns

    **PipelineReferralRepository (6 Either methods: createReferral, acceptReferral, rejectReferral, approveReferral, rejectAsManager, cancelReferral):**

    3. Interface (`lib/domain/repositories/pipeline_referral_repository.dart`):
       - Replace `import 'package:dartz/dartz.dart'` with `import '../../core/errors/result.dart'`
       - Change all `Future<Either<Failure, T>>` to `Future<Result<T>>`

    4. Implementation (`lib/data/repositories/pipeline_referral_repository_impl.dart`):
       - Replace dartz import with exception_mapper.dart and result.dart imports
       - This repo has VALIDATION logic (status checks before operations) -- use explicit try/catch + mapException for methods with not-found/validation: acceptReferral, rejectReferral, approveReferral, rejectAsManager, cancelReferral
       - Use `runCatching` for simple createReferral
       - Replace `Left(NotFoundFailure(...))` with `Result.failure(NotFoundFailure(...))`
       - Replace `Left(ValidationFailure(...))` with `Result.failure(ValidationFailure(...))`
       - Replace `Left(DatabaseFailure(...))` catch-all with `Result.failure(mapException(e, context: ...))`
       - Replace `Right(referral)` with `Result.success(referral)`
  </action>
  <verify>
    Run `flutter analyze` -- zero errors in the 4 modified repository files. Verify:
    - No `import 'package:dartz/dartz.dart'` in any of the 4 files
    - No `Left(` or `Right(` calls remain in the 2 impl files
  </verify>
  <done>
    AdminMasterDataRepository (~14 methods) and PipelineReferralRepository (6 methods) fully migrated from Either to Result at the interface and implementation level. flutter analyze clean on repository files.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate all consumer call sites and fix key_person_form_sheet bug</name>
  <files>
    lib/presentation/screens/admin/master_data/master_data_form_screen.dart
    lib/presentation/screens/admin/master_data/master_data_list_screen.dart
    lib/presentation/providers/pipeline_referral_providers.dart
    lib/presentation/screens/customer/key_person_form_sheet.dart
  </files>
  <action>
    **AdminMasterData consumers:**

    1. `master_data_form_screen.dart` (3 .fold() sites):
       - Replace each `.fold((failure) => ..., (value) => ...)` with switch pattern matching
       - Add `import '...core/errors/result.dart'` if not present
       - Remove dartz import if present

    2. `master_data_list_screen.dart` (1 .fold() site + direct dartz import):
       - Replace the 1 `.fold()` call with switch pattern matching
       - Remove `import 'package:dartz/dartz.dart'` (this file imports dartz directly per research)
       - Add result.dart import

    **PipelineReferral consumers:**

    3. `pipeline_referral_providers.dart` (6 .fold() + 6 .isRight() call sites):
       - Replace all 6 `.fold()` call sites with switch pattern matching
       - Replace all 6 `.isRight()` calls with `.isSuccess`
       - Remove dartz import, add result.dart import
       - This is the only file in the codebase using `.isRight()` pattern -- each instance checks if a referral operation succeeded before proceeding with next steps

    **Pre-existing bug fix:**

    4. `key_person_form_sheet.dart` (2 .fold() calls on Result type -- CURRENTLY BROKEN):
       - This file calls `.fold()` on `Result<KeyPerson>` from `CustomerRepository.updateKeyPerson()` and `addKeyPerson()` -- these methods were already migrated to Result in Phase 3 but this consumer was missed
       - Replace both `.fold()` calls with switch pattern matching:
         ```dart
         switch (result) {
           case Success(:final value):
             // existing success handler (Navigator.pop, etc.)
           case ResultFailure(:final failure):
             // existing failure handler (showSnackBar, etc.)
         }
         ```
       - Add `import '...core/errors/result.dart'` if not present
       - Remove dartz import if present
       - This fixes a pre-existing compilation error from Phase 3
  </action>
  <verify>
    Run `flutter analyze` -- zero errors in all 4 modified files. Specifically:
    - `grep -r "\.fold\(" lib/presentation/screens/admin/master_data/master_data_form_screen.dart lib/presentation/screens/admin/master_data/master_data_list_screen.dart lib/presentation/providers/pipeline_referral_providers.dart lib/presentation/screens/customer/key_person_form_sheet.dart` returns zero results
    - `grep -r "\.isRight\(\)" lib/presentation/providers/pipeline_referral_providers.dart` returns zero results
    - `grep -r "dartz" lib/presentation/screens/admin/master_data/master_data_list_screen.dart` returns zero results
  </verify>
  <done>
    4 .fold() sites in master_data screens, 6 .fold() + 6 .isRight() in pipeline_referral_providers, and 2 broken .fold() in key_person_form_sheet all replaced with switch/.isSuccess. Pre-existing key_person_form_sheet compilation error fixed. flutter analyze clean.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
- Run `flutter analyze` on the full project -- no new errors introduced
- Verify all 8 modified files have no dartz imports
- 2 repositories (20 methods total) now return Result<T> instead of Either<Failure, T>
- key_person_form_sheet.dart pre-existing bug is resolved (no more .fold() on Result)
</verification>

<success_criteria>
- AdminMasterData (~14) + PipelineReferral (6) = 20 methods migrated from Either to Result
- 16 .fold() + 6 .isRight() consumer call sites replaced across 4 consumer files
- key_person_form_sheet.dart pre-existing compilation error fixed
- Zero dartz imports in all 8 modified files
- flutter analyze clean
</success_criteria>

<output>
After completion, create `.planning/phases/03.1-remaining-repo-result-migration/03.1-02-SUMMARY.md`
</output>
