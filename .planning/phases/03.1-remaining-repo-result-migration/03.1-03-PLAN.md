---
phase: 03.1-remaining-repo-result-migration
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/domain/repositories/auth_repository.dart
  - lib/data/repositories/auth_repository_impl.dart
  - lib/presentation/providers/auth_providers.dart
  - lib/presentation/providers/profile_providers.dart
  - lib/presentation/screens/auth/reset_password_screen.dart
  - lib/presentation/screens/auth/forgot_password_screen.dart
  - lib/presentation/screens/profile/edit_profile_screen.dart
  - lib/presentation/screens/profile/change_password_screen.dart
  - test/data/repositories/auth_repository_impl_test.dart
  - test/helpers/test_helpers.dart
  - test/helpers/customer_test_helpers.dart
autonomous: true

must_haves:
  truths:
    - "AuthRepository interface and impl return Result<T> instead of Either<Failure, T>"
    - "Auth-specific _mapAuthError() helper preserved -- not replaced by generic mapException for auth errors"
    - "All .fold() and .isLeft() call sites in auth_providers, profile_providers, and 4 screen files use switch/Result API"
    - "auth_repository_impl_test.dart passes with Result-based assertions"
    - "FakeAuthRepository in test_helpers.dart returns Result<T>"
    - "flutter analyze and flutter test pass"
  artifacts:
    - path: "lib/domain/repositories/auth_repository.dart"
      provides: "Auth repository interface with Result<T>"
      contains: "Result<"
    - path: "lib/data/repositories/auth_repository_impl.dart"
      provides: "Auth repository impl with Result wrapping + preserved _mapAuthError"
      contains: "Result.failure"
    - path: "lib/presentation/providers/profile_providers.dart"
      provides: "Profile providers with .isFailure/.isSuccess instead of .isLeft()/.isRight()"
      contains: "isFailure"
    - path: "test/helpers/test_helpers.dart"
      provides: "FakeAuthRepository returning Result<T>"
      contains: "Result<"
  key_links:
    - from: "lib/presentation/providers/auth_providers.dart"
      to: "AuthRepository"
      via: "switch pattern matching on Result"
      pattern: "case Success|case ResultFailure"
    - from: "lib/presentation/providers/profile_providers.dart"
      to: "AuthRepository"
      via: ".isFailure + switch replacing .isLeft() + .fold()"
      pattern: "isFailure|case Success|case ResultFailure"
    - from: "test/data/repositories/auth_repository_impl_test.dart"
      to: "AuthRepositoryImpl"
      via: "Result-based assertions"
      pattern: "isA<Success>|isA<ResultFailure>"
---

<objective>
Migrate AuthRepository (11 methods) from dartz Either to sealed Result, update 6 consumer files with complex .fold()/.isLeft() patterns, and update 3 test/helper files. This is the most complex repo migration due to custom _mapAuthError helper and non-standard consumer patterns.

Purpose: Auth is the most complex migration -- it has the most consumer files (6), the only .isLeft() patterns in the codebase, the only test files needing updates, and a custom error mapping helper that must be preserved. Isolating it ensures focused attention.
Output: 11 files updated (1 interface, 1 impl, 6 consumers, 3 test/helper files).
</objective>

<execution_context>
@C:/Users/cartr/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/cartr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.1-remaining-repo-result-migration/03.1-RESEARCH.md
@.planning/phases/03-error-classification-recovery/03-01-SUMMARY.md
@lib/core/errors/result.dart
@lib/core/errors/exception_mapper.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate AuthRepository interface, implementation, and test files</name>
  <files>
    lib/domain/repositories/auth_repository.dart
    lib/data/repositories/auth_repository_impl.dart
    test/data/repositories/auth_repository_impl_test.dart
    test/helpers/test_helpers.dart
    test/helpers/customer_test_helpers.dart
  </files>
  <action>
    **AuthRepository interface:**

    1. `lib/domain/repositories/auth_repository.dart`:
       - Replace `import 'package:dartz/dartz.dart'` with `import '../../core/errors/result.dart'`
       - Change all `Future<Either<Failure, T>>` return types to `Future<Result<T>>`
       - This includes ~11 methods: signIn, signOut, refreshSession, requestPasswordReset, updatePassword, updateProfile, uploadProfilePhoto, removeProfilePhoto, etc.

    **AuthRepository implementation:**

    2. `lib/data/repositories/auth_repository_impl.dart`:
       - Replace `import 'package:dartz/dartz.dart'` with `import '../../core/errors/result.dart'`
       - IMPORTANT: Preserve the existing `_mapAuthError()` helper function -- it has Indonesian-locale error messages specific to auth. Do NOT replace with generic `mapException()` for auth-specific errors.
       - For each method, change the error handling pattern from:
         ```dart
         return Left(AuthFailure(message: _mapAuthError(e.message)));
         ```
         to:
         ```dart
         return Result.failure(AuthFailure(message: _mapAuthError(e.message)));
         ```
       - Change all `Right(value)` to `Result.success(value)`
       - Change all `Right(null)` to `Result.success(null)` for void returns
       - For non-auth exceptions (e.g., generic catch blocks), use `mapException(e, context: 'methodName')` with `import '../../core/errors/exception_mapper.dart'`
       - Keep the `Left(AuthFailure(...))` -> `Result.failure(AuthFailure(...))` pattern for auth-specific errors

    **Test files:**

    3. `test/data/repositories/auth_repository_impl_test.dart`:
       - Remove `import 'package:dartz/dartz.dart'`
       - Add `import 'package:leadx_crm/core/errors/result.dart'`
       - Replace all `isA<Right>()` with `isA<Success>()`
       - Replace all `isA<Left>()` with `isA<ResultFailure>()`
       - Replace `(result as Right).value` with `(result as Success).value`
       - Replace `(result as Left).value` with `(result as ResultFailure).failure`
       - Ensure `AppLogger.init()` is in setUpAll (add if missing, as was needed for customer tests)

    4. `test/helpers/test_helpers.dart`:
       - Update `FakeAuthRepository` class to implement the new interface
       - Change all `Future<Either<Failure, T>>` return types to `Future<Result<T>>`
       - Replace `Right(...)` returns with `Result.success(...)`
       - Replace `Left(...)` returns with `Result.failure(...)`
       - Remove dartz import, add result.dart import

    5. `test/helpers/customer_test_helpers.dart`:
       - Check if dartz import is still needed after FakeAuthRepository changes
       - If the only dartz usage was for types shared with FakeAuthRepository, remove the import
       - If other dartz usage exists, leave it (will be cleaned up in final cleanup plan)
  </action>
  <verify>
    Run `flutter test test/data/repositories/auth_repository_impl_test.dart` -- all tests pass.
    Run `flutter analyze` -- zero errors in the 5 modified files.
    Verify no dartz import remains: `grep -r "dartz" lib/domain/repositories/auth_repository.dart lib/data/repositories/auth_repository_impl.dart test/data/repositories/auth_repository_impl_test.dart test/helpers/test_helpers.dart`
  </verify>
  <done>
    AuthRepository interface (11 methods) and implementation migrated to Result<T>. Custom _mapAuthError preserved. auth_repository_impl_test.dart passes with Result-based assertions. FakeAuthRepository updated. No dartz imports in repository or test files.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate all 6 auth consumer files from .fold()/.isLeft() to switch/Result API</name>
  <files>
    lib/presentation/providers/auth_providers.dart
    lib/presentation/providers/profile_providers.dart
    lib/presentation/screens/auth/reset_password_screen.dart
    lib/presentation/screens/auth/forgot_password_screen.dart
    lib/presentation/screens/profile/edit_profile_screen.dart
    lib/presentation/screens/profile/change_password_screen.dart
  </files>
  <action>
    **Auth providers:**

    1. `auth_providers.dart` (1 .fold() site in LoginNotifier):
       - Replace the `.fold()` call with switch pattern matching
       - Add result.dart import, remove dartz import

    2. `profile_providers.dart` (4 .fold() + 3 .isLeft() sites -- MOST COMPLEX consumer):
       - This file uses non-standard patterns that need careful rewriting:
         a. `.isLeft()` checks: Replace with `.isFailure`
         b. `.fold((l) => l, (r) => null)` to extract failure: Replace with `.failureOrNull`
         c. `.fold((l) => '', (r) => r)` to extract value: Replace with `.valueOrNull ?? ''`
         d. Standard `.fold()` callbacks: Replace with switch pattern matching
       - The multi-step upload flow (upload photo, then update profile) uses `.isLeft()` between steps. Rewrite using switch or `.isFailure`:
         ```dart
         // Before:
         if (uploadResult.isLeft()) {
           final failure = uploadResult.fold((l) => l, (r) => null);
           state = ...; return false;
         }
         final photoUrl = uploadResult.fold((l) => '', (r) => r);

         // After:
         switch (uploadResult) {
           case ResultFailure(:final failure):
             state = ...; return false;
           case Success(:final value):
             final photoUrl = value;
             // continue...
         }
         ```
       - Remove dartz import, add result.dart import

    **Auth screens:**

    3. `reset_password_screen.dart` (1 .fold() site):
       - Replace `.fold()` with switch pattern matching
       - Add result.dart import if needed, remove dartz import if present

    4. `forgot_password_screen.dart` (1 .fold() site):
       - Same pattern as reset_password_screen

    5. `edit_profile_screen.dart` (1 .fold() site):
       - Same pattern

    6. `change_password_screen.dart` (1 .fold() site):
       - Same pattern
  </action>
  <verify>
    Run `flutter analyze` -- zero errors in all 6 modified files. Specifically:
    - `grep -r "\.fold\(" lib/presentation/providers/auth_providers.dart lib/presentation/providers/profile_providers.dart lib/presentation/screens/auth/reset_password_screen.dart lib/presentation/screens/auth/forgot_password_screen.dart lib/presentation/screens/profile/edit_profile_screen.dart lib/presentation/screens/profile/change_password_screen.dart` returns zero results
    - `grep -r "\.isLeft\(\)" lib/presentation/providers/profile_providers.dart` returns zero results
    - `grep -r "dartz" lib/presentation/providers/auth_providers.dart lib/presentation/providers/profile_providers.dart` returns zero results
  </verify>
  <done>
    All 6 auth consumer files migrated: 1 .fold() in auth_providers, 4 .fold() + 3 .isLeft() in profile_providers, 4 .fold() across 4 screen files. Profile providers multi-step flow rewritten with switch/Result API. Zero dartz imports remain. flutter analyze clean.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
- Run `flutter test` -- all tests pass (especially auth_repository_impl_test.dart)
- Run `flutter analyze` -- no new errors
- Verify all 11 modified files have no dartz imports
- AuthRepository (11 methods) returns Result<T> with preserved _mapAuthError
</verification>

<success_criteria>
- AuthRepository 11 methods migrated from Either to Result
- Custom _mapAuthError preserved (not replaced by generic mapException)
- 9 .fold() + 3 .isLeft() consumer call sites replaced across 6 files
- auth_repository_impl_test.dart and FakeAuthRepository updated and passing
- Zero dartz imports in all 11 modified files
- flutter analyze and flutter test clean
</success_criteria>

<output>
After completion, create `.planning/phases/03.1-remaining-repo-result-migration/03.1-03-SUMMARY.md`
</output>
