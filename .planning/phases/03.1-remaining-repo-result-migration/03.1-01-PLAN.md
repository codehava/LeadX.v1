---
phase: 03.1-remaining-repo-result-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/domain/repositories/broker_repository.dart
  - lib/data/repositories/broker_repository_impl.dart
  - lib/domain/repositories/admin_user_repository.dart
  - lib/data/repositories/admin_user_repository_impl.dart
  - lib/domain/repositories/hvc_repository.dart
  - lib/data/repositories/hvc_repository_impl.dart
  - lib/presentation/providers/broker_providers.dart
  - lib/presentation/providers/admin_user_providers.dart
  - lib/presentation/providers/hvc_providers.dart
  - lib/presentation/providers/sync_providers.dart
autonomous: true

must_haves:
  truths:
    - "BrokerRepository interface and impl return Result<T> instead of Either<Failure, T>"
    - "AdminUserRepository interface and impl return Result<T> instead of Either<Failure, T>"
    - "HvcRepository interface and impl return Result<T> instead of Either<Failure, T>"
    - "All .fold() call sites in broker_providers, admin_user_providers, hvc_providers, and sync_providers (hvc/broker) use switch pattern matching"
    - "flutter analyze passes with no errors on modified files"
  artifacts:
    - path: "lib/domain/repositories/broker_repository.dart"
      provides: "Broker repository interface with Result<T>"
      contains: "Result<"
    - path: "lib/data/repositories/broker_repository_impl.dart"
      provides: "Broker repository impl using runCatching/mapException"
      contains: "runCatching"
    - path: "lib/domain/repositories/admin_user_repository.dart"
      provides: "AdminUser repository interface with Result<T>"
      contains: "Result<"
    - path: "lib/data/repositories/admin_user_repository_impl.dart"
      provides: "AdminUser repository impl using runCatching/mapException"
      contains: "runCatching"
    - path: "lib/domain/repositories/hvc_repository.dart"
      provides: "HVC repository interface with Result<T>"
      contains: "Result<"
    - path: "lib/data/repositories/hvc_repository_impl.dart"
      provides: "HVC repository impl using runCatching/mapException"
      contains: "runCatching"
  key_links:
    - from: "lib/presentation/providers/broker_providers.dart"
      to: "BrokerRepository"
      via: "switch pattern matching on Result"
      pattern: "case Success|case ResultFailure"
    - from: "lib/presentation/providers/hvc_providers.dart"
      to: "HvcRepository"
      via: "switch pattern matching on Result"
      pattern: "case Success|case ResultFailure"
    - from: "lib/presentation/providers/sync_providers.dart"
      to: "HvcRepository + BrokerRepository sync results"
      via: "switch pattern matching on Result"
      pattern: "case Success|case ResultFailure"
---

<objective>
Migrate Broker (4 methods), AdminUser (6 methods), and HVC (7 methods) repositories from dartz Either<Failure, T> to sealed Result<T>, updating all consumer .fold() call sites to switch pattern matching.

Purpose: Three simplest repositories migrated in one plan, establishing momentum for the phase. All are straightforward -- Broker and HVC use the same offline-first pattern as Customer (already migrated), AdminUser is online-only with direct Supabase calls.
Output: 6 repository files (3 interfaces + 3 impls) and 4 consumer files updated.
</objective>

<execution_context>
@C:/Users/cartr/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/cartr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.1-remaining-repo-result-migration/03.1-RESEARCH.md
@.planning/phases/03-error-classification-recovery/03-01-SUMMARY.md
@.planning/phases/03-error-classification-recovery/03-02-SUMMARY.md
@lib/core/errors/result.dart
@lib/core/errors/exception_mapper.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate BrokerRepository and AdminUserRepository to Result type</name>
  <files>
    lib/domain/repositories/broker_repository.dart
    lib/data/repositories/broker_repository_impl.dart
    lib/presentation/providers/broker_providers.dart
    lib/domain/repositories/admin_user_repository.dart
    lib/data/repositories/admin_user_repository_impl.dart
    lib/presentation/providers/admin_user_providers.dart
  </files>
  <action>
    **BrokerRepository (4 Either methods: createBroker, updateBroker, deleteBroker, syncFromRemote):**

    1. Interface (`lib/domain/repositories/broker_repository.dart`):
       - Replace `import 'package:dartz/dartz.dart'` with `import '../../core/errors/result.dart'`
       - Change all `Future<Either<Failure, T>>` to `Future<Result<T>>`
       - Keep `Failure` import from `failures.dart` if needed by other signatures

    2. Implementation (`lib/data/repositories/broker_repository_impl.dart`):
       - Replace `import 'package:dartz/dartz.dart'` with `import '../../core/errors/exception_mapper.dart'` and `import '../../core/errors/result.dart'`
       - For simple CRUD (createBroker, updateBroker, deleteBroker): wrap body with `runCatching(() async { ... }, context: 'methodName')` -- remove old try/catch + Left/Right
       - For syncFromRemote: use explicit `try { ... return Result.success(count); } catch (e) { return Result.failure(mapException(e, context: 'syncFromRemote')); }`
       - Replace any `Right(null)` or `const Right(null)` with `Result.success(null)` for void returns
       - Replace any `Left(DatabaseFailure(...))` with `Result.failure(mapException(e, context: ...))`

    3. Consumers (`lib/presentation/providers/broker_providers.dart` -- 3 .fold() sites):
       - Replace `import 'package:dartz/dartz.dart'` with `import '../../core/errors/result.dart'` (if not already imported)
       - Replace each `result.fold((failure) => ..., (value) => ...)` with:
         ```dart
         switch (result) {
           case Success(:final value):
             // success handler
           case ResultFailure(:final failure):
             // failure handler
         }
         ```

    **AdminUserRepository (6 Either methods: createUser, updateUser, deactivateUser, activateUser, generateTemporaryPassword, updateUserHierarchy):**

    4. Interface (`lib/domain/repositories/admin_user_repository.dart`):
       - Same import replacement as Broker
       - Change all `Future<Either<Failure, T>>` to `Future<Result<T>>`
       - NOTE: Only migrate methods that currently return Either. Methods that throw raw exceptions are OUT OF SCOPE.

    5. Implementation (`lib/data/repositories/admin_user_repository_impl.dart`):
       - Same import replacement
       - These are online-only (direct Supabase remote calls, no local DB). Use `runCatching` for all 6 methods since they are simple remote calls with no not-found validation logic.
       - Replace `Left(DatabaseFailure(...))` catch-all with `mapException` via `runCatching`

    6. Consumers (`lib/presentation/providers/admin_user_providers.dart` -- 6 .fold() sites):
       - Replace all 6 `.fold()` call sites with switch pattern matching
       - Remove dartz import
  </action>
  <verify>
    Run `flutter analyze` and confirm zero errors in the 6 modified files. Specifically:
    - No `.fold()` calls remain on Result types in broker_providers.dart or admin_user_providers.dart
    - No `import 'package:dartz/dartz.dart'` remains in the 6 files
  </verify>
  <done>
    BrokerRepository (4 methods) and AdminUserRepository (6 methods) fully migrated from Either to Result. All 6 .fold() consumer call sites in broker_providers.dart and 6 in admin_user_providers.dart replaced with switch pattern matching. flutter analyze clean.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate HvcRepository to Result type and update sync_providers</name>
  <files>
    lib/domain/repositories/hvc_repository.dart
    lib/data/repositories/hvc_repository_impl.dart
    lib/presentation/providers/hvc_providers.dart
    lib/presentation/providers/sync_providers.dart
  </files>
  <action>
    **HvcRepository (7 Either methods: createHvc, updateHvc, deleteHvc, linkCustomerToHvc, unlinkCustomerFromHvc, syncFromRemote, syncLinksFromRemote):**

    1. Interface (`lib/domain/repositories/hvc_repository.dart`):
       - Replace `import 'package:dartz/dartz.dart'` with `import '../../core/errors/result.dart'`
       - Change all `Future<Either<Failure, T>>` to `Future<Result<T>>`

    2. Implementation (`lib/data/repositories/hvc_repository_impl.dart`):
       - Replace dartz import with exception_mapper.dart and result.dart imports
       - For simple CRUD (createHvc, updateHvc, deleteHvc, linkCustomerToHvc, unlinkCustomerFromHvc): use `runCatching`
       - For syncFromRemote and syncLinksFromRemote: use explicit try/catch + mapException (these have complex remote fetch + local upsert logic)
       - Replace all `Left(...)` with `Result.failure(...)` and `Right(...)` with `Result.success(...)`

    3. Consumers (`lib/presentation/providers/hvc_providers.dart` -- 5 .fold() sites):
       - Replace dartz import
       - Replace all 5 `.fold()` call sites with switch pattern matching

    4. Shared consumer (`lib/presentation/providers/sync_providers.dart` -- 3 remaining .fold() sites for HVC + Broker):
       - This file already has Result imports from Phase 3 migration (customer/pipeline/activity sync results use switch)
       - Replace the 3 remaining `.fold()` calls on `hvcResult`, `hvcLinkResult`, and `brokerResult` with switch pattern matching
       - After this, sync_providers.dart should have ZERO remaining .fold() calls from dartz
       - Remove `import 'package:dartz/dartz.dart'` if no other dartz usage remains in the file
  </action>
  <verify>
    Run `flutter analyze` and confirm zero errors in the 4 modified files. Verify:
    - `grep -r "\.fold\(" lib/presentation/providers/sync_providers.dart` returns zero results (all .fold() eliminated)
    - `grep -r "\.fold\(" lib/presentation/providers/hvc_providers.dart` returns zero results
    - No dartz import in any of the 4 files
  </verify>
  <done>
    HvcRepository (7 methods) fully migrated from Either to Result. 5 .fold() sites in hvc_providers.dart and 3 in sync_providers.dart replaced with switch pattern matching. sync_providers.dart is now fully dartz-free. flutter analyze clean.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
- Run `flutter analyze` on the full project -- no new errors introduced
- Verify all 10 modified files have no dartz imports: `grep -r "dartz" lib/domain/repositories/broker_repository.dart lib/data/repositories/broker_repository_impl.dart lib/domain/repositories/admin_user_repository.dart lib/data/repositories/admin_user_repository_impl.dart lib/domain/repositories/hvc_repository.dart lib/data/repositories/hvc_repository_impl.dart lib/presentation/providers/broker_providers.dart lib/presentation/providers/admin_user_providers.dart lib/presentation/providers/hvc_providers.dart lib/presentation/providers/sync_providers.dart` returns nothing
- 3 repositories (17 methods total) now return Result<T> instead of Either<Failure, T>
</verification>

<success_criteria>
- Broker (4), AdminUser (6), HVC (7) = 17 methods migrated from Either to Result
- 14 .fold() consumer call sites across 4 provider files replaced with switch pattern matching
- Zero dartz imports in all 10 modified files
- flutter analyze clean
</success_criteria>

<output>
After completion, create `.planning/phases/03.1-remaining-repo-result-migration/03.1-01-SUMMARY.md`
</output>
