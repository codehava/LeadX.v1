---
phase: 01-foundation-observability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/core/errors/sync_errors.dart
  - lib/data/database/tables/activities.dart
  - lib/data/database/tables/master_data.dart
  - lib/data/database/tables/cadence.dart
  - lib/data/database/tables/history_log_tables.dart
  - lib/data/database/app_database.dart
  - lib/data/services/sync_service.dart
autonomous: true

must_haves:
  truths:
    - "All syncable tables have identical sync metadata columns (isPendingSync, lastSyncAt, updatedAt) with no entity-specific special cases"
    - "Sealed SyncError hierarchy exists with retryable vs permanent classification"
    - "SyncService._markEntityAsSynced sets lastSyncAt for ALL entity types that have it"
    - "Activities table uses lastSyncAt instead of syncedAt"
  artifacts:
    - path: "lib/core/errors/sync_errors.dart"
      provides: "Sealed SyncError hierarchy with 6 concrete subclasses"
      contains: "sealed class SyncError"
    - path: "lib/data/database/app_database.dart"
      provides: "Migration v9 -> v10 for sync metadata standardization"
      contains: "schemaVersion => 10"
  key_links:
    - from: "lib/data/services/sync_service.dart"
      to: "lib/core/errors/sync_errors.dart"
      via: "import and throw in _processItem catch blocks"
      pattern: "throw NetworkSyncError|throw TimeoutSyncError|throw AuthSyncError"
    - from: "lib/data/database/app_database.dart"
      to: "lib/data/database/tables/activities.dart"
      via: "migration renames syncedAt column to lastSyncAt"
      pattern: "RENAME COLUMN synced_at TO last_sync_at"
---

<objective>
Create the sealed SyncError hierarchy for typed sync failure classification, standardize sync metadata columns across all Drift tables via migration v10, and update SyncService to use both.

Purpose: The error hierarchy enables exhaustive pattern matching on sync failures (retryable vs permanent) which Phase 2-3 depend on. Schema standardization eliminates 5 different sync metadata patterns across 12 entity types, making sync logic uniform.

Output: `sync_errors.dart` with sealed hierarchy, Drift migration v10, updated table definitions, updated `_markEntityAsSynced` and `_processItem` methods.
</objective>

<execution_context>
@C:/Users/cartr/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/cartr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-observability/01-RESEARCH.md

@lib/core/errors/failures.dart
@lib/core/errors/exceptions.dart
@lib/data/database/app_database.dart
@lib/data/database/tables/activities.dart
@lib/data/database/tables/customers.dart
@lib/data/database/tables/master_data.dart
@lib/data/database/tables/cadence.dart
@lib/data/database/tables/history_log_tables.dart
@lib/data/database/tables/pipelines.dart
@lib/data/services/sync_service.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sealed SyncError hierarchy and update SyncService error handling</name>
  <files>
    lib/core/errors/sync_errors.dart
    lib/data/services/sync_service.dart
  </files>
  <action>
**Create `lib/core/errors/sync_errors.dart`:**

Create a sealed class hierarchy with these exact classes (see research Pattern 1 for full implementation):

```dart
sealed class SyncError {
  final String message;
  final Object? originalError;
  final StackTrace? stackTrace;
  final String? entityType;
  final String? entityId;
  const SyncError({required this.message, this.originalError, this.stackTrace, this.entityType, this.entityId});
  bool get isRetryable;
}
```

Concrete subclasses (all `final class`):
- `NetworkSyncError` - isRetryable: true
- `TimeoutSyncError` - isRetryable: true
- `ServerSyncError` - has `int statusCode`, isRetryable: `statusCode >= 500`
- `AuthSyncError` - isRetryable: false
- `ValidationSyncError` - has `Map<String, dynamic>? details`, isRetryable: false
- `ConflictSyncError` - isRetryable: false

**Update `lib/data/services/sync_service.dart` `_processItem` method:**

Replace the current catch blocks at lines 251-257:
```dart
} on SocketException catch (e) {
  throw Exception('Network error: Device appears to be offline. $e');
} on TimeoutException catch (e) {
  throw Exception('Network timeout: Server not responding. $e');
}
```

With typed SyncError throws (see research Example 2):
- `SocketException` -> `throw NetworkSyncError(...)`
- `TimeoutException` -> `throw TimeoutSyncError(...)`
- `PostgrestException` -> classify by HTTP status code:
  - 401 or code `PGRST301` -> `throw AuthSyncError(...)`
  - 409 -> `throw ConflictSyncError(...)`
  - 400-499 -> `throw ValidationSyncError(...)`
  - 500+ -> `throw ServerSyncError(statusCode: code, ...)`

Add import at top: `import '../../core/errors/sync_errors.dart';`

**Update `processQueue` error handler** (lines 171-177):

Replace the generic catch block with a `SyncError` catch that checks `isRetryable`:
- If retryable: increment retry count (already there)
- If permanent: mark as failed with the error message
- Keep the existing `_syncQueueDataSource.incrementRetryCount` and `markAsFailed` calls
- Add the typed error to the errors list with its classification

Keep a fallback `catch (e)` for unexpected non-SyncError exceptions that wraps them in a generic error message.

Do NOT change any debugPrint calls in this task (those will be replaced in Plan 03).
  </action>
  <verify>
Run `flutter analyze` -- should have no new errors in `sync_errors.dart` or `sync_service.dart`.
Verify `sync_errors.dart` exports the sealed class and all 6 subclasses.
Verify `_processItem` imports and throws SyncError subclasses.
  </verify>
  <done>
`sync_errors.dart` exists with sealed SyncError + 6 final subclasses.
`_processItem` throws typed SyncErrors instead of generic Exceptions.
`processQueue` catches SyncError with retryable/permanent branching.
  </done>
</task>

<task type="auto">
  <name>Task 2: Standardize sync metadata schema via Drift migration v10 and update dependent code</name>
  <files>
    lib/data/database/tables/activities.dart
    lib/data/database/tables/master_data.dart
    lib/data/database/tables/cadence.dart
    lib/data/database/tables/history_log_tables.dart
    lib/data/database/app_database.dart
    lib/data/services/sync_service.dart
  </files>
  <action>
**Step 1: Update Drift table definitions** to add missing `lastSyncAt` columns:

1. **`lib/data/database/tables/customers.dart` - KeyPersons table**: Add after `updatedAt`:
   ```dart
   DateTimeColumn get lastSyncAt => dateTime().nullable()();
   ```

2. **`lib/data/database/tables/master_data.dart` - Hvcs table** (line ~225, after `deletedAt`): Add:
   ```dart
   DateTimeColumn get lastSyncAt => dateTime().nullable()();
   ```

3. **`lib/data/database/tables/master_data.dart` - CustomerHvcLinks table** (line ~242, after `deletedAt`): Add:
   ```dart
   DateTimeColumn get lastSyncAt => dateTime().nullable()();
   ```

4. **`lib/data/database/tables/master_data.dart` - Brokers table** (line ~271, after `deletedAt`): Add:
   ```dart
   DateTimeColumn get lastSyncAt => dateTime().nullable()();
   ```

5. **`lib/data/database/tables/cadence.dart` - CadenceMeetings table** (line ~48, after `updatedAt`): Add:
   ```dart
   DateTimeColumn get lastSyncAt => dateTime().nullable()();
   ```

6. **`lib/data/database/tables/history_log_tables.dart` - PipelineStageHistoryItems table** (after `createdLocally`): Add:
   ```dart
   DateTimeColumn get lastSyncAt => dateTime().nullable()();
   DateTimeColumn get updatedAt => dateTime().nullable()();
   ```

7. **`lib/data/database/tables/activities.dart` - Activities table**: Rename `syncedAt` to `lastSyncAt`:
   Change line 38 from:
   ```dart
   DateTimeColumn get syncedAt => dateTime().nullable()();
   ```
   to:
   ```dart
   DateTimeColumn get lastSyncAt => dateTime().nullable()();
   ```

**Step 2: Add migration v9 -> v10 in `lib/data/database/app_database.dart`:**

Change `schemaVersion => 9` to `schemaVersion => 10`.

Add `if (from < 10)` block inside `onUpgrade` after the v9 migration (see research Example 1):

```dart
if (from < 10) {
  // Disable FK during migration to prevent constraint issues
  await customStatement('PRAGMA foreign_keys = OFF');

  // Add lastSyncAt to tables missing it (Category B)
  await m.addColumn(keyPersons, keyPersons.lastSyncAt);
  await m.addColumn(hvcs, hvcs.lastSyncAt);
  await m.addColumn(customerHvcLinks, customerHvcLinks.lastSyncAt);
  await m.addColumn(brokers, brokers.lastSyncAt);
  await m.addColumn(cadenceMeetings, cadenceMeetings.lastSyncAt);

  // Add lastSyncAt and updatedAt to PipelineStageHistoryItems (Category D)
  await m.addColumn(pipelineStageHistoryItems, pipelineStageHistoryItems.lastSyncAt);
  await m.addColumn(pipelineStageHistoryItems, pipelineStageHistoryItems.updatedAt);

  // Rename Activities.syncedAt -> lastSyncAt (Category C)
  // SQLite 3.25+ supports ALTER TABLE RENAME COLUMN
  await customStatement(
    'ALTER TABLE activities RENAME COLUMN synced_at TO last_sync_at',
  );
}
```

Note: FK re-enable happens in `beforeOpen` which already has `PRAGMA foreign_keys = ON`.

**Step 3: Update `_markEntityAsSynced` in `lib/data/services/sync_service.dart`:**

Update these cases to now set `lastSyncAt`:

- `keyPerson` case: Add `lastSyncAt: Value(syncedAt)` to the write
- `activity` case: Change `syncedAt: Value(syncedAt)` to `lastSyncAt: Value(syncedAt)` (matches renamed column)
- `hvc` case: Add `lastSyncAt: Value(syncedAt)` to the write
- `customerHvcLink` case: Add `lastSyncAt: Value(syncedAt)` to the write
- `broker` case: Add `lastSyncAt: Value(syncedAt)` to the write
- `pipelineStageHistory` case: Add `lastSyncAt: Value(syncedAt)` to the write
- `cadenceMeeting` case: Change `updatedAt: Value(syncedAt)` to `lastSyncAt: Value(syncedAt)` (fix bug -- was writing to updatedAt instead of lastSyncAt)

**Step 4: Run code generation:**

```bash
dart run build_runner build --delete-conflicting-outputs
```

This regenerates `app_database.g.dart` with the new columns and renamed field. Fix any compilation errors from the `syncedAt -> lastSyncAt` rename by searching for remaining references to `syncedAt` in the codebase and updating them.

**Step 5: Search for and fix all `syncedAt` references:**

Search for `syncedAt` across the entire `lib/` directory. Any reference to `activities.syncedAt` or `Activity.syncedAt` or `ActivitiesCompanion(syncedAt:` must be updated to use `lastSyncAt`.

This includes:
- Local data sources (`activity_local_data_source.dart`)
- DTOs and mappers that reference the column
- Any test files that reference `syncedAt`
  </action>
  <verify>
1. Run `dart run build_runner build --delete-conflicting-outputs` -- must complete without errors.
2. Run `flutter analyze` -- must have no errors related to sync metadata, missing columns, or `syncedAt` references.
3. Search for `syncedAt` in lib/ -- should return 0 results (all renamed to lastSyncAt).
4. Verify `schemaVersion` is 10 in `app_database.dart`.
5. Verify all 7 updated tables have `lastSyncAt` column in their Drift definition.
  </verify>
  <done>
Schema version is 10. All syncable tables (Customers, KeyPersons, Pipelines, PipelineReferrals, Activities, Hvcs, CustomerHvcLinks, Brokers, CadenceMeetings, CadenceParticipants, PipelineStageHistoryItems) have `isPendingSync` + `lastSyncAt` + `updatedAt` columns. Activities uses `lastSyncAt` (not `syncedAt`). `_markEntityAsSynced` sets `lastSyncAt` for all entity types. Build_runner generates clean code.
  </done>
</task>

</tasks>

<verification>
1. `flutter analyze` passes with no new errors
2. `dart run build_runner build --delete-conflicting-outputs` completes cleanly
3. `grep -r "syncedAt" lib/` returns 0 results
4. `lib/core/errors/sync_errors.dart` exists with sealed class + 6 subclasses
5. `schemaVersion` in `app_database.dart` is 10
6. `_markEntityAsSynced` sets `lastSyncAt` for all entity types (no cases skip it)
</verification>

<success_criteria>
- Sealed SyncError hierarchy compiles and provides exhaustive pattern matching
- All syncable tables have standardized sync metadata columns
- Migration v9->v10 is additive (nullable columns, rename) and safe for existing data
- SyncService uses typed errors instead of generic Exception wrapping
- Code generation succeeds with no conflicts
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-observability/01-01-SUMMARY.md`
</output>
