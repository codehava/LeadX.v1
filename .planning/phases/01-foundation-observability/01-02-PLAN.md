---
phase: 01-foundation-observability
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - pubspec.yaml
  - .env
  - lib/config/env/env_config.dart
  - lib/main.dart
  - lib/presentation/providers/auth_providers.dart
autonomous: true

user_setup:
  - service: sentry
    why: "Crash reporting for production error capture"
    env_vars:
      - name: SENTRY_DSN
        source: "Sentry Dashboard -> Settings -> Projects -> [project] -> Client Keys (DSN)"
    dashboard_config:
      - task: "Create a Sentry project for Flutter"
        location: "https://sentry.io -> Create Project -> Flutter"

must_haves:
  truths:
    - "Unhandled exceptions in production are captured in Sentry with user context and breadcrumbs"
    - "Sentry DSN is loaded from .env file, not hardcoded"
    - "SentryFlutter.init wraps runApp so widget tree errors are captured"
    - "Sentry user context is set after login with user ID, email, and role"
    - "Sentry user context is cleared on logout"
  artifacts:
    - path: "lib/main.dart"
      provides: "SentryFlutter.init wrapping the entire app"
      contains: "SentryFlutter.init"
    - path: "lib/config/env/env_config.dart"
      provides: "sentryDsn getter from .env"
      contains: "sentryDsn"
    - path: "lib/presentation/providers/auth_providers.dart"
      provides: "Sentry user context on login/logout"
      contains: "Sentry.configureScope"
  key_links:
    - from: "lib/main.dart"
      to: "lib/config/env/env_config.dart"
      via: "envConfig.sentryDsn passed to SentryFlutter options.dsn"
      pattern: "options.dsn.*sentryDsn"
    - from: "lib/presentation/providers/auth_providers.dart"
      to: "sentry_flutter"
      via: "Sentry.configureScope sets/clears user after login/logout"
      pattern: "Sentry.configureScope"
---

<objective>
Integrate Sentry crash reporting so unhandled exceptions are captured with user context and breadcrumbs in production.

Purpose: Without production error visibility, sync failures and crashes are invisible. Sentry provides the observability foundation that all subsequent debugging depends on.

Output: Sentry SDK wired into main.dart, DSN loaded from .env, user context set on login/logout.
</objective>

<execution_context>
@C:/Users/cartr/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/cartr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-observability/01-RESEARCH.md

@lib/main.dart
@lib/app.dart
@lib/config/env/env_config.dart
@lib/presentation/providers/auth_providers.dart
@pubspec.yaml
@.env
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sentry_flutter dependency and configure DSN loading</name>
  <files>
    pubspec.yaml
    .env
    lib/config/env/env_config.dart
  </files>
  <action>
**Update `pubspec.yaml`:**

Add `sentry_flutter: ^9.13.0` under dependencies. Place it after `supabase_flutter` in the `# Supabase` section or create a new `# Observability` section:

```yaml
  # Observability
  sentry_flutter: ^9.13.0
```

Do NOT remove the `logger: ^2.5.0` dependency yet -- that happens in Plan 03.

**Update `.env`:**

Add a new line for Sentry DSN. Use an empty string as default so the app works without Sentry configured:

```
# Sentry Crash Reporting (get DSN from https://sentry.io)
SENTRY_DSN=
```

**Update `lib/config/env/env_config.dart`:**

Add a `sentryDsn` getter:

```dart
/// Sentry DSN for crash reporting (loaded from .env)
/// Empty string disables Sentry (it silently no-ops when DSN is empty)
String get sentryDsn => dotenv.env['SENTRY_DSN'] ?? '';
```

Do NOT add SENTRY_DSN to the `validate()` method -- it's optional. Sentry silently disables itself when DSN is empty.

Run `flutter pub get` to install the new dependency.
  </action>
  <verify>
1. `flutter pub get` succeeds without errors.
2. `lib/config/env/env_config.dart` has `sentryDsn` getter.
3. `.env` file has `SENTRY_DSN=` line.
  </verify>
  <done>
sentry_flutter is in pubspec.yaml and resolved. EnvConfig has sentryDsn getter. .env has SENTRY_DSN placeholder.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire SentryFlutter.init into main.dart and add user context in auth flow</name>
  <files>
    lib/main.dart
    lib/presentation/providers/auth_providers.dart
  </files>
  <action>
**Rewrite `lib/main.dart`** to wrap the entire app in SentryFlutter.init using the `appRunner` pattern (see research Pattern 4):

```dart
import 'package:flutter/foundation.dart';
import 'package:flutter/material.dart';
import 'package:flutter_dotenv/flutter_dotenv.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:flutter_web_plugins/url_strategy.dart';
import 'package:intl/date_symbol_data_local.dart';
import 'package:sentry_flutter/sentry_flutter.dart';
import 'package:supabase_flutter/supabase_flutter.dart';

import 'app.dart';
import 'config/env/env_config.dart';

Future<void> main() async {
  WidgetsFlutterBinding.ensureInitialized();

  // Use path-based URL strategy for web (removes # from URLs)
  usePathUrlStrategy();

  // Load environment variables from bundled .env file
  await dotenv.load(fileName: '.env');

  // Get and validate environment configuration
  final envConfig = EnvConfig.instance;
  envConfig.validate();

  // Wrap everything in SentryFlutter.init so widget tree errors are captured
  await SentryFlutter.init(
    (options) {
      options.dsn = envConfig.sentryDsn;
      options.tracesSampleRate = 0.2; // 20% of transactions
      options.environment = kReleaseMode ? 'production' : 'development';
      // Only send events in release mode (or when DSN is explicitly set in dev)
      options.beforeSend = (event, hint) {
        if (!kReleaseMode && envConfig.sentryDsn.isEmpty) {
          return null; // Drop events in dev when no DSN configured
        }
        return event;
      };
    },
    appRunner: () async {
      // Initialize Supabase
      await Supabase.initialize(
        url: envConfig.supabaseUrl,
        anonKey: envConfig.supabaseAnonKey,
      );

      // Initialize locale data for Indonesian date formatting
      await initializeDateFormatting('id_ID', null);

      // Run the app
      runApp(
        const ProviderScope(
          child: LeadXApp(),
        ),
      );
    },
  );
}
```

Key points:
- `SentryFlutter.init` wraps everything including Supabase init
- `appRunner` parameter ensures widget tree errors are captured
- `beforeSend` drops events in debug mode when no DSN is set (prevents noise)
- `kReleaseMode` import from `package:flutter/foundation.dart`
- `tracesSampleRate: 0.2` keeps performance overhead low

**Update `lib/presentation/providers/auth_providers.dart`:**

Add Sentry user context in `LoginNotifier`:

1. Add import: `import 'package:sentry_flutter/sentry_flutter.dart';`

2. In the `login` method, after the success case (`(user) {` block, before `return true;`), add:
```dart
// Set Sentry user context for crash reporting
Sentry.configureScope((scope) {
  scope.setUser(SentryUser(
    id: user.id,
    email: user.email,
  ));
});
```

3. In the `logout` method, after `await _repository.signOut();`, add:
```dart
// Clear Sentry user context
Sentry.configureScope((scope) => scope.setUser(null));
```

Note: We use `user.id` and `user.email` from the domain User entity. The `signIn` result returns `Either<Failure, User>` -- in the success branch we have the user object.

**Important:** The login `result.fold` success branch receives `(user)` which is a domain `User`. Access `user.id` and `user.email` for Sentry context.
  </action>
  <verify>
1. `flutter analyze` passes with no errors in `main.dart` or `auth_providers.dart`.
2. `main.dart` contains `SentryFlutter.init` with `appRunner` parameter.
3. `auth_providers.dart` contains `Sentry.configureScope` in both login success and logout.
4. `main.dart` imports `sentry_flutter` and `foundation.dart`.
  </verify>
  <done>
SentryFlutter.init wraps the entire app via appRunner. Sentry user context is set on login (id + email) and cleared on logout. DSN is loaded from .env via EnvConfig. Events are dropped in debug mode when no DSN is configured.
  </done>
</task>

</tasks>

<verification>
1. `flutter pub get` succeeds
2. `flutter analyze` passes with no new errors
3. `main.dart` has SentryFlutter.init wrapping runApp via appRunner
4. `auth_providers.dart` sets/clears Sentry user on login/logout
5. `EnvConfig` has `sentryDsn` getter
6. `.env` has `SENTRY_DSN=` placeholder
</verification>

<success_criteria>
- Sentry SDK is integrated and wraps the entire app lifecycle
- Unhandled exceptions during widget tree construction would be captured
- User context (id, email) is attached to Sentry events after login
- DSN is not hardcoded -- loaded from .env file
- App still works when SENTRY_DSN is empty (Sentry silently disables)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-observability/01-02-SUMMARY.md`
</output>
