---
phase: 01-foundation-observability
plan: 03
type: execute
wave: 2
depends_on: ["01-01", "01-02"]
files_modified:
  - pubspec.yaml
  - lib/core/logging/app_logger.dart
  - lib/core/logging/sentry_observer.dart
  - lib/main.dart
  - lib/app.dart
  - lib/data/services/sync_service.dart
  - lib/data/services/connectivity_service.dart
  - lib/data/services/camera_service.dart
  - lib/data/services/gps_service.dart
  - lib/data/repositories/activity_repository_impl.dart
  - lib/data/repositories/auth_repository_impl.dart
  - lib/data/repositories/customer_repository_impl.dart
  - lib/data/repositories/pipeline_repository_impl.dart
  - lib/data/repositories/pipeline_referral_repository_impl.dart
  - lib/data/repositories/scoreboard_repository_impl.dart
  - lib/data/repositories/cadence_repository_impl.dart
  - lib/data/datasources/remote/activity_remote_data_source.dart
  - lib/data/datasources/remote/customer_remote_data_source.dart
  - lib/data/datasources/remote/pipeline_referral_remote_data_source.dart
  - lib/data/database/app_database.dart
  - lib/presentation/providers/activity_providers.dart
  - lib/presentation/providers/sync_providers.dart
  - lib/presentation/providers/pipeline_referral_providers.dart
  - lib/presentation/widgets/sync/sync_progress_sheet.dart
  - lib/presentation/screens/auth/splash_screen.dart
  - lib/presentation/screens/auth/login_screen.dart
  - lib/presentation/screens/auth/reset_password_screen.dart
  - lib/presentation/screens/home/home_screen.dart
  - lib/presentation/screens/cadence/host_dashboard_screen.dart
  - lib/presentation/screens/cadence/cadence_list_screen.dart
  - lib/presentation/screens/referral/referral_list_screen.dart
autonomous: true

must_haves:
  truths:
    - "All sync operations log to Talker with module prefixes (sync.queue, sync.push, sync.pull) replacing scattered debugPrint calls"
    - "Talker forwards errors and exceptions to Sentry via SentryTalkerObserver"
    - "Zero debugPrint calls remain in lib/ directory (all replaced with Talker)"
    - "Riverpod provider events are logged via TalkerRiverpodObserver"
    - "The unused logger package is removed from pubspec.yaml"
  artifacts:
    - path: "lib/core/logging/app_logger.dart"
      provides: "Singleton Talker instance with module logging helpers"
      contains: "class AppLogger"
    - path: "lib/core/logging/sentry_observer.dart"
      provides: "TalkerObserver that forwards errors to Sentry"
      contains: "class SentryTalkerObserver"
  key_links:
    - from: "lib/main.dart"
      to: "lib/core/logging/app_logger.dart"
      via: "AppLogger.init() called before SentryFlutter.init"
      pattern: "AppLogger.init"
    - from: "lib/core/logging/sentry_observer.dart"
      to: "sentry_flutter"
      via: "Sentry.captureException in onError/onException"
      pattern: "Sentry.captureException"
    - from: "lib/main.dart"
      to: "talker_riverpod_logger"
      via: "TalkerRiverpodObserver in ProviderScope"
      pattern: "TalkerRiverpodObserver"
---

<objective>
Set up Talker structured logging with Sentry forwarding and replace all 274 debugPrint calls across 26 files with module-prefixed Talker logging.

Purpose: Replace scattered, unstructured debugPrint calls with a unified logging system that has module prefixes for searchability, level-aware filtering, and automatic error forwarding to Sentry. This is the observability backbone for debugging sync issues in production.

Output: AppLogger singleton, SentryTalkerObserver, Riverpod observer, zero debugPrint calls remaining.
</objective>

<execution_context>
@C:/Users/cartr/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/cartr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-observability/01-RESEARCH.md

# Need summaries from Plans 01 and 02 for sync_service and main.dart state
@.planning/phases/01-foundation-observability/01-01-SUMMARY.md
@.planning/phases/01-foundation-observability/01-02-SUMMARY.md

@lib/main.dart
@lib/app.dart
@lib/data/services/sync_service.dart
@pubspec.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AppLogger, SentryTalkerObserver, and wire into app initialization</name>
  <files>
    pubspec.yaml
    lib/core/logging/app_logger.dart
    lib/core/logging/sentry_observer.dart
    lib/main.dart
    lib/app.dart
  </files>
  <action>
**Update `pubspec.yaml`:**

Add Talker packages under dependencies (in a new `# Observability` section or alongside sentry_flutter):

```yaml
  talker: ^5.1.13
  talker_flutter: ^5.1.13
  talker_riverpod_logger: ^5.1.13
```

Remove the unused `logger` package:
```yaml
  # REMOVE THIS LINE:
  # logger: ^2.5.0
```

Run `flutter pub get`.

**Create `lib/core/logging/app_logger.dart`:**

```dart
import 'package:talker/talker.dart';

/// Centralized logging for LeadX CRM.
///
/// Initialize once at app startup via [init], then access
/// the singleton [instance] throughout the app.
///
/// Module prefix convention: 'module.sub | message'
/// Examples:
///   - 'sync.queue | Processing 5 items'
///   - 'sync.push | Failed: customer/abc-123'
///   - 'auth | Login success for user@email.com'
///   - 'db | Migration v9 -> v10 complete'
class AppLogger {
  AppLogger._();

  static late final Talker _instance;

  /// The singleton Talker instance. Must call [init] first.
  static Talker get instance => _instance;

  /// Initialize the logger. Call once at app startup before any logging.
  ///
  /// Pass [observers] to forward logs to external services (e.g., Sentry).
  static void init({List<TalkerObserver>? observers}) {
    _instance = Talker(
      settings: const TalkerSettings(
        enabled: true,
        useConsoleLogs: true,
      ),
      observer: observers != null && observers.isNotEmpty
          ? TalkerMultiObserver(observers)
          : null,
    );
  }
}
```

**Create `lib/core/logging/sentry_observer.dart`:**

See research Pattern 3 for the full implementation:

```dart
import 'package:sentry_flutter/sentry_flutter.dart';
import 'package:talker/talker.dart';

/// Forwards Talker errors and exceptions to Sentry.
///
/// Also adds warning+ level logs as Sentry breadcrumbs
/// for richer crash context.
class SentryTalkerObserver extends TalkerObserver {
  @override
  void onError(TalkerError err) {
    Sentry.captureException(
      err.error,
      stackTrace: err.stackTrace,
    );
    super.onError(err);
  }

  @override
  void onException(TalkerException exception) {
    Sentry.captureException(
      exception.exception,
      stackTrace: exception.stackTrace,
    );
    super.onException(exception);
  }

  @override
  void onLog(TalkerLog log) {
    // Forward warning+ level logs as Sentry breadcrumbs
    if (log.logLevel.index >= LogLevel.warning.index) {
      Sentry.addBreadcrumb(Breadcrumb(
        message: log.message,
        level: _mapLevel(log.logLevel),
        category: 'talker',
      ));
    }
    super.onLog(log);
  }

  SentryLevel _mapLevel(LogLevel level) {
    return switch (level) {
      LogLevel.critical => SentryLevel.fatal,
      LogLevel.error => SentryLevel.error,
      LogLevel.warning => SentryLevel.warning,
      LogLevel.info => SentryLevel.info,
      _ => SentryLevel.debug,
    };
  }
}
```

**Update `lib/main.dart`:**

This file was updated by Plan 02. Now add Talker initialization BEFORE SentryFlutter.init:

1. Add imports:
```dart
import 'core/logging/app_logger.dart';
import 'core/logging/sentry_observer.dart';
```

2. Add `import 'package:talker_riverpod_logger/talker_riverpod_logger.dart';`

3. BEFORE the `await SentryFlutter.init(...)` call, add:
```dart
// Initialize structured logging FIRST (so it's available during Sentry init)
AppLogger.init(observers: [SentryTalkerObserver()]);
```

4. In the `ProviderScope` inside `appRunner`, add the Riverpod observer:
```dart
runApp(
  ProviderScope(
    observers: [TalkerRiverpodObserver(talker: AppLogger.instance)],
    child: const LeadXApp(),
  ),
);
```

Note: `ProviderScope` drops `const` because `observers` is a runtime value.

**Note about `lib/app.dart`:** No changes needed to app.dart itself. The TalkerRouteObserver for GoRouter is optional and can be added later -- the critical path is error forwarding to Sentry and module-prefixed logging.
  </action>
  <verify>
1. `flutter pub get` succeeds.
2. `flutter analyze` passes with no errors in the new files or main.dart.
3. `lib/core/logging/app_logger.dart` exists with `AppLogger.init()` and `AppLogger.instance`.
4. `lib/core/logging/sentry_observer.dart` exists with `SentryTalkerObserver`.
5. `main.dart` calls `AppLogger.init()` before `SentryFlutter.init()`.
6. `ProviderScope` has `TalkerRiverpodObserver`.
7. `logger` package is removed from pubspec.yaml.
  </verify>
  <done>
AppLogger singleton with SentryTalkerObserver is initialized at app startup. Talker errors auto-forward to Sentry. Warning+ logs become Sentry breadcrumbs. Riverpod provider events are logged. Unused logger package is removed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace all debugPrint calls with Talker logging across 26 files</name>
  <files>
    lib/data/services/sync_service.dart
    lib/data/services/connectivity_service.dart
    lib/data/services/camera_service.dart
    lib/data/services/gps_service.dart
    lib/data/repositories/activity_repository_impl.dart
    lib/data/repositories/auth_repository_impl.dart
    lib/data/repositories/customer_repository_impl.dart
    lib/data/repositories/pipeline_repository_impl.dart
    lib/data/repositories/pipeline_referral_repository_impl.dart
    lib/data/repositories/scoreboard_repository_impl.dart
    lib/data/repositories/cadence_repository_impl.dart
    lib/data/datasources/remote/activity_remote_data_source.dart
    lib/data/datasources/remote/customer_remote_data_source.dart
    lib/data/datasources/remote/pipeline_referral_remote_data_source.dart
    lib/data/database/app_database.dart
    lib/presentation/providers/activity_providers.dart
    lib/presentation/providers/sync_providers.dart
    lib/presentation/providers/pipeline_referral_providers.dart
    lib/presentation/widgets/sync/sync_progress_sheet.dart
    lib/presentation/screens/auth/splash_screen.dart
    lib/presentation/screens/auth/login_screen.dart
    lib/presentation/screens/auth/reset_password_screen.dart
    lib/presentation/screens/home/home_screen.dart
    lib/presentation/screens/cadence/host_dashboard_screen.dart
    lib/presentation/screens/cadence/cadence_list_screen.dart
    lib/presentation/screens/referral/referral_list_screen.dart
  </files>
  <action>
Replace ALL `debugPrint(...)` calls in `lib/` with Talker calls using `AppLogger.instance`.

**Module prefix convention** (pipe-separated):
```
sync.queue | message     # SyncService queue operations
sync.push | message      # SyncService push/process operations
sync.pull | message      # SyncNotifier/providers pull operations
auth | message           # Auth repository, login screen
db | message             # Database operations, migrations
connectivity | message   # ConnectivityService
gps | message            # GPS service
camera | message         # Camera service
customer | message       # Customer repository
pipeline | message       # Pipeline repository
pipeline.referral | message  # Pipeline referral repository
activity | message       # Activity repository, providers
cadence | message        # Cadence repository, screens
scoreboard | message     # Scoreboard repository
ui.sync | message        # Sync progress sheet, sync providers UI
ui.home | message        # Home screen
ui.referral | message    # Referral list screen
```

**Replacement rules:**

1. **Add import to each file:** `import 'package:YOUR_PATH/core/logging/app_logger.dart';`
   Use the correct relative path based on the file's location.

2. **Create a `_log` field** at the top of each class (or use `AppLogger.instance` directly for top-level functions):
   ```dart
   final _log = AppLogger.instance;
   ```

3. **Replace each debugPrint call based on content:**
   - **Informational messages** (normal flow): `_log.info('module | message')`
   - **Error/failure messages** (catch blocks): `_log.error('module | message', exception, stackTrace)`
   - **Warning messages** (unexpected but non-fatal): `_log.warning('module | message')`
   - **Debug/verbose messages** (detailed debugging): `_log.debug('module | message')`

4. **Map existing patterns:**
   - `debugPrint('[SyncService] processQueue called...')` -> `_log.info('sync.queue | processQueue called, isSyncing=$_isSyncing')`
   - `debugPrint('[SyncService] Failed to sync ...: $e')` -> `_log.error('sync.push | Failed: ${item.entityType}/${item.entityId}', e)`
   - `debugPrint('[SyncService] Successfully synced...')` -> `_log.debug('sync.push | Synced: ${item.entityType}/${item.entityId}')`
   - `debugPrint('[LoginScreen] Login success...')` -> `_log.info('auth | Login success, hasInitialSynced=$hasInitialSynced')`
   - `debugPrint('[ConnectivityService] ...')` -> `_log.info('connectivity | message')`

5. **For SyncService specifically** (highest priority, 12 calls):
   - Use `sync.queue` for queue management (processQueue entry, pending count)
   - Use `sync.push` for item processing (processing item, success, failure)
   - Use `sync.push` for mark-as-synced and hard-delete operations
   - Use `sync.pull` for any pull-related operations (if any exist)

6. **For error catch blocks:** Use `_log.error(message, error, stackTrace)` -- the three-argument form ensures the error object is passed to Talker, which forwards to Sentry via the observer.

7. **Remove `import 'package:flutter/foundation.dart';`** from files that ONLY imported it for `debugPrint`. Check first that the file doesn't also use `kReleaseMode`, `kDebugMode`, `@visibleForTesting`, or other foundation exports. If it does, keep the import.

8. **For files in `lib/presentation/`** (widgets and screens): These are `ConsumerWidget`/`ConsumerStatefulWidget` classes. Access `AppLogger.instance` directly or create a local variable in the method. Do NOT create instance fields on widgets (they're const). Use:
   ```dart
   final log = AppLogger.instance;
   log.info('ui.sync | message');
   ```

**Files sorted by priority (data layer first, presentation second):**

HIGH PRIORITY (sync operations):
- `lib/data/services/sync_service.dart` (12 calls) - sync.queue, sync.push
- `lib/presentation/providers/sync_providers.dart` (38 calls) - sync.pull, sync.push
- `lib/data/repositories/pipeline_referral_repository_impl.dart` (65 calls) - pipeline.referral
- `lib/data/repositories/activity_repository_impl.dart` (32 calls) - activity

MEDIUM PRIORITY (data layer):
- `lib/data/repositories/auth_repository_impl.dart` (22 calls) - auth
- `lib/presentation/providers/activity_providers.dart` (13 calls) - activity
- `lib/data/repositories/pipeline_repository_impl.dart` (13 calls) - pipeline
- `lib/data/services/connectivity_service.dart` (8 calls) - connectivity
- `lib/data/repositories/cadence_repository_impl.dart` (8 calls) - cadence
- `lib/data/repositories/customer_repository_impl.dart` (7 calls) - customer
- `lib/presentation/widgets/sync/sync_progress_sheet.dart` (10 calls) - ui.sync
- `lib/presentation/providers/pipeline_referral_providers.dart` (6 calls) - pipeline.referral
- `lib/presentation/screens/auth/splash_screen.dart` (6 calls) - auth

LOWER PRIORITY (fewer calls):
- `lib/data/services/camera_service.dart` (5 calls) - camera
- `lib/data/services/gps_service.dart` (4 calls) - gps
- `lib/data/datasources/remote/activity_remote_data_source.dart` (4 calls) - activity.remote
- `lib/presentation/screens/auth/login_screen.dart` (4 calls) - auth
- `lib/data/repositories/scoreboard_repository_impl.dart` (3 calls) - scoreboard
- `lib/data/datasources/remote/customer_remote_data_source.dart` (3 calls) - customer.remote
- `lib/presentation/screens/auth/reset_password_screen.dart` (3 calls) - auth
- `lib/presentation/screens/home/home_screen.dart` (3 calls) - ui.home
- `lib/data/database/app_database.dart` (1 call) - db
- `lib/presentation/screens/cadence/host_dashboard_screen.dart` (1 call) - cadence
- `lib/presentation/screens/cadence/cadence_list_screen.dart` (1 call) - cadence
- `lib/data/datasources/remote/pipeline_referral_remote_data_source.dart` (1 call) - pipeline.referral.remote
- `lib/presentation/screens/referral/referral_list_screen.dart` (1 call) - ui.referral

**IMPORTANT:** After replacing all debugPrint calls, run a search to verify ZERO `debugPrint` calls remain in `lib/`:
```bash
grep -r "debugPrint" lib/
```
If any remain, replace them.
  </action>
  <verify>
1. `flutter analyze` passes with no errors across all 26 modified files.
2. Search for `debugPrint` in `lib/` returns 0 results: `grep -r "debugPrint" lib/` produces no output.
3. Search for `AppLogger` import in the modified files confirms all 26 files import it.
4. `sync_service.dart` uses `sync.queue` and `sync.push` prefixes.
5. `sync_providers.dart` uses `sync.pull` and `sync.push` prefixes.
6. No file imports `package:flutter/foundation.dart` solely for debugPrint (removed where possible).
  </verify>
  <done>
All 274 debugPrint calls across 26 files are replaced with Talker logging using module prefixes. Zero debugPrint calls remain in lib/. All sync operations use sync.queue, sync.push, sync.pull prefixes. Error-level logs pass exception objects for Sentry forwarding.
  </done>
</task>

</tasks>

<verification>
1. `flutter pub get` succeeds (talker packages added, logger removed)
2. `flutter analyze` passes with no new errors
3. `grep -r "debugPrint" lib/` returns 0 results
4. `grep -r "logger:" pubspec.yaml` returns 0 results (logger package removed)
5. `lib/core/logging/app_logger.dart` exists with AppLogger singleton
6. `lib/core/logging/sentry_observer.dart` exists with SentryTalkerObserver
7. `main.dart` initializes AppLogger before SentryFlutter.init
8. `ProviderScope` has TalkerRiverpodObserver
</verification>

<success_criteria>
- Talker structured logging replaces all debugPrint calls
- Module prefixes (sync.queue, sync.push, sync.pull, auth, db, etc.) enable filtered log searching
- Errors auto-forward to Sentry via SentryTalkerObserver
- Warning+ logs become Sentry breadcrumbs for crash context
- Riverpod provider lifecycle events are logged
- Unused logger package is removed from dependencies
- App compiles and runs without any debugPrint references
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-observability/01-03-SUMMARY.md`
</output>
