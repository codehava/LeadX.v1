---
phase: 08-stubbed-feature-completion
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/presentation/screens/profile/notification_settings_screen.dart
  - lib/data/datasources/local/notification_settings_local_data_source.dart
  - lib/presentation/providers/notification_settings_providers.dart
  - lib/config/routes/app_router.dart
  - lib/presentation/screens/profile/settings_screen.dart
autonomous: true
requirements:
  - FEAT-05

must_haves:
  truths:
    - "User tapping 'Pengaturan Notifikasi' on Settings screen navigates to notification settings screen"
    - "Notification settings screen shows toggle switches for all 7 notification categories"
    - "User can toggle switches and changes persist to local database immediately"
    - "Reminder minutes dropdown allows selecting 5, 10, 15, 30, or 60 minutes"
    - "Settings are grouped into General, Categories, and Timing sections"
  artifacts:
    - path: "lib/presentation/screens/profile/notification_settings_screen.dart"
      provides: "Notification settings screen with toggle UI"
      contains: "NotificationSettingsScreen"
    - path: "lib/data/datasources/local/notification_settings_local_data_source.dart"
      provides: "CRUD operations for notification_settings table"
      contains: "NotificationSettingsLocalDataSource"
    - path: "lib/presentation/providers/notification_settings_providers.dart"
      provides: "StreamProvider and notifier for notification settings"
      contains: "notificationSettingsProvider"
    - path: "lib/config/routes/app_router.dart"
      provides: "Route pointing to NotificationSettingsScreen"
      contains: "NotificationSettingsScreen"
  key_links:
    - from: "lib/presentation/screens/profile/settings_screen.dart"
      to: "lib/config/routes/app_router.dart"
      via: "context.push or context.go to notification settings route"
      pattern: "notifications"
    - from: "lib/presentation/screens/profile/notification_settings_screen.dart"
      to: "lib/presentation/providers/notification_settings_providers.dart"
      via: "ref.watch and ref.read for settings state"
      pattern: "notificationSettingsProvider"
    - from: "lib/presentation/providers/notification_settings_providers.dart"
      to: "lib/data/datasources/local/notification_settings_local_data_source.dart"
      via: "provider reads/writes via data source"
      pattern: "NotificationSettingsLocalDataSource"
---

<objective>
Create notification settings screen with toggle UI backed by the existing NotificationSettings database table, wire it from the settings screen, and replace the "coming soon" snackbar.

Purpose: Give users a working notification preferences screen even before push notifications are fully wired, persisting choices locally for future use.
Output: NotificationSettingsScreen with 7 category toggles + reminder time dropdown, navigable from Settings.
</objective>

<execution_context>
@C:/Users/cartr/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/cartr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-stubbed-feature-completion/08-RESEARCH.md

@lib/data/database/tables/notifications.dart
@lib/data/database/app_database.dart
@lib/presentation/screens/profile/settings_screen.dart
@lib/config/routes/app_router.dart
@lib/config/routes/route_names.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create notification settings data source and providers</name>
  <files>
    lib/data/datasources/local/notification_settings_local_data_source.dart
    lib/presentation/providers/notification_settings_providers.dart
  </files>
  <action>
**1. Local data source** (lib/data/datasources/local/notification_settings_local_data_source.dart):
Create a new file with `NotificationSettingsLocalDataSource` class:
- Constructor takes `AppDatabase` (follow existing local data source pattern, e.g., customer_local_data_source.dart)
- `Stream<NotificationSettingsData?> watchSettings(String userId)` — watch the notification_settings row for the current user. Use Drift's `select` + `watchSingleOrNull()`.
- `Future<NotificationSettingsData?> getSettings(String userId)` — get current settings row.
- `Future<void> upsertSettings(NotificationSettingsCompanion companion)` — insert or update settings. Use Drift's `into(db.notificationSettings).insertOnConflictUpdate(companion)` or equivalent pattern.
- `Future<void> ensureDefaultSettings(String userId)` — check if settings row exists for userId; if not, insert default row with all booleans = true and reminderMinutesBefore = 30.

Check the actual `NotificationSettings` table definition in `lib/data/database/tables/notifications.dart` for exact column names and types.

**2. Providers** (lib/presentation/providers/notification_settings_providers.dart):
Create a new file with:

- `notificationSettingsLocalDataSourceProvider` — Provider that creates `NotificationSettingsLocalDataSource` from `appDatabaseProvider` (follow pattern of existing data source providers)
- `notificationSettingsProvider` — `StreamProvider` that watches settings for current user. Get current user ID from `currentUserProvider` or `authProvider`. Call `localDataSource.watchSettings(userId)`. If null (first access), call `ensureDefaultSettings(userId)` and return default.
- `NotificationSettingsNotifier` — `AsyncNotifier` or class with methods to update individual settings:
  - `updatePushEnabled(bool value)`
  - `updateEmailEnabled(bool value)`
  - `updateActivityReminders(bool value)`
  - `updatePipelineUpdates(bool value)`
  - `updateReferralNotifications(bool value)`
  - `updateCadenceReminders(bool value)`
  - `updateSystemNotifications(bool value)`
  - `updateReminderMinutesBefore(int value)`

  Each method calls `localDataSource.upsertSettings()` with a `NotificationSettingsCompanion` that only sets the changed field plus `updatedAt`. No sync queuing — notification settings are local-only per research recommendation.

Follow the existing provider patterns in `lib/presentation/providers/` (check `settings_providers.dart` for the app settings pattern as a reference).

**Notification settings are local-only** — no sync to Supabase, no queue operation. These are device preferences.
  </action>
  <verify>Run `flutter analyze` to check for compilation errors in the two new files. Verify provider names follow existing naming conventions. Verify the data source uses Drift correctly for the NotificationSettings table.</verify>
  <done>NotificationSettingsLocalDataSource provides CRUD for notification_settings table with watch stream. Provider layer has StreamProvider for reactive UI and notifier with individual update methods. Default settings are created on first access.</done>
</task>

<task type="auto">
  <name>Task 2: Create notification settings screen and wire from settings</name>
  <files>
    lib/presentation/screens/profile/notification_settings_screen.dart
    lib/config/routes/app_router.dart
    lib/presentation/screens/profile/settings_screen.dart
  </files>
  <action>
**1. NotificationSettingsScreen** (lib/presentation/screens/profile/notification_settings_screen.dart):
Create a new `ConsumerWidget` screen with:

- AppBar title: "Pengaturan Notifikasi"
- Watch `notificationSettingsProvider` with `AsyncValue.when(data:, loading:, error:)` pattern
- Body is a `ListView` with sections:

**Section: "Umum" (General)**
- `SwitchListTile` for "Push Notification" — `settings.pushEnabled`
  - Subtitle: "Terima notifikasi push di perangkat"
- `SwitchListTile` for "Email Notification" — `settings.emailEnabled`
  - Subtitle: "Terima notifikasi melalui email"

**Section: "Kategori" (Categories)**
- `SwitchListTile` for "Pengingat Aktivitas" — `settings.activityReminders`
  - Subtitle: "Pengingat sebelum aktivitas terjadwal"
- `SwitchListTile` for "Update Pipeline" — `settings.pipelineUpdates`
  - Subtitle: "Perubahan status dan tahapan pipeline"
- `SwitchListTile` for "Notifikasi Referral" — `settings.referralNotifications`
  - Subtitle: "Status persetujuan dan update referral"
- `SwitchListTile` for "Pengingat Cadence" — `settings.cadenceReminders`
  - Subtitle: "Jadwal pertemuan cadence mingguan"
- `SwitchListTile` for "Notifikasi Sistem" — `settings.systemNotifications`
  - Subtitle: "Pembaruan sistem dan maintenance"

**Section: "Waktu Pengingat" (Timing)**
- `ListTile` with title "Pengingat Sebelum Aktivitas" and a dropdown (or `PopupMenuButton`) to select reminder minutes: 5, 10, 15, 30, 60. Display selected value as subtitle: "${minutes} menit sebelum".

Each `SwitchListTile.onChanged` calls the corresponding notifier update method. Changes persist immediately to DB — no save button needed.

Use `_buildSectionHeader` helper (same pattern as settings_screen.dart) for section headers. Use `Card` wrapping for each section's list tiles.

Error state: Use `AppErrorState.general()` for error callback. Loading state: `CircularProgressIndicator`.

**2. Route update** (lib/config/routes/app_router.dart):
The existing `notifications` route at `/home/notifications` currently shows a `Placeholder`. Update it to show `NotificationSettingsScreen` instead. Add the import for the new screen. Keep the existing route name and path — just replace the `Placeholder` with the actual screen widget.

**3. Settings screen update** (lib/presentation/screens/profile/settings_screen.dart):
Replace the snackbar-showing `onTap` of the "Pengaturan Notifikasi" ListTile with navigation:
```dart
onTap: () => context.go('/home/notifications'),
```
Remove the snackbar code and the `// TODO: Navigate to notification settings when implemented` comment.
  </action>
  <verify>Run `flutter analyze` to check no compilation errors. Verify the route points to NotificationSettingsScreen. Verify settings_screen.dart navigates to the route instead of showing snackbar.</verify>
  <done>NotificationSettingsScreen shows grouped toggle UI with 7 category switches and reminder time dropdown. Route /home/notifications points to the screen. Settings screen navigates to it instead of showing "coming soon" snackbar. All toggle changes persist immediately to local Drift database.</done>
</task>

</tasks>

<verification>
1. `flutter analyze` passes with no errors in all new and modified files
2. Settings screen "Pengaturan Notifikasi" tile navigates to notification settings screen
3. Notification settings screen shows all 7 toggle switches organized in sections
4. Toggles update local database immediately on change
5. Reminder minutes dropdown offers 5, 10, 15, 30, 60 minute options
6. Default settings (all true, 30 minutes) are created on first access
7. Screen uses Indonesian labels consistent with rest of app
</verification>

<success_criteria>
- Notification settings screen is navigable from Settings menu
- All 7 notification category toggles work and persist to DB
- Reminder time can be changed and persists
- Settings are local-only (no sync operations)
- UI follows existing app conventions (Indonesian labels, Card sections, SwitchListTile)
</success_criteria>

<output>
After completion, create `.planning/phases/08-stubbed-feature-completion/08-04-SUMMARY.md`
</output>
