---
phase: 08-stubbed-feature-completion
plan: 02
type: execute
wave: 2
depends_on:
  - "08-01"
  - "08-03"
files_modified:
  - lib/presentation/screens/customer/customer_detail_screen.dart
  - lib/presentation/screens/hvc/hvc_detail_screen.dart
  - lib/presentation/screens/activity/activity_detail_screen.dart
  - lib/presentation/screens/broker/broker_detail_screen.dart
  - lib/presentation/providers/customer_providers.dart
autonomous: true
requirements:
  - FEAT-03

must_haves:
  truths:
    - "User tapping phone number on customer detail info tab launches phone dialer"
    - "User tapping email on customer detail info tab launches email client"
    - "User tapping phone/email buttons on key person cards (customer detail + HVC detail) launches dialer/email"
    - "User tapping PIC contact info on activity detail launches phone dialer or email client"
    - "User tapping phone/email on broker detail info tab launches dialer/email client"
    - "Every phone number and email address displayed in the app is tappable"
  artifacts:
    - path: "lib/presentation/screens/customer/customer_detail_screen.dart"
      provides: "Tappable phone/email in info tab + wired key person card buttons"
      contains: "launchUrl.*tel:"
    - path: "lib/presentation/screens/hvc/hvc_detail_screen.dart"
      provides: "Wired key person card phone/email buttons"
      contains: "launchUrl.*tel:"
    - path: "lib/presentation/screens/activity/activity_detail_screen.dart"
      provides: "PIC contact actions (phone + email)"
      contains: "launchUrl.*tel:"
    - path: "lib/presentation/screens/broker/broker_detail_screen.dart"
      provides: "Tappable phone/email in info tab + key person contact actions"
      contains: "launchUrl.*tel:"
  key_links:
    - from: "all detail screens"
      to: "url_launcher"
      via: "launchUrl(Uri.parse('tel:...'))"
      pattern: "launchUrl\\(Uri\\.parse\\('tel:"
    - from: "lib/presentation/screens/activity/activity_detail_screen.dart"
      to: "lib/presentation/providers/customer_providers.dart"
      via: "keyPersonByIdProvider to look up PIC phone/email from keyPersonId"
      pattern: "keyPersonByIdProvider"
---

<objective>
Make every phone number and email address displayed in the app tappable: tap phone opens dialer, tap email opens email client. Apply uniformly across customer, HVC, activity, and broker detail screens.

Purpose: Enable sales reps to quickly contact customers and key persons directly from any detail screen without manual number copying.
Output: All phone/email fields and key person card buttons across 4 detail screens launch native dialer/email via url_launcher.

Note: Depends on 08-01 (shares customer_detail_screen.dart) and 08-03 (shares activity_detail_screen.dart). Both are file-conflict guards — 08-03 adds the edit button to activity_detail_screen.dart, while this plan adds contact launchers to the same file. Running after 08-03 avoids merge conflicts.
</objective>

<execution_context>
@C:/Users/cartr/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/cartr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-stubbed-feature-completion/08-RESEARCH.md

@lib/presentation/screens/customer/customer_detail_screen.dart
@lib/presentation/screens/hvc/hvc_detail_screen.dart
@lib/presentation/screens/activity/activity_detail_screen.dart
@lib/presentation/screens/broker/broker_detail_screen.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire contact launchers on customer and HVC detail screens</name>
  <files>
    lib/presentation/screens/customer/customer_detail_screen.dart
    lib/presentation/screens/hvc/hvc_detail_screen.dart
  </files>
  <action>
**Customer detail screen:**

1. **Info tab phone/email fields**: Find the `_InfoTab` widget or `_InfoRow` widgets displaying phone and email. Make them tappable by wrapping with `GestureDetector` or `InkWell`, or adding an `onTap` callback. When phone is tapped, call `launchUrl(Uri.parse('tel:${phone}'))`. When email is tapped, call `launchUrl(Uri.parse('mailto:${email}'))`. Style the tappable text with primary color and underline to indicate it's tappable. The screen already imports `url_launcher` and likely has a `_launchUrl` helper — reuse it.

2. **Key person cards phone button**: Find the `_KeyPersonCard` widget. The phone `IconButton` currently has `// TODO: Call` — wire it to `launchUrl(Uri.parse('tel:${keyPerson.phone}'))`.

3. **Key person cards email button**: Find the COMMENTED OUT email `IconButton` in `_KeyPersonCard`. Uncomment it and wire to `launchUrl(Uri.parse('mailto:${keyPerson.email}'))`. Only show if `keyPerson.email != null`.

**HVC detail screen:**

1. **Key person cards phone button**: Find the `_KeyPersonCard` widget. Wire the phone button (currently has `// TODO: Launch phone`) to `launchUrl(Uri.parse('tel:${keyPerson.phone}'))`.

2. **Key person cards email button**: Find the COMMENTED OUT email `IconButton`. Uncomment it and wire to `launchUrl(Uri.parse('mailto:${keyPerson.email}'))`. Only show if `keyPerson.email != null`.

3. **HVC main contact fields**: HVC entity itself has NO phone/email fields (contact is only on key persons), so no info tab changes needed for HVC.

4. If `url_launcher` is not already imported in hvc_detail_screen.dart, add the import.

For all `launchUrl` calls, use the existing pattern from customer_detail_screen.dart (check if there's a `_launchUrl` helper that does `canLaunchUrl` check first). If a helper exists, reuse that pattern. If not, at minimum use `launchUrl(uri)` directly — url_launcher handles failures gracefully.
  </action>
  <verify>Run `flutter analyze` on both modified files. Verify no commented-out email buttons remain. Verify all `// TODO: Call` and `// TODO: Launch phone` comments are replaced with actual launchUrl calls.</verify>
  <done>Customer detail info tab phone/email are tappable. Customer and HVC key person card phone buttons are wired. Email buttons are uncommented and wired on both screens. All use launchUrl with tel: and mailto: schemes.</done>
</task>

<task type="auto">
  <name>Task 2: Wire contact launchers on activity and broker detail screens</name>
  <files>
    lib/presentation/screens/activity/activity_detail_screen.dart
    lib/presentation/screens/broker/broker_detail_screen.dart
    lib/presentation/providers/customer_providers.dart
  </files>
  <action>
**Activity detail screen:**

The Activity entity only stores `keyPersonId` (String?) and `keyPersonName` (String?) — it does NOT include key person phone or email. A key person lookup is required.

1. **Key person lookup**: The `KeyPersonLocalDataSource` has a `getKeyPersonById(String id)` method that returns `KeyPerson?` with `phone` and `email` fields. No existing provider exposes single key person by ID. Create a `FutureProvider.family` in this file (or in `customer_providers.dart` if preferred) to look up a key person:
   ```dart
   final keyPersonByIdProvider = FutureProvider.family<KeyPerson?, String>((ref, id) async {
     final ds = ref.watch(keyPersonLocalDataSourceProvider);
     return ds.getKeyPersonById(id);
   });
   ```
   Import `KeyPersonLocalDataSource` from the data layer and `keyPersonLocalDataSourceProvider` from `customer_providers.dart`. Import the `KeyPerson` entity.

2. **Display PIC contact buttons**: In the activity detail screen, where the PIC name is displayed (look for `keyPersonName` usage around line ~131), add a conditional section:
   - If `activity.keyPersonId != null`, watch `keyPersonByIdProvider(activity.keyPersonId!)` to get the full key person data
   - If the key person has a `phone`, show a phone `IconButton` that calls `launchUrl(Uri.parse('tel:${keyPerson.phone}'))`
   - If the key person has an `email`, show an email `IconButton` that calls `launchUrl(Uri.parse('mailto:${keyPerson.email}'))`
   - If key person lookup returns null or has no phone/email, show only the PIC name text (no buttons)

3. If `url_launcher` is not already imported, add `import 'package:url_launcher/url_launcher.dart';`.

**Broker detail screen:**

1. **Info tab phone/email fields**: Find the `_InfoTab` or `_InfoRow` widgets displaying broker phone and email. Make them tappable using the same pattern as customer detail — `GestureDetector`/`InkWell` wrapping with `launchUrl(Uri.parse('tel:${phone}'))` and `launchUrl(Uri.parse('mailto:${email}'))`. Style with primary color and underline.

2. **Broker key person cards**: Check the `_KeyPersonCard` widget in broker_detail_screen.dart. Research says it uses `ListTile` style without dedicated buttons. Add `IconButton` widgets for phone and email to the trailing section of the ListTile, or convert to the same card pattern used in customer/HVC screens. If key person has phone, show phone IconButton. If key person has email, show email IconButton.

3. If `url_launcher` is not already imported, add `import 'package:url_launcher/url_launcher.dart';`.

For all screens, use consistent styling: phone/email text should use `colorScheme.primary` color with `TextDecoration.underline` to visually indicate tappability.
  </action>
  <verify>Run `flutter analyze` on both modified files. Verify activity detail has PIC contact actions. Verify broker detail has tappable phone/email in info tab and key person cards.</verify>
  <done>Activity detail PIC section has phone and email action buttons. Broker detail info tab phone/email are tappable. Broker key person cards have phone and email action buttons. All use launchUrl with tel: and mailto: schemes consistently.</done>
</task>

</tasks>

<verification>
1. `flutter analyze` passes with no errors in all 4 modified files
2. Customer detail: info tab phone/email are tappable, key person phone wired, email uncommented and wired
3. HVC detail: key person phone wired, email uncommented and wired
4. Activity detail: PIC has phone/email contact action buttons
5. Broker detail: info tab phone/email tappable, key person cards have phone/email buttons
6. All use url_launcher's `launchUrl()` with `tel:` and `mailto:` URI schemes
</verification>

<success_criteria>
- Every phone number displayed anywhere in customer, HVC, activity, and broker detail screens is tappable and opens phone dialer
- Every email address displayed anywhere in those screens is tappable and opens email client
- Contact buttons on key person cards work uniformly across all screens
</success_criteria>

<output>
After completion, create `.planning/phases/08-stubbed-feature-completion/08-02-SUMMARY.md`
</output>
