---
phase: 08-stubbed-feature-completion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/presentation/screens/customer/customer_detail_screen.dart
  - lib/data/repositories/customer_repository_impl.dart
  - lib/data/datasources/local/key_person_local_data_source.dart
  - lib/data/datasources/local/pipeline_local_data_source.dart
  - lib/data/datasources/local/activity_local_data_source.dart
autonomous: true
requirements:
  - FEAT-01
  - FEAT-02

must_haves:
  truths:
    - "User tapping Share in customer detail popup menu launches native share sheet with customer name, address, phone, email"
    - "User tapping Delete in customer detail popup menu sees confirmation dialog warning about related data"
    - "Confirming delete soft-deletes customer AND cascade soft-deletes key persons, pipelines, activities"
    - "After delete confirmation, user navigates to customer list (not just one screen back)"
    - "Delete operation is queued for offline sync"
  artifacts:
    - path: "lib/presentation/screens/customer/customer_detail_screen.dart"
      provides: "Share implementation via share_plus and delete wiring with navigation"
      contains: "Share.share"
    - path: "lib/data/repositories/customer_repository_impl.dart"
      provides: "Cascade soft-delete in deleteCustomer transaction"
      contains: "softDeleteByCustomerId"
    - path: "lib/data/datasources/local/key_person_local_data_source.dart"
      provides: "Batch soft-delete by customer ID"
      contains: "softDeleteByCustomerId"
    - path: "lib/data/datasources/local/pipeline_local_data_source.dart"
      provides: "Batch soft-delete by customer ID"
      contains: "softDeleteByCustomerId"
    - path: "lib/data/datasources/local/activity_local_data_source.dart"
      provides: "Batch soft-delete by customer ID"
      contains: "softDeleteByCustomerId"
  key_links:
    - from: "lib/presentation/screens/customer/customer_detail_screen.dart"
      to: "share_plus"
      via: "Share.share() call in _handleMenuAction"
      pattern: "Share\\.share"
    - from: "lib/data/repositories/customer_repository_impl.dart"
      to: "local data sources"
      via: "cascade softDeleteByCustomerId calls inside transaction"
      pattern: "softDeleteByCustomerId"
---

<objective>
Wire customer detail share and delete actions: implement native share sheet via share_plus and cascade soft-delete with confirmation dialog, offline sync queuing, and navigation to customer list.

Purpose: Complete two stubbed customer detail actions (share and delete) that currently show TODO comments or incomplete behavior.
Output: Working share and delete buttons on customer detail screen with cascade delete in the data layer.
</objective>

<execution_context>
@C:/Users/cartr/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/cartr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-stubbed-feature-completion/08-RESEARCH.md

@lib/presentation/screens/customer/customer_detail_screen.dart
@lib/data/repositories/customer_repository_impl.dart
@lib/data/datasources/local/customer_local_data_source.dart
@lib/data/datasources/local/key_person_local_data_source.dart
@lib/data/datasources/local/pipeline_local_data_source.dart
@lib/data/datasources/local/activity_local_data_source.dart
@lib/domain/repositories/customer_repository.dart
@lib/presentation/providers/customer_providers.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add cascade soft-delete methods to local data sources and update repository</name>
  <files>
    lib/data/datasources/local/key_person_local_data_source.dart
    lib/data/datasources/local/pipeline_local_data_source.dart
    lib/data/datasources/local/activity_local_data_source.dart
    lib/data/repositories/customer_repository_impl.dart
  </files>
  <action>
Add `softDeleteByCustomerId(String customerId)` method to three local data sources:

1. **key_person_local_data_source.dart**: Add method that updates all key_persons where `customerId` matches and `deletedAt` is null, setting `deletedAt` and `updatedAt` to `DateTime.now()`. Use Drift's `update` with `where` clause pattern matching the existing `softDeleteCustomer` in customer_local_data_source.dart.

2. **pipeline_local_data_source.dart**: Same pattern — update all pipelines where `customerId` matches and `deletedAt` is null. Set `deletedAt` and `updatedAt`.

3. **activity_local_data_source.dart**: Same pattern — update all activities where `customerId` matches and `deletedAt` is null. Set `deletedAt` and `updatedAt`.

4. **customer_repository_impl.dart**: Update the existing `deleteCustomer` method to call all three cascade soft-delete methods INSIDE the existing Drift transaction, BEFORE the customer's own soft-delete. The repository already has `_database.transaction()` wrapping the delete — add the cascade calls inside it. The repository constructor already injects the relevant data sources (check constructor params — if any data source is missing, add it as a constructor parameter and update the provider).

The cascade calls should be:
```dart
await _keyPersonLocalDataSource.softDeleteByCustomerId(id);
await _pipelineLocalDataSource.softDeleteByCustomerId(id);
await _activityLocalDataSource.softDeleteByCustomerId(id);
```

Only queue the CUSTOMER delete for sync (not the cascaded entities) — the backend handles cascade deletion. This follows the research recommendation.

**Role-based permissions (Claude's discretion):** Allow any authenticated user to delete customers they can see — no additional role check needed. The soft-delete is DB-recoverable by admin. This matches the existing edit access pattern.
  </action>
  <verify>Run `flutter analyze` to check for compilation errors in the modified files. Verify that the new methods exist and the repository transaction includes all cascade calls.</verify>
  <done>Three local data sources have `softDeleteByCustomerId` methods. CustomerRepositoryImpl.deleteCustomer cascade-deletes related key persons, pipelines, and activities within the transaction before soft-deleting the customer itself. Only the customer delete is queued for sync.</done>
</task>

<task type="auto">
  <name>Task 2: Wire share and delete actions in customer detail screen</name>
  <files>
    lib/presentation/screens/customer/customer_detail_screen.dart
  </files>
  <action>
Wire two existing menu actions in customer_detail_screen.dart:

**Share action (FEAT-01):**
1. Add `import 'package:share_plus/share_plus.dart';` at top of file.
2. Find the `case 'share':` in `_handleMenuAction` (currently has `// TODO: Implement share`).
3. Replace the TODO with share implementation using the legacy `Share.share()` API (project uses share_plus ^10.1.4):
```dart
case 'share':
  final lines = <String>[customer.name];
  if (customer.companyName != null && customer.companyName!.isNotEmpty) {
    lines.add(customer.companyName!);
  }
  if (customer.address.isNotEmpty) lines.add(customer.address);
  if (customer.phone != null) lines.add('Tel: ${customer.phone}');
  if (customer.email != null) lines.add('Email: ${customer.email}');
  if (customer.website != null) lines.add('Web: ${customer.website}');
  await Share.share(
    lines.join('\n'),
    subject: 'Customer: ${customer.name}',
  );
  break;
```
Check the actual Customer entity fields (check `lib/domain/entities/customer.dart`) to use the correct field names. Include company name, address, phone, email, and website if they exist.

**Delete action (FEAT-02):**
1. Find the existing delete confirmation dialog (should have Indonesian text like "Hapus Nasabah").
2. Update the confirmation dialog text to include a warning about related data being deleted: "Semua data terkait (key person, pipeline, aktivitas) juga akan dihapus."
3. Wire the confirm button to call the customer delete notifier/provider method. Look at `CustomerListNotifier` or `CustomerDetailNotifier` — find the existing `deleteCustomer` call pattern. If no notifier method exists, call the repository directly via provider.
4. After successful delete, show a success snackbar: "Nasabah berhasil dihapus"
5. Navigate to customer list using `context.go('/home/customers')` — NOT `context.pop()` — per user decision.
6. Handle error case: show error snackbar on failure.

**IMPORTANT:** Use `Share.share()` NOT `SharePlus.instance.share(ShareParams)` — the project uses share_plus ^10.1.4 which has the legacy API.
**IMPORTANT:** Use `context.go('/home/customers')` for navigation after delete, NOT `context.pop()`.
  </action>
  <verify>Run `flutter analyze` to confirm no compilation errors. Verify share_plus import is present and Share.share() is called. Verify delete dialog has warning text and navigates via context.go('/home/customers').</verify>
  <done>Share menu action launches native share sheet with customer data (name, company, phone, email, website). Delete menu action shows confirmation dialog with related-data warning, calls cascade soft-delete, shows success snackbar, and navigates to customer list via context.go().</done>
</task>

</tasks>

<verification>
1. `flutter analyze` passes with no errors in modified files
2. Share action in customer detail popup menu calls `Share.share()` with customer data
3. Delete action shows confirmation dialog with cascade warning in Indonesian
4. Confirmed delete calls `deleteCustomer` which cascade-deletes key persons, pipelines, activities
5. After delete, navigation goes to `/home/customers` (customer list)
6. Only customer delete (not cascaded entities) is queued for sync
</verification>

<success_criteria>
- Share button launches native share sheet with customer name, company, address, phone, email
- Delete button shows confirmation, cascade-deletes all related data, navigates to customer list
- Both actions work in offline mode (delete queued for sync, share is local-only)
</success_criteria>

<output>
After completion, create `.planning/phases/08-stubbed-feature-completion/08-01-SUMMARY.md`
</output>
