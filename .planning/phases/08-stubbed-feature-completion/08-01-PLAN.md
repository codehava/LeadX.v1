---
phase: 08-stubbed-feature-completion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/presentation/screens/customer/customer_detail_screen.dart
  - lib/data/repositories/customer_repository_impl.dart
  - lib/data/datasources/local/key_person_local_data_source.dart
  - lib/data/datasources/local/pipeline_local_data_source.dart
  - lib/data/datasources/local/activity_local_data_source.dart
  - lib/presentation/providers/customer_providers.dart
autonomous: true
requirements:
  - FEAT-02

must_haves:
  truths:
    - "User tapping Delete in customer detail popup menu sees confirmation dialog warning about related data"
    - "Confirming delete soft-deletes customer AND cascade soft-deletes key persons, pipelines, activities"
    - "After delete confirmation, user navigates to customer list (not just one screen back)"
    - "Delete operation is queued for offline sync"
  artifacts:
    - path: "lib/presentation/screens/customer/customer_detail_screen.dart"
      provides: "Delete wiring with confirmation dialog and navigation"
      contains: "deleteCustomer"
    - path: "lib/data/repositories/customer_repository_impl.dart"
      provides: "Cascade soft-delete in deleteCustomer transaction"
      contains: "softDeleteByCustomerId"
    - path: "lib/data/datasources/local/key_person_local_data_source.dart"
      provides: "Batch soft-delete by customer ID"
      contains: "softDeleteByCustomerId"
    - path: "lib/data/datasources/local/pipeline_local_data_source.dart"
      provides: "Batch soft-delete by customer ID"
      contains: "softDeleteByCustomerId"
    - path: "lib/data/datasources/local/activity_local_data_source.dart"
      provides: "Batch soft-delete by customer ID"
      contains: "softDeleteByCustomerId"
  key_links:
    - from: "lib/data/repositories/customer_repository_impl.dart"
      to: "local data sources"
      via: "cascade softDeleteByCustomerId calls inside transaction"
      pattern: "softDeleteByCustomerId"
    - from: "lib/presentation/providers/customer_providers.dart"
      to: "lib/data/repositories/customer_repository_impl.dart"
      via: "customerRepositoryProvider passes PipelineLocalDataSource and ActivityLocalDataSource to constructor"
      pattern: "pipelineLocalDataSource|activityLocalDataSource"
---

<objective>
Wire customer detail delete action: cascade soft-delete with confirmation dialog, offline sync queuing, and navigation to customer list.

Purpose: Complete the stubbed customer delete action that currently has incomplete behavior.
Output: Working delete button on customer detail screen with cascade delete in the data layer.
</objective>

<execution_context>
@C:/Users/cartr/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/cartr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-stubbed-feature-completion/08-RESEARCH.md

@lib/presentation/screens/customer/customer_detail_screen.dart
@lib/data/repositories/customer_repository_impl.dart
@lib/data/datasources/local/customer_local_data_source.dart
@lib/data/datasources/local/key_person_local_data_source.dart
@lib/data/datasources/local/pipeline_local_data_source.dart
@lib/data/datasources/local/activity_local_data_source.dart
@lib/domain/repositories/customer_repository.dart
@lib/presentation/providers/customer_providers.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add cascade soft-delete methods to local data sources and update repository</name>
  <files>
    lib/data/datasources/local/key_person_local_data_source.dart
    lib/data/datasources/local/pipeline_local_data_source.dart
    lib/data/datasources/local/activity_local_data_source.dart
    lib/data/repositories/customer_repository_impl.dart
    lib/presentation/providers/customer_providers.dart
  </files>
  <action>
Add `softDeleteByCustomerId(String customerId)` method to three local data sources:

1. **key_person_local_data_source.dart**: Add method that updates all key_persons where `customerId` matches and `deletedAt` is null, setting `deletedAt` and `updatedAt` to `DateTime.now()`. Use Drift's `update` with `where` clause pattern matching the existing `softDeleteCustomer` in customer_local_data_source.dart.

2. **pipeline_local_data_source.dart**: Same pattern — update all pipelines where `customerId` matches and `deletedAt` is null. Set `deletedAt` and `updatedAt`.

3. **activity_local_data_source.dart**: Same pattern — update all activities where `customerId` matches and `deletedAt` is null. Set `deletedAt` and `updatedAt`.

4. **customer_repository_impl.dart**: The constructor currently injects `CustomerLocalDataSource`, `KeyPersonLocalDataSource`, `CustomerRemoteDataSource`, `KeyPersonRemoteDataSource`, `SyncService`, `currentUserId`, and `AppDatabase`. It does NOT currently have `PipelineLocalDataSource` or `ActivityLocalDataSource`. You must:
   - Add `PipelineLocalDataSource` and `ActivityLocalDataSource` as required constructor parameters
   - Add corresponding private fields `_pipelineLocalDataSource` and `_activityLocalDataSource`
   - Add the necessary imports for both data source classes

   Then update the existing `deleteCustomer` method to call all three cascade soft-delete methods INSIDE the existing Drift transaction, BEFORE the customer's own soft-delete:
   ```dart
   await _keyPersonLocalDataSource.softDeleteByCustomerId(id);
   await _pipelineLocalDataSource.softDeleteByCustomerId(id);
   await _activityLocalDataSource.softDeleteByCustomerId(id);
   ```

5. **customer_providers.dart**: Update `customerRepositoryProvider` to pass the two new data sources. Add providers for the data sources if they don't already exist in this file (check pipeline_providers.dart and activity_providers.dart for existing `pipelineLocalDataSourceProvider` and `activityLocalDataSourceProvider` — import and reuse those). Update the `CustomerRepositoryImpl(...)` constructor call to include:
   ```dart
   pipelineLocalDataSource: ref.watch(pipelineLocalDataSourceProvider),
   activityLocalDataSource: ref.watch(activityLocalDataSourceProvider),
   ```
   Import `PipelineLocalDataSource` and `ActivityLocalDataSource` classes plus their provider sources.

Only queue the CUSTOMER delete for sync (not the cascaded entities) — the backend handles cascade deletion. This follows the research recommendation.

**Role-based permissions (Claude's discretion):** Allow any authenticated user to delete customers they can see — no additional role check needed. The soft-delete is DB-recoverable by admin. This matches the existing edit access pattern.
  </action>
  <verify>Run `flutter analyze` to check for compilation errors in the modified files. Verify that the new methods exist and the repository transaction includes all cascade calls.</verify>
  <done>Three local data sources have `softDeleteByCustomerId` methods. CustomerRepositoryImpl.deleteCustomer cascade-deletes related key persons, pipelines, and activities within the transaction before soft-deleting the customer itself. Only the customer delete is queued for sync.</done>
</task>

<task type="auto">
  <name>Task 2: Wire delete action in customer detail screen</name>
  <files>
    lib/presentation/screens/customer/customer_detail_screen.dart
  </files>
  <action>
Wire the delete menu action in customer_detail_screen.dart:

**Delete action (FEAT-02):**
1. Find the existing delete confirmation dialog (should have Indonesian text like "Hapus Nasabah").
2. Update the confirmation dialog text to include a warning about related data being deleted: "Semua data terkait (key person, pipeline, aktivitas) juga akan dihapus."
3. Wire the confirm button to call the customer delete notifier/provider method. Look at `CustomerListNotifier` or `CustomerDetailNotifier` — find the existing `deleteCustomer` call pattern. If no notifier method exists, call the repository directly via provider.
4. After successful delete, show a success snackbar: "Nasabah berhasil dihapus"
5. Navigate to customer list using `context.go('/home/customers')` — NOT `context.pop()` — per user decision.
6. Handle error case: show error snackbar on failure.

**IMPORTANT:** Use `context.go('/home/customers')` for navigation after delete, NOT `context.pop()`.
  </action>
  <verify>Run `flutter analyze` to confirm no compilation errors. Verify delete dialog has warning text and navigates via context.go('/home/customers').</verify>
  <done>Delete menu action shows confirmation dialog with related-data warning, calls cascade soft-delete, shows success snackbar, and navigates to customer list via context.go().</done>
</task>

</tasks>

<verification>
1. `flutter analyze` passes with no errors in modified files
2. Delete action shows confirmation dialog with cascade warning in Indonesian
3. Confirmed delete calls `deleteCustomer` which cascade-deletes key persons, pipelines, activities
4. After delete, navigation goes to `/home/customers` (customer list)
5. Only customer delete (not cascaded entities) is queued for sync
</verification>

<success_criteria>
- Delete button shows confirmation, cascade-deletes all related data, navigates to customer list
- Delete works in offline mode (queued for sync)
</success_criteria>

<output>
After completion, create `.planning/phases/08-stubbed-feature-completion/08-01-SUMMARY.md`
</output>
