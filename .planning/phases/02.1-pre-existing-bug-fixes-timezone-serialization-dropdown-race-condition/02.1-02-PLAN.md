---
phase: 02.1-pre-existing-bug-fixes-timezone-serialization-dropdown-race-condition
plan: 02
type: execute
wave: 2
depends_on: ["02.1-01"]
files_modified:
  - lib/data/datasources/remote/activity_remote_data_source.dart
  - lib/data/datasources/remote/admin_master_data_remote_data_source.dart
  - lib/data/datasources/remote/cadence_remote_data_source.dart
  - lib/data/datasources/remote/customer_remote_data_source.dart
  - lib/data/datasources/remote/broker_remote_data_source.dart
  - lib/data/datasources/remote/hvc_remote_data_source.dart
  - lib/data/datasources/remote/history_log_remote_data_source.dart
  - lib/data/datasources/remote/pipeline_remote_data_source.dart
  - lib/data/datasources/remote/scoreboard_remote_data_source.dart
  - lib/data/datasources/remote/pipeline_referral_remote_data_source.dart
  - lib/data/services/sync_service.dart
  - lib/data/services/app_settings_service.dart
  - lib/data/services/initial_sync_service.dart
  - lib/presentation/providers/sync_providers.dart
autonomous: true

must_haves:
  truths:
    - "All Supabase query filters for incremental sync use UTC timestamps with Z suffix"
    - "Sync timestamp storage (setTableLastSyncAt) stores UTC DateTime values"
    - "The entire timestamp chain from storage through query filters is consistently UTC"
    - "admin_user_remote_data_source.dart is left unchanged (already correct)"
  artifacts:
    - path: "lib/data/datasources/remote/customer_remote_data_source.dart"
      provides: "Customer delta sync queries with UTC timestamps"
      contains: "toUtcIso8601"
    - path: "lib/data/services/app_settings_service.dart"
      provides: "UTC-aware sync timestamp storage"
      contains: "toUtcIso8601"
    - path: "lib/presentation/providers/sync_providers.dart"
      provides: "UTC DateTime.now().toUtc() for setTableLastSyncAt calls"
      contains: "DateTime.now().toUtc()"
  key_links:
    - from: "lib/presentation/providers/sync_providers.dart"
      to: "lib/data/services/app_settings_service.dart"
      via: "setTableLastSyncAt(table, DateTime.now().toUtc())"
      pattern: "setTableLastSyncAt.*DateTime\\.now\\(\\)\\.toUtc\\(\\)"
    - from: "lib/data/services/app_settings_service.dart"
      to: "lib/data/datasources/remote/*.dart"
      via: "getTableLastSyncAt returns UTC DateTime, remote DS serializes with toUtcIso8601()"
      pattern: "toUtcIso8601"
---

<objective>
Fix all .toIso8601String() calls in remote data sources, services, and sync providers to complete the UTC timestamp chain.

Purpose: Plan 01 fixed the repository sync payloads (data going OUT to Supabase). This plan fixes the query filters (data coming IN from Supabase) and the sync timestamp storage chain. Without this, incremental sync queries send local timestamps as filters against UTC server data, potentially causing missed records or re-fetches.

Output: 10 remote data source files, 3 service files, and 1 provider file with corrected UTC timestamp serialization. The entire timestamp chain from storage to query is consistently UTC.
</objective>

<execution_context>
@C:/Users/cartr/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/cartr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02.1-pre-existing-bug-fixes-timezone-serialization-dropdown-race-condition/02.1-RESEARCH.md
@.planning/phases/02.1-pre-existing-bug-fixes-timezone-serialization-dropdown-race-condition/02.1-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix remote data source timestamp serialization (54 occurrences across 10 files)</name>
  <files>
    lib/data/datasources/remote/activity_remote_data_source.dart
    lib/data/datasources/remote/admin_master_data_remote_data_source.dart
    lib/data/datasources/remote/cadence_remote_data_source.dart
    lib/data/datasources/remote/customer_remote_data_source.dart
    lib/data/datasources/remote/broker_remote_data_source.dart
    lib/data/datasources/remote/hvc_remote_data_source.dart
    lib/data/datasources/remote/history_log_remote_data_source.dart
    lib/data/datasources/remote/pipeline_remote_data_source.dart
    lib/data/datasources/remote/scoreboard_remote_data_source.dart
    lib/data/datasources/remote/pipeline_referral_remote_data_source.dart
  </files>
  <action>
    1. In each of the 10 remote data source files listed above:
       - Add `import '../../../../core/utils/date_time_utils.dart';` (adjust relative path based on file depth -- remote DS files are at lib/data/datasources/remote/, so path is `../../../core/utils/date_time_utils.dart`)
       - Replace every `.toIso8601String()` with `.toUtcIso8601()`
       - These include both delta sync query filters (e.g., `since.toIso8601String()`) and inline timestamp values (e.g., `DateTime.now().toIso8601String()` for deleted_at)

    2. DO NOT modify `admin_user_remote_data_source.dart` -- it already uses `.toUtc().toIso8601String()` correctly (5 occurrences). Leave it as-is; it does not need the extension import.

    3. Occurrence counts per file (verify all are addressed):
       - cadence_remote_data_source.dart: 12 occurrences
       - admin_master_data_remote_data_source.dart: 8 occurrences
       - activity_remote_data_source.dart: 6 occurrences
       - hvc_remote_data_source.dart: 6 occurrences
       - customer_remote_data_source.dart: 5 occurrences
       - pipeline_remote_data_source.dart: 4 occurrences
       - pipeline_referral_remote_data_source.dart: 4 occurrences
       - history_log_remote_data_source.dart: 4 occurrences
       - broker_remote_data_source.dart: 3 occurrences
       - scoreboard_remote_data_source.dart: 2 occurrences
  </action>
  <verify>
    Run: `grep -r "\.toIso8601String()" lib/data/datasources/remote/ --include="*.dart" | grep -v "admin_user_remote"`
    Expected: ZERO results across all remote DS files except admin_user.
    Run: `grep -r "\.toIso8601String()" lib/data/datasources/remote/admin_user_remote_data_source.dart`
    Expected: 5 results (all already have .toUtc() prefix -- unchanged).
    Run: `flutter analyze` -- no new errors.
  </verify>
  <done>All 54 .toIso8601String() calls in 10 remote data source files are replaced with .toUtcIso8601(). admin_user_remote_data_source.dart is unchanged.</done>
</task>

<task type="auto">
  <name>Task 2: Fix services and sync_providers timestamp chain (18 occurrences)</name>
  <files>
    lib/data/services/sync_service.dart
    lib/data/services/app_settings_service.dart
    lib/data/services/initial_sync_service.dart
    lib/presentation/providers/sync_providers.dart
  </files>
  <action>
    1. Fix `lib/data/services/app_settings_service.dart` (2 occurrences):
       - Add `import '../../core/utils/date_time_utils.dart';`
       - In `markInitialSyncCompleted()` (~line 62): Replace `DateTime.now().toIso8601String()` with `DateTime.now().toUtcIso8601()`
       - In `setTableLastSyncAt()` (~line 121): Replace `timestamp.toIso8601String()` with `timestamp.toUtcIso8601()`

    2. Fix `lib/data/services/sync_service.dart` (1 occurrence):
       - Add `import '../../core/utils/date_time_utils.dart';`
       - Replace the 1 `.toIso8601String()` call (soft delete `deleted_at` in processQueue) with `.toUtcIso8601()`

    3. Fix `lib/data/services/initial_sync_service.dart` (4 occurrences):
       - Add `import '../../core/utils/date_time_utils.dart';`
       - Replace all 4 `.toIso8601String()` calls (delta sync `since` query filters) with `.toUtcIso8601()`

    4. Fix `lib/presentation/providers/sync_providers.dart` (9 occurrences):
       - These are NOT .toIso8601String() calls -- they are `DateTime.now()` passed directly to `setTableLastSyncAt()`. The service now handles serialization with `.toUtcIso8601()`, but the DateTime value itself should be UTC for consistency.
       - Replace all 9 instances of `setTableLastSyncAt('tablename', DateTime.now())` with `setTableLastSyncAt('tablename', DateTime.now().toUtc())`
       - The 9 tables are: customers, key_persons, pipelines, activities, hvcs, customer_hvc_links, brokers, cadence_meetings, pipeline_referrals
       - No import needed for this file (DateTime.toUtc() is built-in)
  </action>
  <verify>
    Run: `grep "\.toIso8601String()" lib/data/services/sync_service.dart lib/data/services/app_settings_service.dart lib/data/services/initial_sync_service.dart`
    Expected: ZERO results.
    Run: `grep "setTableLastSyncAt.*DateTime\.now())" lib/presentation/providers/sync_providers.dart`
    Expected: ZERO results (all should now have .toUtc()).
    Run: `grep "DateTime\.now()\.toUtc()" lib/presentation/providers/sync_providers.dart | wc -l`
    Expected: 9 results.
    Run: `flutter analyze` -- no new errors.
  </verify>
  <done>All service files use .toUtcIso8601() for timestamp serialization. All 9 setTableLastSyncAt calls in sync_providers.dart pass DateTime.now().toUtc(). The entire sync timestamp chain from storage through query filters is consistently UTC.</done>
</task>

</tasks>

<verification>
1. `grep -rn "\.toIso8601String()" lib/data/datasources/remote/ lib/data/services/ lib/presentation/providers/ --include="*.dart" | grep -v ".g.dart" | grep -v "admin_user_remote"` returns ONLY the 5 admin_user lines (which are already correct with .toUtc() prefix) or zero if admin_user is excluded
2. `grep -c "toUtcIso8601" lib/data/datasources/remote/*.dart lib/data/services/*.dart` shows occurrences in all fixed files
3. `grep -c "DateTime.now().toUtc()" lib/presentation/providers/sync_providers.dart` shows 9
4. `flutter analyze` passes with no new errors
5. Full chain verified: sync_providers stores UTC -> app_settings serializes UTC -> remote DS queries with UTC
</verification>

<success_criteria>
- Zero bare .toIso8601String() calls remain in any remote data source file (except admin_user which is already correct)
- Zero bare .toIso8601String() calls remain in any service file
- All 9 setTableLastSyncAt calls pass DateTime.now().toUtc()
- flutter analyze passes
- The entire timestamp chain from storage through query filters is consistently UTC
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-pre-existing-bug-fixes-timezone-serialization-dropdown-race-condition/02.1-02-SUMMARY.md`
</output>
