---
phase: 02.1-pre-existing-bug-fixes-timezone-serialization-dropdown-race-condition
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/presentation/screens/customer/customer_form_screen.dart
  - lib/presentation/screens/pipeline/pipeline_form_screen.dart
  - lib/presentation/widgets/common/autocomplete_field.dart
autonomous: true

must_haves:
  truths:
    - "Selecting a dropdown value in customer form consistently populates the form field"
    - "Selecting a dropdown value in pipeline form consistently populates the form field"
    - "AutocompleteField widget is no longer used anywhere in the codebase"
  artifacts:
    - path: "lib/presentation/screens/customer/customer_form_screen.dart"
      provides: "Customer form with SearchableDropdown for all 5 selection fields"
      contains: "SearchableDropdown"
    - path: "lib/presentation/screens/pipeline/pipeline_form_screen.dart"
      provides: "Pipeline form with SearchableDropdown for all 6 selection fields"
      contains: "SearchableDropdown"
  key_links:
    - from: "lib/presentation/screens/customer/customer_form_screen.dart"
      to: "lib/presentation/widgets/common/searchable_dropdown.dart"
      via: "import and SearchableDropdown<String> widget usage"
      pattern: "SearchableDropdown<"
    - from: "lib/presentation/screens/pipeline/pipeline_form_screen.dart"
      to: "lib/presentation/widgets/common/searchable_dropdown.dart"
      via: "import and SearchableDropdown<String> widget usage"
      pattern: "SearchableDropdown<"
---

<objective>
Replace all 11 AutocompleteField usages with SearchableDropdown in customer and pipeline forms, then delete the AutocompleteField widget.

Purpose: AutocompleteField uses an overlay-based dropdown with a 200ms delay between focus loss and overlay removal. When users tap a suggestion, the TextField loses focus on tap-down (scheduling overlay removal), but InkWell.onTap must fire on tap-up within that 200ms window. Slow taps or gesture recognition delays cause selection loss. SearchableDropdown uses a modal bottom sheet (Navigator stack), which is architecturally immune to this race condition.

Output: Both form screens use SearchableDropdown for all selection fields. autocomplete_field.dart is deleted.
</objective>

<execution_context>
@C:/Users/cartr/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/cartr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02.1-pre-existing-bug-fixes-timezone-serialization-dropdown-race-condition/02.1-RESEARCH.md
@lib/presentation/widgets/common/searchable_dropdown.dart
@lib/presentation/widgets/common/autocomplete_field.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace AutocompleteField with SearchableDropdown in customer and pipeline forms</name>
  <files>
    lib/presentation/screens/customer/customer_form_screen.dart
    lib/presentation/screens/pipeline/pipeline_form_screen.dart
  </files>
  <action>
    1. In `customer_form_screen.dart` (5 dropdown fields):
       - Replace import: `autocomplete_field.dart` -> `searchable_dropdown.dart`
       - Replace all 5 `AutocompleteField<String>(` with `SearchableDropdown<String>(`
       - Replace all `AutocompleteItem(` with `DropdownItem(`
       - Add `modalTitle` parameter to each (required by SearchableDropdown):
         * Province: `modalTitle: 'Pilih Provinsi'`
         * City: `modalTitle: 'Pilih Kota/Kabupaten'`
         * CompanyType: `modalTitle: 'Pilih Jenis Perusahaan'`
         * OwnershipType: `modalTitle: 'Pilih Bentuk Kepemilikan'`
         * Industry: `modalTitle: 'Pilih Industri'`
       - Preserve all existing parameters: label, hint, value, items, onChanged, validator, enabled

    2. In `pipeline_form_screen.dart` (6 dropdown fields):
       - Replace import: `autocomplete_field.dart` -> `searchable_dropdown.dart`
       - Replace all 6 `AutocompleteField<String>(` with `SearchableDropdown<String>(`
       - Replace all `AutocompleteItem(` with `DropdownItem(`
       - Add `modalTitle` parameter to each:
         * COB (Class of Business): `modalTitle: 'Pilih COB'`
         * LOB (Line of Business): `modalTitle: 'Pilih LOB'`
         * Lead Source: `modalTitle: 'Pilih Sumber Lead'`
         * Broker: `modalTitle: 'Pilih Broker'`
         * Broker PIC: `modalTitle: 'Pilih PIC Broker'`
         * Customer Contact (Key Person): `modalTitle: 'Pilih Kontak'`
       - Preserve all existing parameters: label, hint, value, items, onChanged, validator, enabled

    3. If SearchableDropdown does not have a `modalTitle` parameter, check the widget source. If it uses a different parameter name (e.g., `title`, `searchTitle`), use that instead. The important thing is that the modal bottom sheet has a descriptive title.

    4. Verify the SearchableDropdown API matches what AutocompleteField provided:
       - `label` -> `label` (same)
       - `hint` -> `hint` (same)
       - `value` -> `value` (same)
       - `items` -> `items` (type changes from List<AutocompleteItem<T>> to List<DropdownItem<T>>)
       - `onChanged` -> `onChanged` (same signature: void Function(T?))
       - `validator` -> `validator` (same signature)
       - `enabled` -> check if SearchableDropdown supports this; if not, wrap with IgnorePointer+Opacity or use the `enabled` parameter if available
  </action>
  <verify>
    Run: `grep -r "AutocompleteField\|AutocompleteItem" lib/presentation/screens/ --include="*.dart"`
    Expected: ZERO results. No AutocompleteField or AutocompleteItem references remain in screens.
    Run: `grep -c "SearchableDropdown" lib/presentation/screens/customer/customer_form_screen.dart`
    Expected: 5 (one per dropdown field).
    Run: `grep -c "SearchableDropdown" lib/presentation/screens/pipeline/pipeline_form_screen.dart`
    Expected: 6 (one per dropdown field).
    Run: `flutter analyze` -- no new errors.
  </verify>
  <done>All 11 AutocompleteField usages replaced with SearchableDropdown. Both forms use DropdownItem instead of AutocompleteItem. Modal titles provided for all dropdowns.</done>
</task>

<task type="auto">
  <name>Task 2: Delete autocomplete_field.dart (dead code removal)</name>
  <files>
    lib/presentation/widgets/common/autocomplete_field.dart
  </files>
  <action>
    1. First verify NO remaining imports of autocomplete_field.dart:
       Run: `grep -r "autocomplete_field" lib/ --include="*.dart"`
       Expected: Only the file itself. If any other file still imports it, fix that file first.

    2. Delete `lib/presentation/widgets/common/autocomplete_field.dart`

    3. Verify deletion doesn't break analysis:
       Run: `flutter analyze`
  </action>
  <verify>
    Run: `grep -r "autocomplete_field\|AutocompleteField\|AutocompleteItem" lib/ --include="*.dart"`
    Expected: ZERO results. The widget and all references are completely removed.
    Run: `flutter analyze` -- no errors.
  </verify>
  <done>autocomplete_field.dart is deleted. Zero references to AutocompleteField or AutocompleteItem exist in the codebase.</done>
</task>

</tasks>

<verification>
1. `grep -r "AutocompleteField\|AutocompleteItem\|autocomplete_field" lib/ --include="*.dart"` returns zero results
2. `grep -c "SearchableDropdown" lib/presentation/screens/customer/customer_form_screen.dart` returns 5
3. `grep -c "SearchableDropdown" lib/presentation/screens/pipeline/pipeline_form_screen.dart` returns 6
4. `flutter analyze` passes with no errors
5. File `lib/presentation/widgets/common/autocomplete_field.dart` does not exist
</verification>

<success_criteria>
- All 11 dropdown fields in customer and pipeline forms use SearchableDropdown
- AutocompleteField widget file is deleted from the codebase
- Zero references to AutocompleteField or AutocompleteItem remain
- flutter analyze passes
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-pre-existing-bug-fixes-timezone-serialization-dropdown-race-condition/02.1-03-SUMMARY.md`
</output>
