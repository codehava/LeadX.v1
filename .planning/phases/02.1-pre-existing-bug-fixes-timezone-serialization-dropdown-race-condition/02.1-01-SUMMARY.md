---
phase: 02.1-pre-existing-bug-fixes-timezone-serialization-dropdown-race-condition
plan: 01
subsystem: database
tags: [timezone, utc, iso8601, supabase, sync, serialization]

# Dependency graph
requires:
  - phase: 02-sync-engine-core
    provides: "Sync queue and repository sync payload patterns"
provides:
  - "toUtcIso8601() extension methods for DateTime and DateTime?"
  - "All 88 timestamp serializations in 10 files produce correct UTC strings"
  - "Date-only fields use yyyy-MM-dd format instead of UTC timestamps"
affects: [sync-engine, data-integrity, all-repositories]

# Tech tracking
tech-stack:
  added: []
  patterns: ["toUtcIso8601() extension for all sync payload timestamps", "substring(0,10) for DATE-only PostgreSQL columns"]

key-files:
  created:
    - "lib/core/utils/date_time_utils.dart"
  modified:
    - "lib/data/repositories/activity_repository_impl.dart"
    - "lib/data/repositories/cadence_repository_impl.dart"
    - "lib/data/repositories/pipeline_referral_repository_impl.dart"
    - "lib/data/repositories/customer_repository_impl.dart"
    - "lib/data/repositories/pipeline_repository_impl.dart"
    - "lib/data/repositories/hvc_repository_impl.dart"
    - "lib/data/repositories/broker_repository_impl.dart"
    - "lib/data/repositories/admin_4dx_repository_impl.dart"
    - "lib/data/repositories/auth_repository_impl.dart"
    - "lib/presentation/providers/activity_providers.dart"

key-decisions:
  - "toUtcIso8601() as extension method (not standalone function) for natural .toUtcIso8601() call syntax"
  - "Separate nullable extension for DateTime? to avoid null-check boilerplate at call sites"
  - "Date-only fields (expected_close_date, start_date, end_date) use .toIso8601String().substring(0,10) to avoid UTC date-shift"

patterns-established:
  - "UTC serialization: All sync payload timestamps MUST use .toUtcIso8601() not .toIso8601String()"
  - "Date-only columns: PostgreSQL DATE fields use .toIso8601String().substring(0,10) to extract yyyy-MM-dd"

# Metrics
duration: 5min
completed: 2026-02-13
---

# Phase 02.1 Plan 01: Timezone Serialization Fix Summary

**Centralized toUtcIso8601() extension with 88 timestamp fixes across 9 repositories and 1 provider preventing WIB-to-UTC misinterpretation**

## Performance

- **Duration:** 5 min
- **Started:** 2026-02-13T14:48:21Z
- **Completed:** 2026-02-13T14:53:06Z
- **Tasks:** 2
- **Files modified:** 11

## Accomplishments
- Created date_time_utils.dart with DateTime and DateTime? toUtcIso8601() extensions
- Replaced 82 bare .toIso8601String() calls with .toUtcIso8601() across 9 repository files + 1 provider
- Applied .substring(0,10) date-only format to 6 occurrences (expected_close_date, start_date, end_date)
- Zero new errors from flutter analyze

## Task Commits

Each task was committed atomically:

1. **Task 1: Create date_time_utils.dart and fix 86 repository sync payloads** - `f48b8ef` (fix) -- pre-committed by prior execution
2. **Task 2: Fix activity_providers.dart photo sync payload (2 occurrences)** - `6ffb781` (fix)

**Plan metadata:** pending (docs: complete plan)

## Files Created/Modified
- `lib/core/utils/date_time_utils.dart` - toUtcIso8601() extensions for DateTime and DateTime?
- `lib/data/repositories/activity_repository_impl.dart` - 22 timestamp fixes in sync payloads
- `lib/data/repositories/cadence_repository_impl.dart` - 16 timestamp fixes in meeting/participant payloads
- `lib/data/repositories/pipeline_referral_repository_impl.dart` - 12 timestamp fixes in referral payloads
- `lib/data/repositories/customer_repository_impl.dart` - 10 timestamp fixes in customer/key-person payloads
- `lib/data/repositories/pipeline_repository_impl.dart` - 7 timestamp + 2 date-only fixes
- `lib/data/repositories/hvc_repository_impl.dart` - 6 timestamp fixes in HVC/link payloads
- `lib/data/repositories/broker_repository_impl.dart` - 4 timestamp fixes in broker payloads
- `lib/data/repositories/admin_4dx_repository_impl.dart` - 4 date-only fixes (start_date, end_date)
- `lib/data/repositories/auth_repository_impl.dart` - 3 timestamp fixes (last_login_at, updated_at)
- `lib/presentation/providers/activity_providers.dart` - 2 timestamp fixes in photo sync payload

## Decisions Made
- Used extension methods on DateTime/DateTime? for ergonomic `.toUtcIso8601()` call syntax matching existing `.toIso8601String()` pattern
- Kept date-only fields as `.toIso8601String().substring(0,10)` rather than `.toUtcIso8601()` to prevent UTC conversion shifting dates backward for UTC+ timezones
- Library directive with doc comment in date_time_utils.dart explains the WHY to prevent future regression

## Deviations from Plan

None - plan executed exactly as written. Task 1 was already committed by a prior execution session as part of commit f48b8ef (bundled with plan 03 changes); Task 2 was the only new commit needed.

## Issues Encountered
- Task 1 changes were already committed in a prior session (commit f48b8ef), bundled with unrelated plan 03 dropdown fixes. Git showed no diff for the 9 repository files. Task 2 (activity_providers.dart) was not part of that prior commit and was committed fresh.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness
- All sync payload timestamps now correctly serialize to UTC with Z suffix
- Date-only fields correctly serialize as yyyy-MM-dd strings
- Ready for Plan 02 (dropdown race condition fix) and Plan 03 (additional fixes)

## Self-Check: PASSED

- All 11 key files verified present on disk
- Commit f48b8ef (Task 1) verified in git log
- Commit 6ffb781 (Task 2) verified in git log
- Zero bare .toIso8601String() in repositories (only substring date-only variants remain)
- 82 toUtcIso8601() calls confirmed across repositories + providers
- flutter analyze: no new errors

---
*Phase: 02.1-pre-existing-bug-fixes-timezone-serialization-dropdown-race-condition*
*Completed: 2026-02-13*
