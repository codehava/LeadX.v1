---
phase: 02.1-pre-existing-bug-fixes-timezone-serialization-dropdown-race-condition
plan: 02
subsystem: database
tags: [timezone, utc, iso8601, supabase, sync, serialization, remote-data-source, delta-sync]

# Dependency graph
requires:
  - phase: 02.1-pre-existing-bug-fixes-timezone-serialization-dropdown-race-condition
    plan: 01
    provides: "toUtcIso8601() extension methods and repository sync payload fixes"
provides:
  - "All remote data source query filters use UTC timestamps with Z suffix"
  - "Sync timestamp storage chain fully UTC-consistent"
  - "9 per-table sync timestamps stored as UTC DateTime values"
affects: [sync-engine, data-integrity, incremental-sync, all-remote-data-sources]

# Tech tracking
tech-stack:
  added: []
  patterns: ["Remote DS query filters use toUtcIso8601() for Supabase timestamp comparisons", "setTableLastSyncAt receives DateTime.now().toUtc() from callers"]

key-files:
  created: []
  modified:
    - "lib/data/datasources/remote/activity_remote_data_source.dart"
    - "lib/data/datasources/remote/admin_master_data_remote_data_source.dart"
    - "lib/data/datasources/remote/cadence_remote_data_source.dart"
    - "lib/data/datasources/remote/customer_remote_data_source.dart"
    - "lib/data/datasources/remote/broker_remote_data_source.dart"
    - "lib/data/datasources/remote/hvc_remote_data_source.dart"
    - "lib/data/datasources/remote/history_log_remote_data_source.dart"
    - "lib/data/datasources/remote/pipeline_remote_data_source.dart"
    - "lib/data/datasources/remote/scoreboard_remote_data_source.dart"
    - "lib/data/datasources/remote/pipeline_referral_remote_data_source.dart"
    - "lib/data/services/sync_service.dart"
    - "lib/data/services/app_settings_service.dart"
    - "lib/data/services/initial_sync_service.dart"
    - "lib/presentation/providers/sync_providers.dart"

key-decisions:
  - "admin_user_remote_data_source.dart left unchanged -- already uses .toUtc().toIso8601String() correctly"
  - "initial_sync_service.dart .or() filter strings use toUtcIso8601() for both updated_at and deleted_at comparisons"
  - "sync_providers.dart passes DateTime.now().toUtc() to setTableLastSyncAt so the storage layer receives UTC regardless of serialization"

patterns-established:
  - "Remote DS query filters: All Supabase .gte()/.gt()/.or() timestamp filters MUST use .toUtcIso8601()"
  - "Sync timestamp storage: setTableLastSyncAt callers MUST pass DateTime.now().toUtc()"

# Metrics
duration: 5min
completed: 2026-02-13
---

# Phase 02.1 Plan 02: UTC Timestamp Chain Fix Summary

**Fixed 61 bare .toIso8601String() calls across 14 files completing the UTC timestamp chain from sync storage through query filters to Supabase**

## Performance

- **Duration:** 5 min
- **Started:** 2026-02-13T14:55:52Z
- **Completed:** 2026-02-13T15:01:01Z
- **Tasks:** 2
- **Files modified:** 14

## Accomplishments
- Replaced 54 bare .toIso8601String() with .toUtcIso8601() across 10 remote data source files
- Fixed 10 bare .toIso8601String() in 3 service files (app_settings, sync_service, initial_sync)
- Updated 9 setTableLastSyncAt calls in sync_providers.dart to pass DateTime.now().toUtc()
- Completed the full UTC chain: providers store UTC -> services serialize UTC -> remote DS query with UTC
- Zero new errors from flutter analyze (258 pre-existing info/warnings unchanged)

## Task Commits

Each task was committed atomically:

1. **Task 1: Fix remote data source timestamp serialization (54 occurrences across 10 files)** - `9042278` (fix)
2. **Task 2: Fix services and sync_providers timestamp chain** - `11f07fa` (fix)

**Plan metadata:** pending (docs: complete plan)

## Files Created/Modified
- `lib/data/datasources/remote/activity_remote_data_source.dart` - 6 query filter + soft delete timestamps fixed
- `lib/data/datasources/remote/admin_master_data_remote_data_source.dart` - 8 CRUD timestamps fixed
- `lib/data/datasources/remote/cadence_remote_data_source.dart` - 12 meeting/participant timestamps fixed
- `lib/data/datasources/remote/customer_remote_data_source.dart` - 5 query filter + soft delete timestamps fixed
- `lib/data/datasources/remote/broker_remote_data_source.dart` - 3 delta sync + soft delete timestamps fixed
- `lib/data/datasources/remote/hvc_remote_data_source.dart` - 6 delta sync + soft delete timestamps fixed
- `lib/data/datasources/remote/history_log_remote_data_source.dart` - 4 audit log query filter timestamps fixed
- `lib/data/datasources/remote/pipeline_remote_data_source.dart` - 4 query filter + soft delete timestamps fixed
- `lib/data/datasources/remote/scoreboard_remote_data_source.dart` - 2 target assignment timestamps fixed
- `lib/data/datasources/remote/pipeline_referral_remote_data_source.dart` - 4 query filter timestamps fixed
- `lib/data/services/app_settings_service.dart` - 2 sync timestamp serialization calls fixed
- `lib/data/services/sync_service.dart` - 1 soft delete timestamp in processQueue fixed
- `lib/data/services/initial_sync_service.dart` - 7 delta sync query filter timestamps fixed
- `lib/presentation/providers/sync_providers.dart` - 9 setTableLastSyncAt calls now pass UTC DateTime

## Decisions Made
- Left admin_user_remote_data_source.dart unchanged -- its 5 occurrences already use `.toUtc().toIso8601String()` which is functionally equivalent to `.toUtcIso8601()`
- Applied toUtcIso8601() to initial_sync_service .or() filter strings (updated_at AND deleted_at comparisons) ensuring delta sync queries are consistent
- Updated sync_providers to pass `DateTime.now().toUtc()` rather than relying solely on app_settings_service serialization, making the UTC intent explicit at the call site

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness
- The entire sync timestamp chain is now consistently UTC from storage through query filters
- Combined with Plan 01 (repository sync payloads) and this plan (remote DS queries + services), all timestamp serialization in the sync system produces correct UTC strings with Z suffix
- Plan 03 (dropdown race condition) is already complete, so Phase 02.1 is fully done
- Ready for Phase 3 (next roadmap phase)

## Self-Check: PASSED

- All 14 key files verified present on disk
- Commit 9042278 (Task 1) verified in git log
- Commit 11f07fa (Task 2) verified in git log
- Zero bare .toIso8601String() in remote DS files (except admin_user which is correct)
- Zero bare .toIso8601String() in service files
- 54 toUtcIso8601() calls confirmed across remote data sources
- 7 toUtcIso8601() calls confirmed across service files
- 9 DateTime.now().toUtc() calls confirmed in sync_providers.dart
- flutter analyze: no new errors (258 pre-existing info/warnings)

---
*Phase: 02.1-pre-existing-bug-fixes-timezone-serialization-dropdown-race-condition*
*Completed: 2026-02-13*
