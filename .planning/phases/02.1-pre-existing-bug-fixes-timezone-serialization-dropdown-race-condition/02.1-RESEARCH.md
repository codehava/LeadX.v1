# Phase 02.1: Pre-existing Bug Fixes -- Timezone Serialization + Dropdown Race Condition - Research

**Researched:** 2026-02-13
**Domain:** Dart DateTime serialization, Flutter overlay/focus management, Supabase TIMESTAMPTZ
**Confidence:** HIGH

## Summary

This phase addresses two pre-existing bugs discovered during Phase 2 UAT that are independent of Phase 2 changes. Both bugs have been fully diagnosed with root causes confirmed.

**Bug 1 -- Timezone Serialization:** `DateTime.now().toIso8601String()` on local (non-UTC) DateTime produces strings WITHOUT timezone indicator (e.g., `"2026-02-13T21:00:00.000"` -- no `Z`, no `+07:00`). Supabase PostgreSQL (configured to UTC) interprets these bare timestamps as UTC. For users in UTC+7 (WIB), this causes a +7h forward shift on all timestamps. The fix is mechanical: change all `.toIso8601String()` calls in sync payloads to `.toUtc().toIso8601String()`. There are 86 occurrences across 9 repository files, plus additional occurrences in remote data sources, services, and providers. A centralized utility function should prevent future recurrence.

**Bug 2 -- Dropdown Race Condition:** The custom `AutocompleteField` widget uses an overlay-based dropdown with a 200ms delay between focus loss and overlay removal. When users tap a suggestion, the TextField loses focus on tap-down (scheduling overlay removal), but `InkWell.onTap` must fire on tap-up within that 200ms window. If the tap is slow or gesture recognition is delayed, the overlay is removed before selection registers. The fix is to replace the fragile overlay approach with the existing `SearchableDropdown` widget (modal bottom sheet), which is already used in activity forms and is inherently race-condition-free.

**Primary recommendation:** Fix timezone with a centralized `toUtcIso8601()` helper applied mechanically across all sync payloads; fix dropdown by replacing `AutocompleteField` with `SearchableDropdown` in customer and pipeline forms.

## Standard Stack

### Core (Already in Project)
| Library | Version | Purpose | Relevance to Phase |
|---------|---------|---------|---------------------|
| dart:core DateTime | SDK 3.10.4 | Date/time handling | `.toUtc().toIso8601String()` is the fix |
| json_serializable | 6.8.0 | DTO code generation | Generated `.g.dart` files contain `.toIso8601String()` but are NOT used in sync payloads |
| freezed | 2.5.7 | Immutable models | DTOs define DateTime fields; generated serialization NOT used for sync |
| supabase_flutter | 2.8.3 | Backend communication | TIMESTAMPTZ columns expect UTC-aware timestamps |
| flutter (Material) | SDK 3.10+ | UI framework | `showModalBottomSheet` for SearchableDropdown |

### Supporting
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| json_annotation | 4.9.0 | `@JsonKey`, `@JsonConverter` | Could add `UtcDateTimeConverter` for generated code, but NOT needed since repos build payloads manually |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| Manual `.toUtc().toIso8601String()` | Custom `JsonConverter` on DTOs | DTOs are NOT used for sync payloads -- repos build Map literals manually. JsonConverter would only fix DTO serialization, not the actual sync path. |
| Replacing AutocompleteField | Fix with `TextFieldTapRegion` | TapRegion could prevent focus loss on overlay taps, but has known limitations with overlay widgets (Flutter issue #128317). Replacing with SearchableDropdown is more reliable and already proven in the codebase. |
| Replacing AutocompleteField | Flutter built-in `Autocomplete` widget | Built-in widget has its own focus management issues (Flutter issues #99749, #140662). SearchableDropdown (modal bottom sheet) is architecturally immune to overlay timing issues. |

## Architecture Patterns

### Pattern 1: Centralized UTC Timestamp Serialization Helper
**What:** A single utility function/extension that converts any DateTime to UTC ISO 8601 string.
**When to use:** Every time a DateTime is serialized for a sync payload sent to Supabase.
**Why:** Prevents the bug from recurring. Makes the correct pattern the easy pattern.

```dart
// File: lib/core/utils/date_time_utils.dart

/// Converts a DateTime to UTC ISO 8601 string with Z suffix.
/// Always use this for sync payloads to Supabase.
///
/// Example: DateTime.now() in WIB (UTC+7) at 21:00 local
///   -> "2026-02-13T14:00:00.000Z" (correct UTC representation)
///
/// Without this helper, .toIso8601String() produces:
///   -> "2026-02-13T21:00:00.000" (no Z, Supabase interprets as UTC = WRONG)
String toUtcIso8601(DateTime dt) => dt.toUtc().toIso8601String();

/// Extension for nullable DateTime convenience.
extension DateTimeUtcExtension on DateTime {
  String toUtcIso8601() => toUtc().toIso8601String();
}

extension NullableDateTimeUtcExtension on DateTime? {
  String? toUtcIso8601() => this?.toUtc().toIso8601String();
}
```

### Pattern 2: Modal Bottom Sheet Dropdown (SearchableDropdown)
**What:** Replace overlay-based AutocompleteField with modal bottom sheet SearchableDropdown.
**When to use:** All dropdown selection fields in customer and pipeline forms.
**Why:** Modal bottom sheet uses Flutter's navigator stack, not overlays. Selection is returned via `Navigator.pop()`, which is atomic and race-condition-free.

```dart
// BEFORE (fragile overlay, race condition):
AutocompleteField<String>(
  label: 'Provinsi *',
  hint: 'Ketik untuk mencari provinsi...',
  value: _selectedProvinceId,
  items: provinces.map((p) => AutocompleteItem(value: p.id, label: p.name)).toList(),
  onChanged: (value) => setState(() { _selectedProvinceId = value; }),
)

// AFTER (robust modal bottom sheet):
SearchableDropdown<String>(
  label: 'Provinsi *',
  hint: 'Ketik untuk mencari provinsi...',
  modalTitle: 'Pilih Provinsi',
  value: _selectedProvinceId,
  items: provinces.map((p) => DropdownItem(value: p.id, label: p.name)).toList(),
  onChanged: (value) => setState(() { _selectedProvinceId = value; }),
)
```

### Pattern 3: Mechanical Search-and-Replace with Grep Verification
**What:** Use grep to find all occurrences, fix each, then verify zero remaining.
**When to use:** Bug 1 (timezone) -- 86+ occurrences across 9+ files.
**Why:** The fix is purely mechanical (`.toIso8601String()` -> `.toUtc().toIso8601String()`). Grep-driven approach ensures no occurrences are missed.

### Anti-Patterns to Avoid
- **Fixing only the reported symptom (activities):** The timezone bug affects ALL 9 repository files, not just activities. Fix them all.
- **Adding `.toUtc()` only to `DateTime.now()` calls:** Some payloads serialize `data.createdAt` (from Drift), which are also local DateTime objects. ALL DateTime-to-string conversions in sync payloads need the fix.
- **Patching AutocompleteField's timing:** Increasing the delay from 200ms to 400ms is a band-aid. The overlay approach is fundamentally fragile. Replace it entirely.
- **Using `JsonConverter` to fix generated `.g.dart` files:** The SyncDto `.toJson()` methods are NEVER called in the sync path. Repositories build payloads manually. Fixing `.g.dart` would be wasted effort for the sync bug (though it could be done for correctness in case DTOs are used elsewhere in the future).

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| DateTime UTC serialization | Inline `.toUtc().toIso8601String()` everywhere | Centralized `toUtcIso8601()` helper | Prevents future devs from forgetting `.toUtc()` |
| Searchable dropdown with overlay | Custom overlay management (AutocompleteField) | `SearchableDropdown` (already exists) | Modal bottom sheet is architecturally immune to focus/tap race conditions |
| Timezone offset string formatting | Manual `+07:00` suffix appending | `.toUtc().toIso8601String()` producing `Z` suffix | UTC with `Z` is the standard; Supabase handles it correctly |

**Key insight:** The correct pattern (`.toUtc().toIso8601String()`) already exists in `admin_user_remote_data_source.dart` (5 occurrences). The correct dropdown pattern (`SearchableDropdown`) already exists in `activity_form_screen.dart`. Both fixes are about adopting existing correct patterns, not inventing new ones.

## Common Pitfalls

### Pitfall 1: Missing Occurrences in Mechanical Replace
**What goes wrong:** Some `.toIso8601String()` calls are missed, leaving inconsistent timestamp behavior.
**Why it happens:** Large number of occurrences (86+ in repos, 59 in remote data sources, 7 in services) spread across many files. Some are in `DateTime.now().toIso8601String()` patterns, others in `data.field.toIso8601String()` patterns, and others in `field?.toIso8601String()` nullable patterns.
**How to avoid:** After fixing, grep for remaining `.toIso8601String()` in the sync-relevant directories and verify count drops to zero (or only remains in files that don't send data to Supabase).
**Warning signs:** Grep still finds bare `.toIso8601String()` in repository or remote data source files after the fix.

### Pitfall 2: Fixing .g.dart Files Directly
**What goes wrong:** Manually editing generated `.g.dart` files that get overwritten by `build_runner`.
**Why it happens:** The generated files contain `.toIso8601String()` calls (60 in DTOs, 80 in entities).
**How to avoid:** Generated files are NOT in the sync path (repos build Map literals, not DTO `.toJson()`). Leave them alone for this phase. If future work routes sync through DTOs, add a `JsonConverter` at that time.
**Warning signs:** Editing files with `// GENERATED CODE - DO NOT MODIFY BY HAND` header.

### Pitfall 3: Breaking Incremental Sync Timestamps
**What goes wrong:** The `setTableLastSyncAt` / `getTableLastSyncAt` path stores `DateTime.now()` (local) as ISO string. After fixing sync payloads to UTC, the delta sync queries could have an off-by-timezone-offset gap.
**Why it happens:** `DateTime.now().toIso8601String()` stored in app_settings (local time string), then parsed back via `DateTime.tryParse()` (which returns local DateTime), then serialized via `.toIso8601String()` in the Supabase query filter. If the sync payload timestamps are now UTC but the `since` filter is still local, there's a mismatch.
**How to avoid:** Also fix `setTableLastSyncAt` calls to use `DateTime.now().toUtc()`, and ensure `app_settings_service.dart` stores UTC. The 30-second safety margin in `_getSafeSince` provides some buffer, but the fix should be applied consistently.
**Warning signs:** After fix, incremental sync re-fetches all records instead of just delta.

### Pitfall 4: AutocompleteField Used Elsewhere
**What goes wrong:** Replacing AutocompleteField in customer/pipeline forms but missing other usages.
**Why it happens:** Not checking all imports of AutocompleteField.
**How to avoid:** Grep for all AutocompleteField usages. Current findings: only 3 files import it (customer_form_screen.dart, pipeline_form_screen.dart, autocomplete_field.dart itself). After migration, the widget file can potentially be deleted or deprecated.
**Warning signs:** Other screens still using AutocompleteField.

### Pitfall 5: SearchableDropdown API Differences
**What goes wrong:** SearchableDropdown uses `DropdownItem` while AutocompleteField uses `AutocompleteItem`. Different class names, same shape.
**Why it happens:** Two different widget implementations with independent item models.
**How to avoid:** Simple mechanical change: `AutocompleteItem` -> `DropdownItem`, `AutocompleteField` -> `SearchableDropdown`, add `modalTitle` parameter.
**Warning signs:** Import errors or type mismatches after replacement.

### Pitfall 6: Sync Payload Timestamps for Incremental Pull Queries in Remote Data Sources
**What goes wrong:** Remote data source methods like `fetchCustomers(since)` use `since.toIso8601String()` in Supabase query filters. If `since` is a local DateTime, the filter may not match correctly against UTC server timestamps.
**Why it happens:** The `since` parameter flows from `_getSafeSince()` which reads from `app_settings` (stored as local time string).
**How to avoid:** Fix the entire chain: store UTC in app_settings, serialize UTC in query filters. All 24+ occurrences in remote data sources should use `.toUtc().toIso8601String()`.
**Warning signs:** Incremental sync misses records or re-fetches everything.

## Code Examples

### Example 1: Repository Sync Payload Fix (Before/After)

```dart
// BEFORE (lib/data/repositories/activity_repository_impl.dart)
Map<String, dynamic> _createSyncPayload(String id, ActivityCreateDto dto, DateTime now) {
  return {
    'id': id,
    'scheduled_datetime': dto.scheduledDatetime.toIso8601String(),  // BUG: no timezone
    'created_at': now.toIso8601String(),                            // BUG: no timezone
    'updated_at': now.toIso8601String(),                            // BUG: no timezone
  };
}

// AFTER
import '../../../core/utils/date_time_utils.dart';

Map<String, dynamic> _createSyncPayload(String id, ActivityCreateDto dto, DateTime now) {
  return {
    'id': id,
    'scheduled_datetime': dto.scheduledDatetime.toUtcIso8601(),  // FIXED: produces Z suffix
    'created_at': now.toUtcIso8601(),                            // FIXED
    'updated_at': now.toUtcIso8601(),                            // FIXED
  };
}
```

### Example 2: Nullable DateTime Pattern

```dart
// BEFORE
'executed_at': data.executedAt?.toIso8601String(),
'cancelled_at': data.cancelledAt?.toIso8601String(),

// AFTER (using nullable extension)
'executed_at': data.executedAt?.toUtcIso8601(),
'cancelled_at': data.cancelledAt?.toUtcIso8601(),
```

### Example 3: Remote Data Source Query Fix

```dart
// BEFORE (lib/data/datasources/remote/customer_remote_data_source.dart)
query = query.gte('updated_at', since.toIso8601String());

// AFTER
query = query.gte('updated_at', since.toUtcIso8601());
```

### Example 4: Sync Timestamp Storage Fix

```dart
// BEFORE (lib/presentation/providers/sync_providers.dart)
_appSettingsService.setTableLastSyncAt('customers', DateTime.now());

// AFTER
_appSettingsService.setTableLastSyncAt('customers', DateTime.now().toUtc());
```

### Example 5: SearchableDropdown Migration

```dart
// BEFORE (customer_form_screen.dart)
import '../../widgets/common/autocomplete_field.dart';

AutocompleteField<String>(
  label: 'Provinsi *',
  hint: 'Ketik untuk mencari provinsi...',
  value: _selectedProvinceId,
  items: provinces
      .map((p) => AutocompleteItem(value: p.id, label: p.name))
      .toList(),
  onChanged: (value) => setState(() { _selectedProvinceId = value; }),
  validator: (v) => v == null ? 'Provinsi wajib dipilih' : null,
)

// AFTER
import '../../widgets/common/searchable_dropdown.dart';

SearchableDropdown<String>(
  label: 'Provinsi *',
  hint: 'Ketik untuk mencari provinsi...',
  modalTitle: 'Pilih Provinsi',
  value: _selectedProvinceId,
  items: provinces
      .map((p) => DropdownItem(value: p.id, label: p.name))
      .toList(),
  onChanged: (value) => setState(() { _selectedProvinceId = value; }),
  validator: (v) => v == null ? 'Provinsi wajib dipilih' : null,
)
```

## Scope Analysis: What Needs Fixing

### Bug 1: Timezone Serialization -- Complete Inventory

**Category A: Repository Sync Payloads (MUST FIX -- these go to Supabase via sync queue)**
| File | Count | Notes |
|------|-------|-------|
| `activity_repository_impl.dart` | 22 | 4 sync payload builder methods + cancelActivity inline |
| `cadence_repository_impl.dart` | 16 | Meeting + participant payload builders |
| `pipeline_referral_repository_impl.dart` | 12 | Create, accept, reject, approve, cancel payloads |
| `customer_repository_impl.dart` | 10 | Customer + key person sync payloads |
| `pipeline_repository_impl.dart` | 9 | Pipeline sync payload builders |
| `hvc_repository_impl.dart` | 6 | HVC + link payloads |
| `broker_repository_impl.dart` | 4 | Broker sync payloads |
| `admin_4dx_repository_impl.dart` | 4 | 4DX period date payloads (start_date, end_date) |
| `auth_repository_impl.dart` | 3 | last_login_at, updated_at |
| **Subtotal** | **86** | |

**Category B: Remote Data Source Calls (MUST FIX -- direct Supabase API calls)**
| File | Count | Notes |
|------|-------|-------|
| `cadence_remote_data_source.dart` | 12 | Timestamps for meeting operations + delta sync queries |
| `admin_master_data_remote_data_source.dart` | 8 | CRUD timestamps for master data |
| `activity_remote_data_source.dart` | 6 | Delta sync `since` queries (5) + deleted_at (1) |
| `hvc_remote_data_source.dart` | 6 | Delta sync queries + soft delete timestamps |
| `customer_remote_data_source.dart` | 5 | Delta sync queries + soft delete timestamps |
| `pipeline_remote_data_source.dart` | 4 | Delta sync queries + soft delete timestamp |
| `pipeline_referral_remote_data_source.dart` | 4 | Delta sync queries |
| `broker_remote_data_source.dart` | 3 | Delta sync query + soft delete timestamps |
| `history_log_remote_data_source.dart` | 4 | Query filters for created_at |
| `scoreboard_remote_data_source.dart` | 2 | assigned_at, now timestamps |
| **Subtotal** | **54** | (5 already correct in admin_user_remote_data_source.dart) |

**Category C: Services (MUST FIX)**
| File | Count | Notes |
|------|-------|-------|
| `sync_service.dart` | 1 | Soft delete `deleted_at` in processQueue |
| `app_settings_service.dart` | 2 | `markInitialSyncCompleted` + `setTableLastSyncAt` |
| `initial_sync_service.dart` | 4 | Delta sync `since` query filters |
| **Subtotal** | **7** | |

**Category D: Providers (MUST FIX)**
| File | Count | Notes |
|------|-------|-------|
| `activity_providers.dart` | 2 | Photo sync payload: taken_at, created_at |
| `sync_providers.dart` | 9 | `DateTime.now()` passed to `setTableLastSyncAt` (need `.toUtc()`) |
| **Subtotal** | **11** | |

**Category E: Generated `.g.dart` Files (DO NOT FIX NOW)**
| Location | Count | Notes |
|----------|-------|-------|
| `lib/data/dtos/*.g.dart` | 60 | DTO toJson() -- NOT used in sync path |
| `lib/domain/entities/*.g.dart` | 80 | Entity toJson() -- NOT used in sync path |
| **Subtotal** | **140** | Only fix if DTOs start being used for sync; requires JsonConverter approach |

**TOTAL TO FIX: ~158 occurrences across ~24 files (Categories A-D)**

### Bug 2: Dropdown Race Condition -- Complete Inventory

| File | Dropdown Count | Dropdown Fields |
|------|---------------|-----------------|
| `customer_form_screen.dart` | 5 | Province, City, CompanyType, OwnershipType, Industry |
| `pipeline_form_screen.dart` | 6 | COB, LOB, LeadSource, Broker, BrokerPIC, CustomerContact |
| **Total** | **11** | All use `AutocompleteField` -> replace with `SearchableDropdown` |

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| `DateTime.now().toIso8601String()` | `DateTime.now().toUtc().toIso8601String()` | Known issue since Dart SDK (issue #43391, filed 2020) | Dart will not change behavior; `toIso8601String()` on local DateTime intentionally omits timezone. Developer must call `.toUtc()` first. |
| Custom overlay dropdowns | Modal bottom sheet or Flutter `Autocomplete` widget | Flutter 3.x+ | Overlay-based approaches remain fragile. Modal patterns (bottom sheet) are recommended for mobile-first apps. |

**Deprecated/outdated:**
- AutocompleteField (custom widget in this codebase): Should be deprecated in favor of SearchableDropdown for all selection use cases. The overlay approach has fundamental timing issues that cannot be fully resolved.

## Open Questions

1. **Existing Server Data Migration**
   - What we know: All timestamps currently in Supabase are shifted by the user's timezone offset (+7h for WIB users). The server thinks `21:00` local is `21:00 UTC`.
   - What's unclear: Whether a server-side migration is needed to correct existing data, or if it's acceptable to only fix going forward.
   - Recommendation: This is OUT OF SCOPE for Phase 02.1 (client-side fixes only). Document as a future concern. The data discrepancy only matters for historical reporting; going forward, new timestamps will be correct.

2. **Date-only Fields (expected_close_date, start_date, end_date)**
   - What we know: `expectedCloseDate`, `start_date`, `end_date` are date-only fields stored as `DATE` type in PostgreSQL (not TIMESTAMPTZ). Applying `.toUtc()` to a date-only field could shift the date by one day if local time is near midnight.
   - What's unclear: Whether these specific columns are DATE or TIMESTAMPTZ in the schema.
   - Recommendation: Check the Supabase schema for these specific columns. If they are `DATE` type, serialize as date-only string (`yyyy-MM-dd`) instead of ISO 8601 timestamp. If TIMESTAMPTZ, apply `.toUtc()` like all others.

3. **AutocompleteField Deletion**
   - What we know: After migrating customer and pipeline forms to SearchableDropdown, no files will import AutocompleteField.
   - What's unclear: Whether to delete the file or keep it as deprecated.
   - Recommendation: Delete `autocomplete_field.dart` after confirming zero usages via grep. Dead code should be removed.

## Sources

### Primary (HIGH confidence)
- [Dart API: DateTime.toIso8601String()](https://api.flutter.dev/flutter/dart-core/DateTime/toIso8601String.html) -- Confirmed: local DateTime produces no timezone indicator, UTC produces `Z` suffix
- [Dart SDK Issue #43391](https://github.com/dart-lang/sdk/issues/43391) -- Confirmed: known limitation, by design, not a bug in Dart
- Codebase analysis: `admin_user_remote_data_source.dart` already uses `.toUtc().toIso8601String()` correctly (5 occurrences)
- Codebase analysis: `SearchableDropdown` widget already exists and works correctly in activity forms
- `.planning/debug/timezone-mismatch-issue.md` -- Full diagnosis with mathematical proof of the +7h shift
- `.planning/debug/dropdown-form-issue.md` -- Full diagnosis with overlay timing analysis

### Secondary (MEDIUM confidence)
- [Flutter TextFieldTapRegion](https://api.flutter.dev/flutter/widgets/TextFieldTapRegion-class.html) -- Could theoretically fix AutocompleteField, but has known limitations with overlay widgets
- [Flutter Autocomplete Issue #99749](https://github.com/flutter/flutter/issues/99749) -- Even Flutter's built-in Autocomplete has overlay dismissal issues
- [Flutter Autocomplete Issue #140662](https://github.com/flutter/flutter/issues/140662) -- Focus vs tap event distinction remains problematic
- [json_serializable custom JsonConverter](https://pub.dev/packages/json_serializable) -- Available for generated code but NOT needed since repos don't use DTO.toJson() for sync

### Tertiary (LOW confidence)
- None -- all findings verified against codebase and official docs

## Metadata

**Confidence breakdown:**
- Timezone fix approach: HIGH -- Dart docs confirm behavior; correct pattern exists in codebase; mathematical proof matches user report
- Occurrence inventory: HIGH -- grep counts verified against codebase; file-by-file breakdown complete
- Dropdown fix approach: HIGH -- SearchableDropdown already proven in codebase; modal bottom sheet is architecturally immune to overlay race conditions
- Incremental sync timestamp fix: HIGH -- chain traced from storage through query filters; consistent UTC usage required end-to-end
- Date-only field handling: MEDIUM -- need to verify schema column types before applying .toUtc()

**Research date:** 2026-02-13
**Valid until:** 2026-03-13 (stable domain, no expected framework changes)
