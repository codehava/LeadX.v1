---
phase: 02.1-pre-existing-bug-fixes-timezone-serialization-dropdown-race-condition
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/core/utils/date_time_utils.dart
  - lib/data/repositories/activity_repository_impl.dart
  - lib/data/repositories/cadence_repository_impl.dart
  - lib/data/repositories/pipeline_referral_repository_impl.dart
  - lib/data/repositories/customer_repository_impl.dart
  - lib/data/repositories/pipeline_repository_impl.dart
  - lib/data/repositories/hvc_repository_impl.dart
  - lib/data/repositories/broker_repository_impl.dart
  - lib/data/repositories/admin_4dx_repository_impl.dart
  - lib/data/repositories/auth_repository_impl.dart
  - lib/presentation/providers/activity_providers.dart
autonomous: true

must_haves:
  truths:
    - "All .toIso8601String() calls in repository sync payloads produce UTC timestamps with Z suffix"
    - "Date-only fields (expected_close_date, start_date, end_date) are serialized as date-only strings, not UTC timestamps"
    - "A centralized toUtcIso8601() helper exists to prevent future recurrence"
  artifacts:
    - path: "lib/core/utils/date_time_utils.dart"
      provides: "toUtcIso8601() extension methods for DateTime and DateTime?"
      contains: "toUtcIso8601"
    - path: "lib/data/repositories/activity_repository_impl.dart"
      provides: "Activity sync payloads with UTC timestamps"
      contains: "toUtcIso8601"
    - path: "lib/data/repositories/cadence_repository_impl.dart"
      provides: "Cadence sync payloads with UTC timestamps"
      contains: "toUtcIso8601"
    - path: "lib/data/repositories/customer_repository_impl.dart"
      provides: "Customer sync payloads with UTC timestamps"
      contains: "toUtcIso8601"
    - path: "lib/data/repositories/pipeline_repository_impl.dart"
      provides: "Pipeline sync payloads with UTC timestamps"
      contains: "toUtcIso8601"
  key_links:
    - from: "lib/data/repositories/*.dart"
      to: "lib/core/utils/date_time_utils.dart"
      via: "import and .toUtcIso8601() extension calls"
      pattern: "import.*date_time_utils"
---

<objective>
Create centralized UTC timestamp helper and fix all 86 .toIso8601String() calls in repository sync payloads plus 2 in activity_providers.dart.

Purpose: Repository sync payloads are the primary path where timestamps reach Supabase. Without .toUtc(), local DateTime objects serialize without timezone indicator, causing Supabase (UTC-configured) to misinterpret local times as UTC -- shifting all timestamps by the user's timezone offset (+7h for WIB users).

Output: date_time_utils.dart utility + 9 repository files and 1 provider file with corrected timestamp serialization.
</objective>

<execution_context>
@C:/Users/cartr/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/cartr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02.1-pre-existing-bug-fixes-timezone-serialization-dropdown-race-condition/02.1-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create date_time_utils.dart and fix repository sync payloads (86 occurrences)</name>
  <files>
    lib/core/utils/date_time_utils.dart
    lib/data/repositories/activity_repository_impl.dart
    lib/data/repositories/cadence_repository_impl.dart
    lib/data/repositories/pipeline_referral_repository_impl.dart
    lib/data/repositories/customer_repository_impl.dart
    lib/data/repositories/pipeline_repository_impl.dart
    lib/data/repositories/hvc_repository_impl.dart
    lib/data/repositories/broker_repository_impl.dart
    lib/data/repositories/admin_4dx_repository_impl.dart
    lib/data/repositories/auth_repository_impl.dart
  </files>
  <action>
    1. Create `lib/core/utils/date_time_utils.dart` with:
       - `extension DateTimeUtcExtension on DateTime` with `String toUtcIso8601() => toUtc().toIso8601String();`
       - `extension NullableDateTimeUtcExtension on DateTime?` with `String? toUtcIso8601() => this?.toUtc().toIso8601String();`
       - Doc comments explaining WHY this exists (Dart's .toIso8601String() omits timezone for local DateTime, Supabase interprets bare timestamps as UTC).

    2. In each of the 9 repository files:
       - Add `import '../../../core/utils/date_time_utils.dart';` (adjust relative path as needed based on file location)
       - Replace every `.toIso8601String()` with `.toUtcIso8601()` EXCEPT for date-only fields (see step 3)

    3. SPECIAL HANDLING for date-only fields -- these must be serialized as date-only strings, NOT UTC timestamps:
       - In `pipeline_repository_impl.dart`: `expected_close_date` appears at ~line 881 and ~line 909. Replace `dto.expectedCloseDate?.toIso8601String()` with `dto.expectedCloseDate?.toIso8601String().substring(0, 10)` (extracts yyyy-MM-dd). Same for `data.expectedCloseDate?.toIso8601String()`.
       - In `admin_4dx_repository_impl.dart`: `start_date` and `end_date` at ~lines 129-130 and ~lines 150-151. Replace `startDate.toIso8601String()` with `startDate.toIso8601String().substring(0, 10)` and same for endDate. These are DATE columns in PostgreSQL, not TIMESTAMPTZ.
       - WHY: Applying .toUtc() to a date like "2026-03-15 00:00:00 WIB" would shift it to "2026-03-14T17:00:00.000Z" -- changing the date by one day for UTC+ timezones.

    4. Occurrence counts per file (verify all are addressed):
       - activity_repository_impl.dart: 22 occurrences
       - cadence_repository_impl.dart: 16 occurrences
       - pipeline_referral_repository_impl.dart: 12 occurrences
       - customer_repository_impl.dart: 10 occurrences
       - pipeline_repository_impl.dart: 9 occurrences (7 timestamp + 2 date-only)
       - hvc_repository_impl.dart: 6 occurrences
       - broker_repository_impl.dart: 4 occurrences
       - admin_4dx_repository_impl.dart: 4 occurrences (all date-only: use substring, not toUtcIso8601)
       - auth_repository_impl.dart: 3 occurrences
  </action>
  <verify>
    Run: `grep -r "\.toIso8601String()" lib/data/repositories/ --include="*.dart" | grep -v ".g.dart" | grep -v ".freezed.dart"`
    Expected: ZERO results. All bare .toIso8601String() calls in repository files should be gone -- replaced with either .toUtcIso8601() or .toIso8601String().substring(0, 10) for date-only fields.
    Also run: `grep -r "toUtcIso8601" lib/data/repositories/ | wc -l` -- should show ~80 occurrences.
    Also run: `flutter analyze` -- should show no new errors.
  </verify>
  <done>All 86 .toIso8601String() calls in 9 repository sync payload files are replaced. Date-only fields use date-only string format. date_time_utils.dart exists with toUtcIso8601() extension.</done>
</task>

<task type="auto">
  <name>Task 2: Fix activity_providers.dart photo sync payload (2 occurrences)</name>
  <files>
    lib/presentation/providers/activity_providers.dart
  </files>
  <action>
    1. Add `import '../../../core/utils/date_time_utils.dart';` (adjust path -- providers are at lib/presentation/providers/)
       - Correct path: `import '../../core/utils/date_time_utils.dart';`
    2. Replace the 2 .toIso8601String() calls in the photo sync payload (~line 347 and ~line 350):
       - `'taken_at': photo.takenAt.toIso8601String()` -> `'taken_at': photo.takenAt.toUtcIso8601()`
       - `'created_at': DateTime.now().toIso8601String()` -> `'created_at': DateTime.now().toUtcIso8601()`
  </action>
  <verify>
    Run: `grep "\.toIso8601String()" lib/presentation/providers/activity_providers.dart`
    Expected: ZERO results.
    Run: `flutter analyze` -- no new errors.
  </verify>
  <done>Both .toIso8601String() calls in activity_providers.dart photo sync payload now use .toUtcIso8601().</done>
</task>

</tasks>

<verification>
1. `grep -r "\.toIso8601String()" lib/data/repositories/ --include="*.dart" | grep -v ".g.dart" | grep -v ".freezed.dart"` returns zero results
2. `grep -r "\.toIso8601String()" lib/presentation/providers/activity_providers.dart` returns zero results
3. `grep -r "toUtcIso8601" lib/data/repositories/ lib/presentation/providers/activity_providers.dart` shows ~82+ occurrences
4. `grep -r "substring(0, 10)" lib/data/repositories/pipeline_repository_impl.dart lib/data/repositories/admin_4dx_repository_impl.dart` shows 6 date-only field occurrences
5. `flutter analyze` passes with no new errors
</verification>

<success_criteria>
- Zero bare .toIso8601String() calls remain in any repository file or activity_providers.dart
- date_time_utils.dart exists at lib/core/utils/date_time_utils.dart with DateTime and DateTime? extensions
- Date-only fields (expected_close_date, start_date, end_date) serialize as yyyy-MM-dd strings
- flutter analyze passes
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-pre-existing-bug-fixes-timezone-serialization-dropdown-race-condition/02.1-01-SUMMARY.md`
</output>
