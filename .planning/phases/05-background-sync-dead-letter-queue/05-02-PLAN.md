---
phase: 05-background-sync-dead-letter-queue
plan: 02
type: execute
wave: 2
depends_on: [05-01]
files_modified:
  - lib/core/utils/sync_error_translator.dart
  - lib/presentation/screens/sync/sync_queue_screen.dart
  - lib/presentation/screens/profile/settings_screen.dart
  - lib/presentation/widgets/shell/responsive_shell.dart
  - lib/presentation/widgets/common/sync_status_badge.dart
autonomous: true
requirements: [CONF-02, SYNC-06]

must_haves:
  truths:
    - "User can see dead letter items prominently in the sync queue screen with translated Indonesian error messages"
    - "User can retry a dead letter item (resets count, moves back to pending)"
    - "User can discard a dead letter item with confirmation dialog (entity stays local, cleared from queue)"
    - "User can bulk retry all dead letter items via 'Coba Ulang Semua' button"
    - "Settings Sinkronisasi row shows red badge count when dead letter items exist"
    - "Settings Sinkronisasi subtitle shows 'Terakhir sinkronisasi: X menit lalu' timestamp"
    - "App bar sync icon shows persistent warning state when dead letter items exist"
    - "Tapping app bar warning icon navigates directly to sync queue screen"
    - "Empty state shows 'Semua data tersinkronisasi' with checkmark icon"
  artifacts:
    - path: "lib/core/utils/sync_error_translator.dart"
      provides: "Maps raw error strings to user-friendly Indonesian messages"
      contains: "SyncErrorTranslator"
    - path: "lib/presentation/screens/sync/sync_queue_screen.dart"
      provides: "Production-ready dead letter UI evolved from debug screen"
      contains: "GAGAL PERMANEN"
    - path: "lib/presentation/screens/profile/settings_screen.dart"
      provides: "Badge count and last sync timestamp on Sinkronisasi row"
      contains: "deadLetterCountProvider"
    - path: "lib/presentation/widgets/shell/responsive_shell.dart"
      provides: "Dead letter warning state in app bar sync button"
      contains: "deadLetterCountProvider"
    - path: "lib/presentation/widgets/common/sync_status_badge.dart"
      provides: "New deadLetter SyncStatus variant"
      contains: "deadLetter"
  key_links:
    - from: "lib/presentation/screens/sync/sync_queue_screen.dart"
      to: "lib/core/utils/sync_error_translator.dart"
      via: "SyncErrorTranslator.translate() for display"
      pattern: "SyncErrorTranslator"
    - from: "lib/presentation/screens/sync/sync_queue_screen.dart"
      to: "lib/presentation/providers/sync_providers.dart"
      via: "deadLetterCountProvider for tab/filter counts"
      pattern: "deadLetterCountProvider"
    - from: "lib/presentation/widgets/shell/responsive_shell.dart"
      to: "lib/presentation/providers/sync_providers.dart"
      via: "deadLetterCountProvider for warning badge"
      pattern: "deadLetterCountProvider"
    - from: "lib/presentation/screens/profile/settings_screen.dart"
      to: "lib/presentation/providers/sync_providers.dart"
      via: "deadLetterCountProvider + lastSyncTimestampProvider"
      pattern: "deadLetterCountProvider"
---

<objective>
Evolve the debug SyncQueueScreen into a production-ready dead letter UI and add user awareness indicators across the app.

Purpose: Users need to see permanently failed sync items, understand why they failed (in Indonesian), and take action (retry or discard). The app bar and settings screen need to surface dead letter counts so users know there are items requiring attention, per CONF-02 and the locked user decisions.

Output: Production-quality sync queue screen with dead letter prominence, error translation, retry/discard actions, settings badge, app bar warning state.
</objective>

<execution_context>
@C:/Users/cartr/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/cartr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-background-sync-dead-letter-queue/05-RESEARCH.md
@.planning/phases/05-background-sync-dead-letter-queue/05-01-SUMMARY.md

@lib/presentation/screens/sync/sync_queue_screen.dart
@lib/presentation/screens/profile/settings_screen.dart
@lib/presentation/widgets/shell/responsive_shell.dart
@lib/presentation/widgets/common/sync_status_badge.dart
@lib/presentation/providers/sync_providers.dart
@lib/data/datasources/local/sync_queue_local_data_source.dart
@lib/data/services/sync_service.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SyncErrorTranslator + evolve SyncQueueScreen into production dead letter UI</name>
  <files>
    lib/core/utils/sync_error_translator.dart
    lib/presentation/screens/sync/sync_queue_screen.dart
  </files>
  <action>
**Create `lib/core/utils/sync_error_translator.dart`:**

A utility class that maps raw error strings to user-friendly Indonesian messages. Use string pattern matching (contains checks) since error strings come from SyncError.message stored in lastError column.

```dart
class SyncErrorTranslator {
  static String translate(String? rawError) {
    if (rawError == null || rawError.isEmpty) return 'Kesalahan tidak diketahui';

    // Auth errors
    if (rawError.contains('Authentication failed') || rawError.contains('401')) {
      return 'Sesi login kedaluwarsa. Silakan login ulang.';
    }
    // Validation errors
    if (rawError.contains('Validation error')) {
      return 'Data tidak valid. Periksa dan coba lagi.';
    }
    // Network errors
    if (rawError.contains('Network unreachable') || rawError.contains('SocketException')) {
      return 'Tidak ada koneksi internet.';
    }
    // Timeout
    if (rawError.contains('timed out') || rawError.contains('Timeout')) {
      return 'Server tidak merespons. Coba lagi nanti.';
    }
    // Conflict
    if (rawError.contains('Conflict')) {
      return 'Data konflik dengan server. Versi server lebih baru.';
    }
    // Server errors
    if (rawError.contains('Server error') || rawError.contains('500')) {
      return 'Server sedang bermasalah. Coba lagi nanti.';
    }
    // Foreign key / reference errors
    if (rawError.contains('violates foreign key') || rawError.contains('not present in table')) {
      return 'Data referensi tidak ditemukan di server.';
    }

    // Fallback with truncated raw error
    final truncated = rawError.length > 80 ? '${rawError.substring(0, 80)}...' : rawError;
    return 'Gagal sinkronisasi: $truncated';
  }

  /// Translate entity type to Indonesian display name.
  static String entityTypeName(String entityType) => switch (entityType) {
    'customer' => 'Pelanggan',
    'keyPerson' => 'Kontak',
    'pipeline' => 'Pipeline',
    'activity' => 'Aktivitas',
    'hvc' => 'HVC',
    'customerHvcLink' => 'Link HVC',
    'broker' => 'Broker',
    'pipelineStageHistory' => 'Riwayat Pipeline',
    'pipelineReferral' => 'Referral',
    'cadenceMeeting' => 'Cadence',
    'cadenceParticipant' => 'Peserta Cadence',
    'cadenceConfig' => 'Konfigurasi Cadence',
    _ => entityType,
  };

  /// Translate operation to Indonesian display name.
  static String operationName(String operation) => switch (operation) {
    'create' => 'Buat',
    'update' => 'Ubah',
    'delete' => 'Hapus',
    _ => operation,
  };
}
```

**Rewrite `lib/presentation/screens/sync/sync_queue_screen.dart`:**

Transform from debug screen to production-ready dead letter UI. Key changes:

1. **AppBar title**: Change from 'Sync Queue (Debug)' to 'Sinkronisasi'. Keep existing actions (sync trigger, clear).

2. **Tab/filter structure**: Add a filter toggle or tab-like UI at the top. Two views:
   - "Gagal" (default) -- Shows only dead_letter and failed items. This is the primary view per locked decision.
   - "Semua" -- Shows all queue items (full queue view capability per locked decision).
   Use a simple `SegmentedButton<String>` or toggle chips.

3. **Replace FutureBuilder with StreamBuilder**: Instead of `FutureBuilder<List<db.SyncQueueItem>>` using `getAllItems()`, use a StreamProvider or watch a stream. Since we need filtering, keep FutureBuilder but rebuild on filter change. Better: use `ref.watch` pattern. Create a local state notifier or use useState with ConsumerStatefulWidget.

   Actually, simplest approach: Convert to ConsumerStatefulWidget, use a filter state variable, call appropriate method based on filter, and trigger rebuild via a key or setState.

4. **Card redesign for dead letter items**:
   - Show `SyncErrorTranslator.entityTypeName(item.entityType)` as title (e.g., "Pelanggan")
   - Show `SyncErrorTranslator.operationName(item.operation)` as subtitle tag (e.g., "Buat")
   - Show `SyncErrorTranslator.translate(item.lastError)` as the error message (NOT raw monospace text)
   - Show timestamp in "dd/MM/yyyy HH:mm" format
   - Status badges in Indonesian: 'MENUNGGU' (pending), 'GAGAL' (failed), 'GAGAL PERMANEN' (dead_letter)
   - Entity ID in an expandable section (for power users, not prominently displayed)
   - Retry count shown as "Percobaan: X/5"

5. **Actions per card**:
   - **Retry button**: Calls `syncQueueDataSource.resetRetryCount(item.id)` then rebuilds. Label: "Coba Ulang". Show for both failed and dead_letter items.
   - **Discard button**: Shows confirmation dialog first, then calls `syncService.discardDeadLetterItem(item)`. Label: "Buang".
     - Confirmation dialog text: For 'create' operations: "Item ini belum pernah disinkronkan ke server. Data akan tetap ada di perangkat Anda tetapi tidak terlihat oleh pengguna lain."
     - For 'update' operations: "Server akan menyimpan versi lama dari data ini."
     - For 'delete' operations: "Penghapusan dibatalkan. Data tetap ada di perangkat dan server."
     - Dialog buttons: "Batal" and "Buang"

6. **Bulk actions**: Add a "Coba Ulang Semua" button in the app bar or above the list when dead letter items are visible. This iterates all dead_letter items and calls resetRetryCount on each, then triggers sync.

7. **Conflict count banner**: Keep existing conflict count banner but translate: "$count konflik terdeteksi dalam 7 hari terakhir" (instead of English).

8. **Empty state**: Keep existing "Semua data tersinkronisasi" with cloud_done icon. Already in Indonesian.

9. **Pull to refresh**: Replace the no-op RefreshIndicator with one that actually triggers sync and rebuilds.
  </action>
  <verify>
    `flutter analyze` passes.
    Read the screen code and verify: Indonesian labels, dead letter filter, retry/discard buttons, error translation, confirmation dialog.
  </verify>
  <done>
    - SyncQueueScreen is production-ready with Indonesian labels
    - Dead letter items show translated error messages via SyncErrorTranslator
    - Users can retry individual items or bulk retry all
    - Users can discard items with appropriate confirmation dialog
    - Filter toggle shows Gagal (default) vs Semua view
    - Status badges show MENUNGGU/GAGAL/GAGAL PERMANEN
  </done>
</task>

<task type="auto">
  <name>Task 2: Settings badge + timestamp, app bar dead letter warning, SyncStatus.deadLetter</name>
  <files>
    lib/presentation/widgets/common/sync_status_badge.dart
    lib/presentation/widgets/shell/responsive_shell.dart
    lib/presentation/screens/profile/settings_screen.dart
  </files>
  <action>
**Update `lib/presentation/widgets/common/sync_status_badge.dart`:**

Add a `deadLetter` variant to the `SyncStatus` enum:
```dart
enum SyncStatus {
  synced,
  pending,
  failed,
  offline,
  deadLetter,  // NEW
}
```

In `SyncStatusBadge.build()`, add the deadLetter case to the switch:
```dart
SyncStatus.deadLetter => (AppColors.syncFailed, 'Dead Letter', Icons.warning_amber),
```
Use `AppColors.syncFailed` (red) or a persistent orange/amber. Per locked decision: "persistent orange/red warning icon when dead letter items exist". Use `Colors.orange` for distinction from the red `failed` state:
```dart
SyncStatus.deadLetter => (Colors.orange, 'Gagal', Icons.warning_amber),
```

**Update `lib/presentation/widgets/shell/responsive_shell.dart`:**

In `_buildSyncButton`:

1. Add a watch for `deadLetterCountProvider`:
   ```dart
   final deadLetterCount = ref.watch(deadLetterCountProvider);
   ```

2. Update the status determination logic. After the existing status logic, add dead letter override:
   ```dart
   // Dead letter items take priority over synced state
   final dlCount = deadLetterCount.valueOrNull ?? 0;
   if (dlCount > 0 && status == SyncStatus.synced) {
     status = SyncStatus.deadLetter;
   }
   ```
   This ensures the warning shows when everything is synced but dead letters exist.

3. Update the onTap behavior: When status is `SyncStatus.deadLetter`, tapping navigates directly to the sync queue screen instead of triggering sync:
   ```dart
   onTap: () async {
     if (status == SyncStatus.deadLetter) {
       context.push('/home/sync-queue');
       return;
     }
     // ... existing sync trigger logic
   }
   ```

4. Update the badge display: When dead letter items exist, show the dead letter count badge instead of pending count. Use red instead of orange/warning color:
   ```dart
   if (dlCount > 0)
     Positioned(
       right: 4,
       top: 4,
       child: Container(
         padding: const EdgeInsets.all(4),
         decoration: const BoxDecoration(
           color: Colors.red,
           shape: BoxShape.circle,
         ),
         child: Text(
           '$dlCount',
           style: const TextStyle(fontSize: 10, color: Colors.white, fontWeight: FontWeight.bold),
         ),
       ),
     )
   else if ((pendingCount.value ?? 0) > 0)
     // ... existing pending badge
   ```

5. Add the import for `deadLetterCountProvider` (already in sync_providers.dart from Plan 01).

**Update `lib/presentation/screens/profile/settings_screen.dart`:**

1. Add imports for `deadLetterCountProvider`, `lastSyncTimestampProvider` from sync_providers.dart.

2. The Sinkronisasi ListTile needs to show:
   - Red badge with dead letter count (when > 0)
   - Subtitle showing last sync timestamp: "Terakhir sinkronisasi: X menit lalu"

3. Update the Sinkronisasi ListTile. The screen is currently a `ConsumerWidget` so we can use `ref.watch`:
   ```dart
   Consumer(
     builder: (context, ref, _) {
       final dlCount = ref.watch(deadLetterCountProvider);
       final lastSync = ref.watch(lastSyncTimestampProvider);

       return ListTile(
         leading: Stack(
           children: [
             const Icon(Icons.sync_outlined),
             if ((dlCount.valueOrNull ?? 0) > 0)
               Positioned(
                 right: -2,
                 top: -2,
                 child: Container(
                   padding: const EdgeInsets.all(3),
                   decoration: const BoxDecoration(
                     color: Colors.red,
                     shape: BoxShape.circle,
                   ),
                   child: Text(
                     '${dlCount.valueOrNull}',
                     style: const TextStyle(fontSize: 8, color: Colors.white, fontWeight: FontWeight.bold),
                   ),
                 ),
               ),
           ],
         ),
         title: const Text('Sinkronisasi'),
         subtitle: Text(_formatLastSync(lastSync.valueOrNull)),
         trailing: const Icon(Icons.chevron_right),
         onTap: () => context.push('/home/sync-queue'),
       );
     },
   )
   ```

4. Add helper method `_formatLastSync(DateTime? lastSync)`:
   ```dart
   String _formatLastSync(DateTime? lastSync) {
     if (lastSync == null) return 'Belum pernah sinkronisasi';
     final diff = DateTime.now().difference(lastSync);
     if (diff.inMinutes < 1) return 'Terakhir sinkronisasi: baru saja';
     if (diff.inMinutes < 60) return 'Terakhir sinkronisasi: ${diff.inMinutes} menit lalu';
     if (diff.inHours < 24) return 'Terakhir sinkronisasi: ${diff.inHours} jam lalu';
     return 'Terakhir sinkronisasi: ${diff.inDays} hari lalu';
   }
   ```
   Since this is a free function or static method in a ConsumerWidget, put it as a standalone function at the bottom of the file or as a static method.

   Note: The settings_screen.dart currently is a `ConsumerWidget` and already has `ref` in the build method. However, we need a nested `Consumer` for the ListTile since the overall build method already watches `themeModeNotifierProvider`. Actually, since this is a ConsumerWidget, we can just `ref.watch` directly -- no nested Consumer needed. The ref is already available.

   Convert the sync ListTile to use ref.watch directly for dlCount and lastSync. Since the screen is already ConsumerWidget, just add the watches in the build method.
  </action>
  <verify>
    `flutter analyze` passes.
    Read responsive_shell.dart and confirm deadLetterCountProvider is watched and affects SyncStatus.
    Read settings_screen.dart and confirm badge and timestamp are shown.
    Read sync_status_badge.dart and confirm deadLetter enum variant exists.
  </verify>
  <done>
    - SyncStatusBadge has deadLetter variant with orange warning icon
    - App bar sync button shows warning state + red count badge when dead letters exist
    - Tapping app bar warning navigates to sync queue screen (per locked decision)
    - Settings Sinkronisasi row shows red badge count when dead letters exist
    - Settings Sinkronisasi subtitle shows relative "Terakhir sinkronisasi: X menit lalu" timestamp
  </done>
</task>

</tasks>

<verification>
1. `flutter analyze` passes with no errors
2. SyncQueueScreen has Indonesian labels and dead letter prominence
3. Settings screen shows badge + timestamp on Sinkronisasi row
4. App bar sync icon reflects dead letter state
5. Error messages are translated to Indonesian
</verification>

<success_criteria>
- Dead letter items visible in production-quality sync screen with translated error messages
- Retry resets count and status to pending; discard shows confirmation and clears from queue
- Bulk "Coba Ulang Semua" available
- Settings shows red badge count + last sync timestamp
- App bar shows persistent warning when dead letters exist, tap navigates to screen
</success_criteria>

<output>
After completion, create `.planning/phases/05-background-sync-dead-letter-queue/05-02-SUMMARY.md`
</output>
