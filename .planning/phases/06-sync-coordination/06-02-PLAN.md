---
phase: 06-sync-coordination
plan: 02
type: execute
wave: 2
depends_on:
  - 06-01
files_modified:
  - lib/presentation/widgets/sync/sync_progress_sheet.dart
  - lib/presentation/screens/auth/login_screen.dart
  - lib/presentation/screens/home/home_screen.dart
  - lib/presentation/widgets/shell/responsive_shell.dart
autonomous: true
requirements:
  - CONF-05

must_haves:
  truths:
    - "Initial sync auto-retries on failure with 2s/5s/15s backoff intervals"
    - "After 3 failed retries, user sees Cancel and log out button"
    - "Cancel clears auth session and preserves local database"
    - "SyncProgressSheet returns success/failure result to caller"
    - "markInitialSyncCompleted is only called on actual success, never on failure"
    - "Master data re-sync (long press) respects coordinator lock and shows toast if busy"
  artifacts:
    - path: "lib/presentation/widgets/sync/sync_progress_sheet.dart"
      provides: "Enhanced sync progress sheet with retry, backoff, and cancel-logout"
      contains: "_startSyncWithRetry"
    - path: "lib/presentation/screens/auth/login_screen.dart"
      provides: "Login screen that only marks initial sync on success"
      contains: "SyncProgressSheet.show"
  key_links:
    - from: "lib/presentation/widgets/sync/sync_progress_sheet.dart"
      to: "lib/data/services/sync_coordinator.dart"
      via: "coordinator lock acquisition for initial sync"
      pattern: "SyncCoordinator"
    - from: "lib/presentation/screens/auth/login_screen.dart"
      to: "lib/presentation/widgets/sync/sync_progress_sheet.dart"
      via: "show() return value determines markInitialSyncCompleted call"
      pattern: "SyncProgressSheet.show"
---

<objective>
Enhance SyncProgressSheet with auto-retry/backoff and cancel-and-logout, and fix the markInitialSyncCompleted bug in callers.

Purpose: The current SyncProgressSheet has no retry logic and marks initial sync as complete even on failure. This plan adds auto-retry with 2s/5s/15s backoff (3 attempts), a "Cancel and log out" button after exhausting retries, and changes `show()` to return a boolean indicating success/failure. Callers (LoginScreen, HomeScreen) are updated to only call `markInitialSyncCompleted()` on success. The master data re-sync (long press in responsive_shell.dart) is updated to check coordinator lock.

Output: Enhanced SyncProgressSheet with retry/cancel, fixed login/home screens, coordinator-aware master data re-sync.
</objective>

<execution_context>
@C:/Users/cartr/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/cartr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-sync-coordination/06-RESEARCH.md
@.planning/phases/06-sync-coordination/06-01-SUMMARY.md
@lib/presentation/widgets/sync/sync_progress_sheet.dart
@lib/presentation/screens/auth/login_screen.dart
@lib/presentation/screens/home/home_screen.dart
@lib/presentation/widgets/shell/responsive_shell.dart
@lib/data/services/sync_coordinator.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add retry/backoff and cancel-logout to SyncProgressSheet</name>
  <files>
    lib/presentation/widgets/sync/sync_progress_sheet.dart
  </files>
  <action>
    Rewrite the `SyncProgressSheet` class to add retry, backoff, cancel-and-logout, and return a success/failure result.

    1. Change `static Future<void> show(BuildContext context)` to `static Future<bool> show(BuildContext context)`:
       - The bottom sheet returns a `bool` (true = success, false = failure/cancelled).
       - Use `showModalBottomSheet<bool>` instead of `showModalBottomSheet`.
       - Return `result ?? false` (null if dismissed, which shouldn't happen since isDismissible: false).

    2. Add retry constants and state fields to `_SyncProgressSheetState`:
       ```dart
       static const _retryDelays = [
         Duration(seconds: 2),
         Duration(seconds: 5),
         Duration(seconds: 15),
       ];
       static const _maxRetries = 3;
       int _retryAttempt = 0;
       bool _showCancelButton = false;
       String? _retryMessage;
       bool _isCancelling = false;
       ```

    3. Replace `_startSync()` with `_startSyncWithRetry()`:
       - Loop up to `_maxRetries` attempts.
       - Each attempt calls `_performSingleSyncAttempt()` which runs the existing 3-phase sync (master data, delta sync, user data pull).
       - On success: set `_isComplete = true`, `_error = null`. Return.
       - On failure: increment `_retryAttempt`. If more retries available, set `_retryMessage = 'Mencoba ulang dalam ${_retryDelays[attempt].inSeconds} detik...'` (Indonesian), then `await Future.delayed(_retryDelays[attempt])`, then retry.
       - After all retries exhausted: set `_showCancelButton = true`, `_isComplete = true`, `_error = 'Sinkronisasi gagal setelah $_maxRetries percobaan'`.

    4. Extract existing sync logic into `_performSingleSyncAttempt()`:
       - Returns `bool` (true = success, false = failure).
       - Contains the existing Phase 1/2/3 logic from `_startSync()`.
       - On Phase 1 (master data) failure: return false immediately.
       - On Phase 2 (delta sync) failure: log warning but continue (existing behavior -- delta errors don't fail the whole sync).
       - On Phase 3 (user data pull) failure: log warning but continue (existing behavior).
       - If all phases complete: return true.
       - Wrap in try/catch to handle unexpected exceptions: return false.

    5. Update the `build()` method:
       - When `_showCancelButton` is true and `_isComplete` is true (all retries exhausted):
         - Show the error message.
         - Show retry count info: "Percobaan: $_retryAttempt/$_maxRetries".
         - Show a "Batalkan & Keluar" (Cancel & Log Out) filled button (red/destructive color).
         - On tap: call `_handleCancelAndLogout()`.
       - When `_isComplete` is true and `_error == null` (success):
         - Show "Lanjutkan" button that calls `Navigator.pop(context, true)` (return success).
       - When `_isComplete` is true and `_error != null` and `_showCancelButton` is true:
         - Show "Batalkan & Keluar" button.
       - When `_retryMessage != null` (between retries):
         - Show retry countdown message below the error text.

    6. Add `_handleCancelAndLogout()` method:
       - Set `_isCancelling = true`, rebuild.
       - Import and call `Supabase.instance.client.auth.signOut()` to clear auth session.
       - Preserve local database (do NOT clear any DB data -- resume pattern expects data to persist).
       - Log "ui.sync | Cancel and logout: auth cleared, local data preserved".
       - `Navigator.pop(context, false)` to return failure.
       - Note: The GoRouter auth guard will redirect to login screen after signOut.

    7. Ensure `Navigator.pop(context, true)` is used for success and `Navigator.pop(context, false)` for cancel/failure.
  </action>
  <verify>
    Run `flutter analyze lib/presentation/widgets/sync/sync_progress_sheet.dart` -- no errors.
  </verify>
  <done>
    SyncProgressSheet has retry with 2s/5s/15s backoff, shows "Batalkan & Keluar" after 3 failures, returns bool indicating success/failure, cancellation clears auth but preserves local data.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix callers to use SyncProgressSheet return value and coordinator-aware re-sync</name>
  <files>
    lib/presentation/screens/auth/login_screen.dart
    lib/presentation/screens/home/home_screen.dart
    lib/presentation/widgets/shell/responsive_shell.dart
  </files>
  <action>
    1. Update `lib/presentation/screens/auth/login_screen.dart` `_handleLogin()`:
       - Change `SyncProgressSheet.show(context)` call to capture return value: `final syncSuccess = await SyncProgressSheet.show(context);`
       - Only call `await appSettings.markInitialSyncCompleted()` if `syncSuccess` is true.
       - If `syncSuccess` is false (user cancelled/logged out): do NOT navigate to home. The auth guard will redirect to login screen after signOut.
       - Updated flow:
         ```dart
         if (!hasInitialSynced) {
           if (mounted) {
             final syncSuccess = await SyncProgressSheet.show(context);
             if (syncSuccess && mounted) {
               // SyncCoordinator.markInitialSyncComplete() is called inside the sheet on success
               // But also call appSettings as a safety net for backward compat
               await appSettings.markInitialSyncCompleted();
               AppLogger.instance.info('auth | Initial sync completed');
             } else {
               // Sync failed or user cancelled -- signOut already happened in sheet
               AppLogger.instance.warning('auth | Initial sync failed or cancelled');
               return; // Don't navigate to home
             }
           }
         }
         ```

    2. Update `lib/presentation/screens/home/home_screen.dart` `_checkInitialSync()` (or similar method):
       - Change `SyncProgressSheet.show(context)` call to capture return value.
       - Only call `markInitialSyncCompleted()` if `syncSuccess` is true.
       - If false: the auth guard handles logout redirection.

    3. Update `lib/presentation/widgets/shell/responsive_shell.dart` long-press master data re-sync:
       - Before calling `SyncProgressSheet.show(context)`, read the SyncCoordinator provider.
       - Check if coordinator lock is held: if yes, show toast "Sinkronisasi sedang berjalan, coba lagi nanti" and return without showing the sheet.
       - Import the `syncCoordinatorProvider` (which will be created in plan 03, so use `ref.read(syncCoordinatorProvider)` -- if the provider doesn't exist yet, add a TODO comment and use a direct check).
       - Actually, since plan 03 creates the provider and this plan depends on 01 not 03, we need to handle this: Read the SyncCoordinator from a provider. Since `syncCoordinatorProvider` is created in plan 03, and this plan is wave 2 alongside plan 03, we should add the coordinator check using the SyncService's isSyncing as a temporary bridge:
         - Check `ref.read(syncServiceProvider).isSyncing` -- if true, show toast and return.
         - This will be upgraded to use the coordinator provider when plan 03 wires everything together.
       - The SyncProgressSheet.show() call already returns bool now, but for re-sync we don't need to handle the return value specially since it's not the initial login flow.
  </action>
  <verify>
    Run `flutter analyze lib/presentation/screens/auth/login_screen.dart lib/presentation/screens/home/home_screen.dart lib/presentation/widgets/shell/responsive_shell.dart` -- no errors.
  </verify>
  <done>
    LoginScreen and HomeScreen only mark initial sync as completed when SyncProgressSheet returns true. Master data re-sync checks if sync is in progress before showing sheet. markInitialSyncCompleted is never called on sync failure.
  </done>
</task>

</tasks>

<verification>
1. `flutter analyze` passes on all modified files
2. SyncProgressSheet.show() returns `Future<bool>` (not `Future<void>`)
3. LoginScreen only calls markInitialSyncCompleted when syncSuccess is true
4. HomeScreen only calls markInitialSyncCompleted when syncSuccess is true
5. SyncProgressSheet retries up to 3 times with 2s/5s/15s delays
6. After 3 failures, "Batalkan & Keluar" button appears
7. Cancel button calls signOut() and returns false
8. Master data re-sync shows toast when sync is in progress
</verification>

<success_criteria>
- SyncProgressSheet has working retry/backoff mechanism with 3 attempts
- Cancel-and-logout flow clears auth session, preserves local data, returns false
- LoginScreen and HomeScreen correctly gate markInitialSyncCompleted on success only
- Master data re-sync respects sync-in-progress state
- All analysis passes
</success_criteria>

<output>
After completion, create `.planning/phases/06-sync-coordination/06-02-SUMMARY.md`
</output>
