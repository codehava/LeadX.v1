---
phase: 06-sync-coordination
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/main.dart
  - lib/presentation/screens/auth/login_screen.dart
  - lib/presentation/screens/home/home_screen.dart
  - lib/presentation/widgets/shell/responsive_shell.dart
autonomous: true
requirements:
  - CONF-05
gap_closure: true
must_haves:
  truths:
    - "App launches without zone mismatch errors and initial sync triggers correctly"
    - "Initial sync completes and populates tables (coordinator flag set so Phase 2/3 proceed)"
    - "Master data re-sync (long press) is blocked when coordinator lock is held"
  artifacts:
    - path: "lib/main.dart"
      provides: "Zone-correct binding initialization inside appRunner"
      contains: "WidgetsFlutterBinding.ensureInitialized"
    - path: "lib/presentation/screens/auth/login_screen.dart"
      provides: "Coordinator-routed markInitialSyncComplete"
      contains: "coordinator.markInitialSyncComplete"
    - path: "lib/presentation/screens/home/home_screen.dart"
      provides: "Coordinator-routed markInitialSyncComplete"
      contains: "coordinator.markInitialSyncComplete"
    - path: "lib/presentation/widgets/shell/responsive_shell.dart"
      provides: "Coordinator-aware onLongPress guard"
      contains: "coordinator.isLocked"
  key_links:
    - from: "lib/presentation/screens/auth/login_screen.dart"
      to: "lib/data/services/sync_coordinator.dart"
      via: "ref.read(syncCoordinatorProvider).markInitialSyncComplete()"
      pattern: "syncCoordinatorProvider.*markInitialSyncComplete"
    - from: "lib/presentation/widgets/shell/responsive_shell.dart"
      to: "lib/data/services/sync_coordinator.dart"
      via: "coordinator.isLocked check in onLongPress"
      pattern: "coordinator\\.isLocked"
---

<objective>
Fix three UAT-diagnosed bugs from Phase 6 verification: (1) zone mismatch crash from WidgetsFlutterBinding in root zone, (2) coordinator.markInitialSyncComplete() never called causing Phase 2/3 sync rejection, and (3) missing coordinator.isLocked guard on master data re-sync long press.

Purpose: These three bugs make the Phase 6 sync coordination non-functional in practice -- initial sync fails to populate tables and re-sync guard doesn't block.
Output: Four files patched, all three UAT tests (1, 2, 6) passing.
</objective>

<execution_context>
@C:/Users/cartr/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/cartr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-sync-coordination/06-UAT.md
@.planning/phases/06-sync-coordination/06-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix zone mismatch by moving WidgetsFlutterBinding inside appRunner</name>
  <files>lib/main.dart</files>
  <action>
In `lib/main.dart`, move `WidgetsFlutterBinding.ensureInitialized()` from line 25 (root zone, before SentryFlutter.init) to INSIDE the `appRunner:` callback as the very FIRST line (before Supabase.initialize).

Currently:
```dart
Future<void> main() async {
  WidgetsFlutterBinding.ensureInitialized();  // <-- ROOT zone
  usePathUrlStrategy();
  await dotenv.load(fileName: '.env');
  // ...
  await SentryFlutter.init(
    (options) { ... },
    appRunner: () async {
      await Supabase.initialize(...);  // <-- Sentry zone
```

Change to:
```dart
Future<void> main() async {
  // NOTE: WidgetsFlutterBinding moved inside appRunner to avoid zone mismatch
  // (Sentry wraps appRunner in its own zone; binding must be in the same zone as runApp)
  usePathUrlStrategy();
  await dotenv.load(fileName: '.env');
  // ...
  await SentryFlutter.init(
    (options) { ... },
    appRunner: () async {
      WidgetsFlutterBinding.ensureInitialized();  // <-- Same zone as runApp
      await Supabase.initialize(...);
```

IMPORTANT: `usePathUrlStrategy()` and `dotenv.load()` do NOT require WidgetsFlutterBinding and can stay in the root zone. Only the binding itself must be in the same zone as `runApp()`.

Also remove the `async` from `main()` if no longer needed at the root level -- actually keep it since `dotenv.load()` and `SentryFlutter.init()` are async and still at root level.
  </action>
  <verify>Run `flutter analyze` -- no new errors or warnings. Run `flutter build web --release` (or `flutter build apk --release` if preferred) to confirm compilation succeeds.</verify>
  <done>WidgetsFlutterBinding.ensureInitialized() is inside appRunner callback, same zone as runApp(). No zone mismatch on startup.</done>
</task>

<task type="auto">
  <name>Task 2: Route markInitialSyncComplete through coordinator and add coordinator guard to onLongPress</name>
  <files>lib/presentation/screens/auth/login_screen.dart, lib/presentation/screens/home/home_screen.dart, lib/presentation/widgets/shell/responsive_shell.dart</files>
  <action>
**Fix A: LoginScreen (login_screen.dart)**

Replace the direct `appSettings.markInitialSyncCompleted()` call with `coordinator.markInitialSyncComplete()`.

Currently at line 52-53:
```dart
if (syncSuccess && mounted) {
  await appSettings.markInitialSyncCompleted();
```

Change to:
```dart
if (syncSuccess && mounted) {
  final coordinator = ref.read(syncCoordinatorProvider);
  await coordinator.markInitialSyncComplete();
```

The coordinator's `markInitialSyncComplete()` already calls `appSettings.markInitialSyncCompleted()` internally, so this is not a behavior change -- it just also sets the in-memory `_initialSyncComplete = true` flag that gates Phase 2/3 sync.

The `syncCoordinatorProvider` import already exists via `sync_providers.dart` which is already imported.

**Fix B: HomeScreen (home_screen.dart)**

Replace the direct `appSettings.markInitialSyncCompleted()` call with `coordinator.markInitialSyncComplete()`.

Currently at line 55-56:
```dart
if (!nowSynced) {
  await appSettings.markInitialSyncCompleted();
```

Change to:
```dart
if (!nowSynced) {
  final coordinator = ref.read(syncCoordinatorProvider);
  await coordinator.markInitialSyncComplete();
```

Same rationale as Fix A. The `sync_providers.dart` import is already present.

**Fix C: ResponsiveShell onLongPress guard (responsive_shell.dart)**

Add `coordinator.isLocked` check to the `onLongPress` handler, mirroring the existing check in `onTap` (lines 266-278).

Currently at line 304-318:
```dart
onLongPress: () async {
  final isSyncing = ref.read(syncServiceProvider).isSyncing;
  if (isSyncing) {
    // ... shows toast
    return;
  }
```

Change to:
```dart
onLongPress: () async {
  // Check coordinator lock first (mirrors onTap guard)
  final coordinator = ref.read(syncCoordinatorProvider);
  if (coordinator.isLocked) {
    if (context.mounted) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('Sinkronisasi sedang berjalan, coba lagi nanti'),
          duration: Duration(seconds: 2),
        ),
      );
    }
    return;
  }

  // Also check legacy isSyncing as fallback for standalone sync
  final isSyncing = ref.read(syncServiceProvider).isSyncing;
  if (isSyncing) {
    // ... existing toast (keep as-is)
    return;
  }
```

The `syncCoordinatorProvider` is already imported in this file (used by onTap at line 266).
  </action>
  <verify>
1. Run `flutter analyze` -- no new errors or warnings.
2. Grep to confirm coordinator calls: `grep -n "coordinator.markInitialSyncComplete" lib/presentation/screens/auth/login_screen.dart lib/presentation/screens/home/home_screen.dart` -- should show matches in both files.
3. Grep to confirm onLongPress guard: `grep -n "coordinator.isLocked" lib/presentation/widgets/shell/responsive_shell.dart` -- should show matches in BOTH onTap AND onLongPress sections.
4. Grep to confirm no remaining direct `appSettings.markInitialSyncCompleted()` calls in login_screen.dart or home_screen.dart: `grep -n "appSettings.markInitialSyncCompleted" lib/presentation/screens/auth/login_screen.dart lib/presentation/screens/home/home_screen.dart` -- should show ZERO matches.
  </verify>
  <done>
1. LoginScreen and HomeScreen route initial sync completion through coordinator (setting in-memory flag + persisted flag).
2. ResponsiveShell onLongPress checks coordinator.isLocked before showing re-sync dialog.
3. No direct appSettings.markInitialSyncCompleted() calls remain in UI screens.
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. `flutter analyze` passes with no new errors
2. `flutter test test/data/repositories/customer_repository_impl_test.dart` passes (smoke test)
3. No direct `appSettings.markInitialSyncCompleted()` in login_screen.dart or home_screen.dart
4. WidgetsFlutterBinding.ensureInitialized() is inside appRunner callback in main.dart
5. coordinator.isLocked appears in both onTap and onLongPress handlers in responsive_shell.dart
</verification>

<success_criteria>
- Zone mismatch eliminated: WidgetsFlutterBinding runs in same zone as runApp
- Coordinator flag set on initial sync success: Phase 2 (delta sync) and Phase 3 (triggerSync) no longer rejected
- Re-sync guard works: long press blocked when coordinator lock held
- All three UAT gaps (tests 1, 2, 6) root causes addressed
</success_criteria>

<output>
After completion, create `.planning/phases/06-sync-coordination/06-04-SUMMARY.md`
</output>
