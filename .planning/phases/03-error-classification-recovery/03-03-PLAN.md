---
phase: 03-error-classification-recovery
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - lib/presentation/widgets/common/offline_banner.dart
  - lib/presentation/screens/home/tabs/customers_tab.dart
  - lib/presentation/screens/customer/customer_detail_screen.dart
  - lib/presentation/screens/home/tabs/activities_tab.dart
  - lib/presentation/screens/activity/activity_detail_screen.dart
  - lib/presentation/screens/pipeline/pipeline_detail_screen.dart
autonomous: true

must_haves:
  truths:
    - "Customer list screen shows cached data with 'Offline - data may be stale' banner when device is offline"
    - "Customer detail screen shows cached data with offline banner instead of error text when offline"
    - "Pipeline detail screen shows cached data with offline banner instead of raw error text"
    - "Activity list and detail screens show cached data with offline banner instead of raw error text"
    - "All error: callbacks in AsyncValue.when() use AppErrorState widget instead of raw Text('Error: $error')"
  artifacts:
    - path: "lib/presentation/widgets/common/offline_banner.dart"
      provides: "Reusable offline connectivity banner widget"
      contains: "OfflineBanner"
    - path: "lib/presentation/screens/home/tabs/customers_tab.dart"
      provides: "Customer list with offline banner"
      contains: "OfflineBanner"
    - path: "lib/presentation/screens/customer/customer_detail_screen.dart"
      provides: "Customer detail with offline banner and AppErrorState"
      contains: "OfflineBanner"
  key_links:
    - from: "lib/presentation/widgets/common/offline_banner.dart"
      to: "lib/presentation/providers/sync_providers.dart"
      via: "Watches connectivityStreamProvider"
      pattern: "connectivityStreamProvider"
    - from: "lib/presentation/screens/home/tabs/customers_tab.dart"
      to: "lib/presentation/widgets/common/offline_banner.dart"
      via: "Wraps list with offline banner"
      pattern: "OfflineBanner"
    - from: "lib/presentation/screens/customer/customer_detail_screen.dart"
      to: "lib/presentation/widgets/common/error_state.dart"
      via: "Error callbacks use AppErrorState instead of raw text"
      pattern: "AppErrorState"
---

<objective>
Add offline-aware UI to customer, pipeline, and activity screens: a reusable offline banner widget that shows staleness warning when device is offline, and replace raw `Text('Error: $error')` patterns with proper `AppErrorState` widgets in the 3 core entity screens.

Purpose: Satisfies ERR-03 (screens show cached data with staleness warning when offline instead of raw error strings) and improves user experience during offline usage.
Output: OfflineBanner widget, 6 updated screens with offline awareness and proper error display.
</objective>

<execution_context>
@C:/Users/cartr/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/cartr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-error-classification-recovery/03-RESEARCH.md
@.planning/phases/03-error-classification-recovery/03-01-SUMMARY.md

@lib/presentation/widgets/common/error_state.dart
@lib/presentation/providers/sync_providers.dart
@lib/presentation/screens/home/tabs/customers_tab.dart
@lib/presentation/screens/customer/customer_detail_screen.dart
@lib/presentation/screens/home/tabs/activities_tab.dart
@lib/presentation/screens/activity/activity_detail_screen.dart
@lib/presentation/screens/pipeline/pipeline_detail_screen.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create OfflineBanner widget and update customer screens</name>
  <files>
    lib/presentation/widgets/common/offline_banner.dart
    lib/presentation/screens/home/tabs/customers_tab.dart
    lib/presentation/screens/customer/customer_detail_screen.dart
  </files>
  <action>
**Create OfflineBanner widget (`lib/presentation/widgets/common/offline_banner.dart`):**
- A `ConsumerWidget` that watches `connectivityStreamProvider` from sync_providers.dart
- When `isConnected` is false, renders a compact Material banner:
  - Background: `Colors.orange.shade100`
  - Leading icon: `Icons.wifi_off` in `Colors.orange.shade800`, size 16
  - Text: 'Offline - data may be stale' in `Colors.orange.shade800`, fontSize 13
  - Full width, horizontal padding 16, vertical padding 8
- When `isConnected` is true (or null/loading -- default to connected), renders `SizedBox.shrink()`
- Use `connectivityAsync.valueOrNull ?? true` pattern (same as responsive_shell.dart) so loading/null defaults to "connected" to avoid false offline flash on startup
- This widget is designed to be placed at the top of a Column/ListView, NOT wrapping children. It just shows/hides itself.

**Update customers_tab.dart:**
- Add import for `offline_banner.dart`
- Add import for `error_state.dart` (AppErrorState) if not already imported
- In the build method's list area, add `const OfflineBanner()` above the customer list content
- Replace the `Text('Error: $error')` at line ~122 with `AppErrorState.general(message: error.toString(), onRetry: ...)` using whatever retry/refresh callback exists in the screen
- Ensure the OfflineBanner is inside the Scaffold body but above the list content, typically as the first child in a Column wrapping the existing content

**Update customer_detail_screen.dart:**
- Add imports for `offline_banner.dart` and `error_state.dart`
- Add `const OfflineBanner()` at the top of the detail body content (inside Scaffold body, above existing content)
- Replace all 4 `Text('Error: $error')` patterns (lines ~71, ~354, ~625, ~751) with `AppErrorState.general(message: error.toString(), onRetry: ...)`:
  - Line ~71: main customer load error -> `AppErrorState.general(message: 'Failed to load customer details')`
  - Lines ~354, ~625, ~751: sub-section errors -> `AppErrorState.general(message: 'Failed to load data')` with compact size if possible
- For the main error at line ~71 (the Scaffold body level error), this replaces the entire body. Keep it as a full-screen error state.
- For sub-section errors (pipelines, activities, key persons), use compact inline error display since they're inside tabs/sections.

**Key insight from CLAUDE.md:** These screens use Drift-backed StreamProviders. The `error:` callback from `AsyncValue.when()` on a Drift stream only fires on database errors (which are rare), NOT on network errors. Network offline state is handled by the OfflineBanner watching connectivity, while Drift streams continue working normally offline. The AppErrorState replacements are for the rare case when Drift itself errors.
  </action>
  <verify>
Run `flutter analyze lib/presentation/widgets/common/offline_banner.dart lib/presentation/screens/home/tabs/customers_tab.dart lib/presentation/screens/customer/customer_detail_screen.dart` -- no errors.
Grep for `Text('Error: $error')` in customers_tab.dart -- should return 0 matches.
Grep for `Text('Error: $error')` in customer_detail_screen.dart -- should return 0 matches.
Grep for `OfflineBanner` in customers_tab.dart -- should return at least 1 match.
Grep for `OfflineBanner` in customer_detail_screen.dart -- should return at least 1 match.
  </verify>
  <done>
OfflineBanner widget created as reusable ConsumerWidget watching connectivityStreamProvider.
customers_tab.dart shows offline banner and uses AppErrorState instead of raw error text.
customer_detail_screen.dart shows offline banner and all 4 error text sites replaced with AppErrorState.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update pipeline and activity screens with offline banner and error display</name>
  <files>
    lib/presentation/screens/pipeline/pipeline_detail_screen.dart
    lib/presentation/screens/home/tabs/activities_tab.dart
    lib/presentation/screens/activity/activity_detail_screen.dart
  </files>
  <action>
Apply the same pattern from Task 1 to the remaining core entity screens.

**Update pipeline_detail_screen.dart:**
- Add imports for `offline_banner.dart` and `error_state.dart`
- Add `const OfflineBanner()` at top of detail body content
- Replace `Text('Error: $error')` at line ~43 with `AppErrorState.general(message: 'Failed to load pipeline details')` -- this is the main body-level error
- Any other `error:` callbacks showing raw error text should also be updated to use AppErrorState

**Update activities_tab.dart:**
- Add imports for `offline_banner.dart` and `error_state.dart`
- Add `const OfflineBanner()` above the activity list content
- Replace `Text('Error: $e')` at line ~162 with `AppErrorState.general(message: 'Failed to load activities', onRetry: ...)` using whatever refresh mechanism exists

**Update activity_detail_screen.dart:**
- Add imports for `offline_banner.dart` and `error_state.dart`
- Add `const OfflineBanner()` at top of detail body content
- Replace `Text('Error: $error')` at line ~460 with `AppErrorState.general(message: 'Failed to load activity details')` or similar

**Consistency rules for all screens:**
- Use `AppErrorState.general(message: '...')` for generic errors (most cases)
- Use `AppErrorState.network(onRetry: ...)` for errors that are clearly network-related (rare since Drift reads locally)
- Use `AppErrorState.notFound()` if the error is about a missing entity
- Add `onRetry` callback when there's a natural retry action (RefreshIndicator callback, re-navigation, etc.)
- Keep error messages user-friendly in Indonesian where the screen already uses Indonesian, or English where the screen uses English. Match existing screen language conventions.

**Final verification across all 6 screens:**
Run flutter analyze on all modified screen files to ensure no import or type errors.
  </action>
  <verify>
Run `flutter analyze lib/presentation/screens/pipeline/pipeline_detail_screen.dart lib/presentation/screens/home/tabs/activities_tab.dart lib/presentation/screens/activity/activity_detail_screen.dart` -- no errors.
Grep for `Text('Error: $error')` or `Text('Error: $e')` in all 3 files -- should return 0 matches.
Grep for `OfflineBanner` in all 3 files -- should return at least 1 match each.
Grep for `AppErrorState` in all 3 files -- should return at least 1 match each.
  </verify>
  <done>
pipeline_detail_screen.dart shows offline banner and uses AppErrorState for errors.
activities_tab.dart shows offline banner and uses AppErrorState for errors.
activity_detail_screen.dart shows offline banner and uses AppErrorState for errors.
All 6 core entity screens (customer list/detail, pipeline detail, activity list/detail) have offline awareness and proper error display.
No raw Text('Error: $error') patterns remain in any of the 6 screens.
  </done>
</task>

</tasks>

<verification>
1. `flutter analyze` passes for all 7 modified/created files with no errors
2. No `Text('Error: $error')` or `Text('Error: $e')` in any of the 6 screen files
3. All 6 screens have `OfflineBanner` import and usage
4. All 6 screens use `AppErrorState` instead of raw error text
5. `OfflineBanner` correctly watches `connectivityStreamProvider` and defaults to connected (no false offline flash on startup)
6. OfflineBanner shows compact orange banner when offline, nothing when online
</verification>

<success_criteria>
- Reusable OfflineBanner widget exists and works with existing connectivityStreamProvider
- Customer list, customer detail, pipeline detail, activity list, and activity detail screens all show offline staleness banner
- All error: callbacks in the 6 screens use AppErrorState instead of raw Text('Error:')
- ERR-03 requirement satisfied: screens show cached data with staleness warning when offline
- No visual regressions -- offline banner is additive, existing layouts preserved
</success_criteria>

<output>
After completion, create `.planning/phases/03-error-classification-recovery/03-03-SUMMARY.md`
</output>
