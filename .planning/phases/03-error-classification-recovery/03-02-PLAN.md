---
phase: 03-error-classification-recovery
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - lib/domain/repositories/pipeline_repository.dart
  - lib/data/repositories/pipeline_repository_impl.dart
  - lib/presentation/providers/pipeline_providers.dart
  - test/data/repositories/pipeline_repository_impl_test.dart
  - test/data/repositories/pipeline_repository_impl_test.mocks.dart
  - lib/domain/repositories/activity_repository.dart
  - lib/data/repositories/activity_repository_impl.dart
  - lib/presentation/providers/activity_providers.dart
autonomous: true

must_haves:
  truths:
    - "PipelineRepository interface uses Result<T> instead of Either<Failure, T> for all 5 mutating methods"
    - "PipelineRepositoryImpl catch blocks use mapException() instead of generic DatabaseFailure"
    - "Pipeline provider notifiers use switch/when pattern matching instead of .fold()"
    - "Pipeline repository tests pass with updated Result assertions"
    - "ActivityRepository interface uses Result<T> instead of Either<Failure, T> for all 8 mutating methods"
    - "ActivityRepositoryImpl catch blocks use mapException() instead of generic DatabaseFailure"
    - "Activity provider notifiers use switch/when pattern matching instead of .fold()"
  artifacts:
    - path: "lib/domain/repositories/pipeline_repository.dart"
      provides: "PipelineRepository interface with Result<T> return types"
      contains: "Result<Pipeline>"
    - path: "lib/domain/repositories/activity_repository.dart"
      provides: "ActivityRepository interface with Result<T> return types"
      contains: "Result<Activity>"
    - path: "lib/presentation/providers/pipeline_providers.dart"
      provides: "Pipeline notifiers using Result pattern matching"
      contains: "case Success"
    - path: "lib/presentation/providers/activity_providers.dart"
      provides: "Activity notifiers using Result pattern matching"
      contains: "case Success"
  key_links:
    - from: "lib/data/repositories/pipeline_repository_impl.dart"
      to: "lib/core/errors/exception_mapper.dart"
      via: "Repository catch blocks use mapException/runCatching"
      pattern: "runCatching|mapException"
    - from: "lib/data/repositories/activity_repository_impl.dart"
      to: "lib/core/errors/exception_mapper.dart"
      via: "Repository catch blocks use mapException/runCatching"
      pattern: "runCatching|mapException"
    - from: "lib/presentation/providers/pipeline_providers.dart"
      to: "lib/core/errors/result.dart"
      via: "Notifiers pattern-match on Result"
      pattern: "case Success|case Failure_"
    - from: "lib/presentation/providers/activity_providers.dart"
      to: "lib/core/errors/result.dart"
      via: "Notifiers pattern-match on Result"
      pattern: "case Success|case Failure_"
---

<objective>
Migrate PipelineRepository and ActivityRepository from dartz Either to sealed Result type, following the same pattern established in Plan 01 for CustomerRepository.

Purpose: Completes the ERR-02 requirement (3 core repositories migrated) and ensures all main data flows use typed error propagation.
Output: Fully migrated Pipeline and Activity repositories with typed errors, passing tests for pipeline.
</objective>

<execution_context>
@C:/Users/cartr/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/cartr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-error-classification-recovery/03-RESEARCH.md
@.planning/phases/03-error-classification-recovery/03-01-SUMMARY.md

@lib/core/errors/result.dart
@lib/core/errors/exception_mapper.dart
@lib/domain/repositories/pipeline_repository.dart
@lib/data/repositories/pipeline_repository_impl.dart
@lib/presentation/providers/pipeline_providers.dart
@test/data/repositories/pipeline_repository_impl_test.dart
@lib/domain/repositories/activity_repository.dart
@lib/data/repositories/activity_repository_impl.dart
@lib/presentation/providers/activity_providers.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate PipelineRepository to Result type end-to-end</name>
  <files>
    lib/domain/repositories/pipeline_repository.dart
    lib/data/repositories/pipeline_repository_impl.dart
    lib/presentation/providers/pipeline_providers.dart
    test/data/repositories/pipeline_repository_impl_test.dart
    test/data/repositories/pipeline_repository_impl_test.mocks.dart
  </files>
  <action>
Follow the exact same migration pattern established in Plan 01 for CustomerRepository.

**Interface (pipeline_repository.dart):**
- Replace `import 'package:dartz/dartz.dart'` with `import '../../core/errors/result.dart'`
- Change all 5 `Either<Failure, T>` return types to `Result<T>`:
  - `createPipeline` -> `Future<Result<Pipeline>>`
  - `updatePipeline` -> `Future<Result<Pipeline>>`
  - `updatePipelineStage` -> `Future<Result<Pipeline>>`
  - `updatePipelineStatus` -> `Future<Result<Pipeline>>`
  - `deletePipeline` -> `Future<Result<void>>`
- Note: PipelineRepository.syncFromRemote returns `Future<void>` (not Either), so it stays unchanged

**Implementation (pipeline_repository_impl.dart):**
- Replace dartz import with result.dart + exception_mapper.dart
- For each of the ~6 catch blocks:
  - Replace `Right(value)` with `Result.success(value)`
  - Replace `Left(DatabaseFailure(message: '...'))` with `Result.failure(mapException(e, context: '...'))`
  - Use `runCatching()` for simple CRUD methods
  - Use explicit try/catch + mapException for complex methods (updatePipelineStage has weighted value calculation)
- Preserve any specific failure types already used (e.g., NotFoundFailure for missing pipeline)

**Providers (pipeline_providers.dart):**
- Replace dartz import with result.dart
- Replace all 5 .fold() call sites with switch or .when() pattern matching
- Follow the same conventions used in the migrated customer_providers.dart from Plan 01

**Tests (pipeline_repository_impl_test.dart):**
- Replace dartz import with result.dart
- Update all assertions: `isA<Right<...>>()` -> `isA<Success<...>>()`, etc.
- Regenerate mocks if needed: `dart run build_runner build --delete-conflicting-outputs`
- Run tests: `flutter test test/data/repositories/pipeline_repository_impl_test.dart`
  </action>
  <verify>
Run `flutter analyze lib/domain/repositories/pipeline_repository.dart lib/data/repositories/pipeline_repository_impl.dart lib/presentation/providers/pipeline_providers.dart` -- no errors.
Run `flutter test test/data/repositories/pipeline_repository_impl_test.dart` -- all tests pass.
Grep for `dartz` in all 3 modified lib files -- should return 0 matches.
Grep for `Either<Failure` in pipeline_repository.dart -- should return 0 matches.
Grep for `\.fold\(` in pipeline_providers.dart -- should return 0 matches.
  </verify>
  <done>
PipelineRepository interface has 5 methods returning Result<T> instead of Either<Failure, T>.
PipelineRepositoryImpl uses mapException()/runCatching() for typed error classification.
Pipeline providers use switch/when pattern matching instead of .fold().
All pipeline repository tests pass with updated Result assertions.
No dartz imports remain in any pipeline-related file.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate ActivityRepository to Result type end-to-end</name>
  <files>
    lib/domain/repositories/activity_repository.dart
    lib/data/repositories/activity_repository_impl.dart
    lib/presentation/providers/activity_providers.dart
  </files>
  <action>
Follow the exact same migration pattern established in Plan 01 for CustomerRepository.

**Interface (activity_repository.dart):**
- Replace `import 'package:dartz/dartz.dart'` with `import '../../core/errors/result.dart'`
- Change all 8 `Either<Failure, T>` return types to `Result<T>`:
  - `createActivity` -> `Future<Result<Activity>>`
  - `createImmediateActivity` -> `Future<Result<Activity>>`
  - `executeActivity` -> `Future<Result<Activity>>`
  - `rescheduleActivity` -> `Future<Result<Activity>>`
  - `cancelActivity` -> `Future<Result<void>>`
  - `addPhoto` -> `Future<Result<ActivityPhoto>>`
  - `deletePhoto` -> `Future<Result<void>>`
  - `addPhotoFromUrl` -> `Future<Result<ActivityPhoto>>`
- Note: syncFromRemote, syncPendingPhotos, syncPendingAuditLogs, syncPhotosFromRemote all return `Future<void>` (not Either), so they stay unchanged

**Implementation (activity_repository_impl.dart):**
- Replace dartz import with result.dart + exception_mapper.dart
- This is the largest migration: ~16 catch blocks need updating
- For each catch block:
  - Replace `Right(value)` with `Result.success(value)`
  - Replace `Left(DatabaseFailure(message: '...'))` with `Result.failure(mapException(e, context: '...'))`
  - Use `runCatching()` for simple methods (addPhoto, deletePhoto, addPhotoFromUrl)
  - Use explicit try/catch + mapException for complex methods (createActivity, createImmediateActivity, executeActivity, rescheduleActivity -- these have GPS logic, status transitions, audit logs)
- Preserve any specific failure types (NotFoundFailure, ValidationFailure for status checks, LocationFailure for GPS)
- For methods with multiple specific failure returns (e.g., "activity not found" vs "activity already completed"), construct the specific Result.failure() inline, and only use mapException for the outer catch-all

**Providers (activity_providers.dart):**
- Replace dartz import with result.dart
- Replace all 6 .fold() call sites with switch or .when() pattern matching
- Follow the same conventions used in the migrated customer_providers.dart from Plan 01

**No test file exists for ActivityRepository** -- skip test migration. A test file could be created in a future phase.

**After both tasks: Run full analyze to catch any cross-file issues:**
`flutter analyze lib/domain/repositories/ lib/data/repositories/ lib/presentation/providers/`
  </action>
  <verify>
Run `flutter analyze lib/domain/repositories/activity_repository.dart lib/data/repositories/activity_repository_impl.dart lib/presentation/providers/activity_providers.dart` -- no errors.
Grep for `dartz` in all 3 modified lib files -- should return 0 matches.
Grep for `Either<Failure` in activity_repository.dart -- should return 0 matches.
Grep for `\.fold\(` in activity_providers.dart -- should return 0 matches.
Run `flutter analyze` on all modified files from both tasks to confirm no cross-file issues.
  </verify>
  <done>
ActivityRepository interface has 8 methods returning Result<T> instead of Either<Failure, T>.
ActivityRepositoryImpl uses mapException()/runCatching() for typed error classification.
Activity providers use switch/when pattern matching instead of .fold().
No dartz imports remain in any activity-related file.
All 3 core repositories (Customer, Pipeline, Activity) are fully migrated to sealed Result type.
  </done>
</task>

</tasks>

<verification>
1. `flutter analyze` passes for all 8 modified files with no errors
2. `flutter test test/data/repositories/pipeline_repository_impl_test.dart` passes all tests
3. No `Either<Failure` references exist in pipeline_repository.dart or activity_repository.dart
4. No `.fold()` references exist in pipeline_providers.dart or activity_providers.dart
5. No `dartz` imports in any of the 8 modified lib files
6. All 3 core repositories (Customer, Pipeline, Activity) use mapException()/runCatching() for error classification
7. Combined grep: `grep -r "Either<Failure" lib/domain/repositories/customer_repository.dart lib/domain/repositories/pipeline_repository.dart lib/domain/repositories/activity_repository.dart` returns 0 matches
</verification>

<success_criteria>
- PipelineRepository and ActivityRepository fully migrated from dartz Either to sealed Result
- All provider notifiers for Pipeline and Activity use pattern matching
- Pipeline tests pass with Result-based assertions
- ERR-02 requirement satisfied: 3 core repositories return Result<T>
- Foundation complete for Plan 03 (screen-level error display improvements)
</success_criteria>

<output>
After completion, create `.planning/phases/03-error-classification-recovery/03-02-SUMMARY.md`
</output>
